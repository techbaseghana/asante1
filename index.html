<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASANTEMAN FETTEH KUO - Cloud Attendance</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 95vh;
        }
        header {
            background: linear-gradient(90deg, #1a2a6c, #b21f1f);
            color: white;
            padding: 15px 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        .logo-container {
            width: 70px;
            height: 70px;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .logo-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .header-text {
            flex: 1;
            margin: 0 15px;
        }
        .main-header {
            font-size: 2.5rem;
            margin-bottom: 5px;
            font-weight: 700;
        }
        .sub-header {
            font-size: 1.2rem;
            opacity: 0.9;
            font-weight: 600;
        }
        .mode-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-left: 10px;
            background: #28a745;
            color: white;
        }
        .mode-indicator.local {
            background: #6c757d;
        }
        .mode-indicator.cloud {
            background: #28a745;
        }
        .app-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .sidebar {
            width: 250px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .dropdown-nav {
            display: flex;
            flex-direction: column;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }
        .dropdown-item {
            position: relative;
        }
        .dropdown-btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            background: transparent;
            text-align: left;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .dropdown-btn i {
            width: 20px;
            text-align: center;
            margin-right: 10px;
        }
        .dropdown-btn.active {
            background: #1a2a6c;
            color: white;
        }
        .dropdown-btn::after {
            content: '\f078';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 0.8rem;
            transition: transform 0.3s;
        }
        .dropdown-btn.active::after {
            transform: rotate(180deg);
        }
        .dropdown-content {
            display: none;
            background: #f1f3f5;
            overflow: hidden;
        }
        .dropdown-item.active .dropdown-content {
            display: block;
        }
        .sub-tab {
            padding: 10px 20px 10px 40px;
            border: none;
            background: transparent;
            text-align: left;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            color: #666;
            width: 100%;
            display: flex;
            align-items: center;
        }
        .sub-tab:hover {
            background: #e9ecef;
        }
        .sub-tab.active {
            background: #e2e6ea;
            color: #1a2a6c;
            font-weight: 600;
            border-left: 3px solid #1a2a6c;
        }
        .sub-tab i {
            width: 16px;
            text-align: center;
            font-size: 0.9rem;
            margin-right: 8px;
        }
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .content-section {
            display: none;
            flex: 1;
        }
        .content-section.active {
            display: flex;
            flex-direction: column;
        }
        .section-header {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1a2a6c;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        .verification-container, .form-container, .sheet-config {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .search-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .search-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1.1rem;
            transition: all 0.3s;
        }
        .search-input:focus {
            outline: none;
            border-color: #1a2a6c;
            box-shadow: 0 0 0 3px rgba(26, 42, 108, 0.1);
        }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        .btn-primary {
            background: #1a2a6c;
            color: white;
        }
        .btn-primary:hover {
            background: #0d1a4a;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #218838;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background: #e0a800;
        }
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        .btn-info:hover {
            background: #138496;
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.9rem;
        }
        .profile-display {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 20px 0;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .profile-display:hover {
            background: #e9ecef;
        }
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #1a2a6c;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 2.5rem;
            margin-bottom: 15px;
            overflow: hidden;
        }
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .profile-name {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .profile-details {
            color: #6c757d;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        .profile-id {
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 1rem;
        }
        .verification-status {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: 700;
            font-size: 1.1rem;
        }
        .verified {
            background: #d4edda;
            color: #155724;
        }
        .not-verified {
            background: #f8d7da;
            color: #721c24;
        }
        .no-profile {
            color: #6c757d;
            font-style: italic;
            font-size: 1.1rem;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
            flex-wrap: wrap;
        }
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1a2a6c;
            margin: 10px 0;
        }
        .stat-label {
            color: #6c757d;
            font-size: 1rem;
            font-weight: 600;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 700;
            font-size: 1.1rem;
        }
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 1.1rem;
        }
        .dropdown-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 1.1rem;
            background: white;
            cursor: pointer;
        }
        .capture-preview {
            width: 150px;
            height: 150px;
            border: 2px dashed #ccc;
            border-radius: 5px;
            margin: 10px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .capture-preview img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 5px;
        }
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 300px;
            margin: 10px auto;
            border-radius: 10px;
            overflow: hidden;
            display: none;
        }
        #camera-video {
            width: 100%;
            height: auto;
            display: block;
            background: #000;
        }
        .camera-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }
        .attendance-list {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 10px;
        }
        .attendance-item {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        .attendance-item:hover {
            background: #f8f9fa;
        }
        .attendance-item:last-child {
            border-bottom: none;
        }
        .attendance-item.present {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #1a2a6c;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            overflow: hidden;
        }
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .attendance-time {
            color: #6c757d;
            font-size: 1rem;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .status-present {
            background: #28a745;
        }
        .status-absent {
            background: #dc3545;
        }
        .user-management {
            margin-top: 20px;
        }
        .user-card {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin-bottom: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        .user-card:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        .user-card-info {
            flex: 1;
            margin-left: 10px;
        }
        .user-card-name {
            font-weight: 700;
            font-size: 1.1rem;
        }
        .user-card-id {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .delete-btn:hover {
            background: #c82333;
        }
        .edit-btn {
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-right: 5px;
        }
        .edit-btn:hover {
            background: #138496;
        }
        .search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        .search-result-item {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .search-result-item:hover {
            background: #f8f9fa;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        .option-management {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .option-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        .option-item:last-child {
            border-bottom: none;
        }
        .password-modal, .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .password-modal-content, .confirm-modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .password-form {
            margin-top: 20px;
        }
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #17a2b8;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 0.9rem;
            display: none;
            z-index: 1000;
        }
        .sync-status.syncing {
            background: #ffc107;
            color: #212529;
        }
        .sync-status.error {
            background: #dc3545;
        }
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid transparent;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }
        .menu-builder {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .menu-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .menu-item-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }
        .menu-item-title {
            font-weight: bold;
            font-size: 1.1rem;
        }
        .submenu-list {
            margin-left: 20px;
            margin-top: 10px;
        }
        .submenu-item {
            background: #e9ecef;
            border-radius: 3px;
            padding: 8px 12px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .calendar-container {
            display: inline-block;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
            display: none;
            position: absolute;
            z-index: 100;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .calendar-day {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }
        .calendar-day:hover {
            background: #e9ecef;
        }
        .calendar-day.selected {
            background: #1a2a6c;
            color: white;
        }
        .calendar-day.other-month {
            color: #ccc;
        }
        .calendar-month-year {
            font-weight: bold;
        }
        .meeting-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .meeting-date {
            font-weight: bold;
            color: #1a2a6c;
        }
        .meeting-status {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        .status-upcoming {
            background: #fff3cd;
            color: #856404;
        }
        .status-completed {
            background: #e2e3e5;
            color: #383d41;
        }
        .birthday-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        .birthday-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #1a2a6c;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 15px;
            overflow: hidden;
        }
        .birthday-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .birthday-days {
            margin-left: auto;
            padding: 5px 10px;
            background: #ffc107;
            border-radius: 10px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .chapter-item, .group-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chapter-info, .group-info {
            flex: 1;
        }
        .chapter-name, .group-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        .chapter-details, .group-details {
            color: #6c757d;
            font-size: 0.9rem;
        }
        /* === NEW: Connection Status Panel Styles === */
        .stat-card {
            position: relative;
        }
        .status-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
            vertical-align: middle;
        }
        .connection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .conn-card {
            padding: 12px;
            border-radius: 8px;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        .conn-label {
            font-size: 0.9rem;
            color: #555;
            font-weight: 600;
        }
        .conn-value {
            font-weight: bold;
            margin-top: 4px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
        }
        @media (max-width: 768px) {
            .app-body {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e9ecef;
                max-height: 200px;
            }
            .main-header {
                font-size: 2rem;
            }
            .search-section {
                flex-direction: column;
            }
            header {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container" id="logo-container">
                <span>Logo</span>
            </div>
            <div class="header-text">
                <h1 class="main-header">ASANTEMAN FETTEH KUO</h1>
                <p class="sub-header">
                    Cloud-Based Attendance Management System
                    <span class="mode-indicator local" id="mode-indicator">Local Mode</span>
                </p>
            </div>
            <div class="header-controls">
                <button class="btn btn-primary" id="sync-btn">
                    <i class="fas fa-sync-alt"></i> Sync
                </button>
            </div>
        </header>
        <div class="app-body">
            <div class="sidebar">
                <div class="dropdown-nav" id="sidebar-nav">
                </div>
            </div>
            <div class="main-content">
                <!-- Attendance Sections -->
                <div class="content-section active" id="attendance-overview">
                    <h2 class="section-header">Attendance Overview</h2>
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-label">Present Today</div>
                            <div class="stat-value" id="present-today-count">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Members</div>
                            <div class="stat-value" id="total-members-count">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Active Meetings</div>
                            <div class="stat-value" id="active-meetings-count">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Upcoming Birthdays</div>
                            <div class="stat-value" id="upcoming-birthdays-count">0</div>
                        </div>
                    </div>
                    <div class="form-container">
                        <h3>Current Active Meeting</h3>
                        <div id="active-meeting-display">
                            <p>No active meeting. Create a new meeting to start attendance.</p>
                        </div>
                        <div class="controls">
                            <button class="btn btn-primary" id="create-meeting-btn">
                                <i class="fas fa-plus"></i> Create New Meeting
                            </button>
                            <button class="btn btn-success" id="view-all-members-btn">
                                <i class="fas fa-users"></i> View All Members
                            </button>
                        </div>
                    </div>
                </div>
                <div class="content-section" id="verify-attendance">
                    <h2 class="section-header">Verify Attendance</h2>
                    <div class="verification-container">
                        <div class="search-section">
                            <input type="text" class="search-input" id="search-input" placeholder="Enter phone number or name...">
                            <button class="btn btn-primary" id="search-btn">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                        <div class="search-results" id="search-results"></div>
                        <div class="profile-display" id="profile-display">
                            <div class="no-profile">No profile selected. Search for a member to verify attendance.</div>
                        </div>
                        <div class="verification-status not-verified" id="verification-status">
                            NOT VERIFIED - Profile needs verification
                        </div>
                        <div class="controls">
                            <button class="btn btn-success" id="verify-btn">
                                <i class="fas fa-check-circle"></i> Verify Attendance
                            </button>
                            <button class="btn btn-danger" id="clear-btn">
                                <i class="fas fa-times"></i> Clear Search
                            </button>
                        </div>
                    </div>
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-label">Verified Today</div>
                            <div class="stat-value" id="verified-count">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Last Verified</div>
                            <div class="stat-value" id="last-verified">-</div>
                        </div>
                    </div>
                </div>
                <div class="content-section" id="view-attendance">
                    <h2 class="section-header">Today's Attendance</h2>
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-label">Present</div>
                            <div class="stat-value" id="present-count">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Members</div>
                            <div class="stat-value" id="total-users">0</div>
                        </div>
                    </div>
                    <div class="filter-section">
                        <select class="dropdown-select" id="job-filter">
                            <option value="all">All Jobs</option>
                        </select>
                    </div>
                    <div class="attendance-list" id="attendance-list"></div>
                </div>
                <div class="content-section" id="attendance-reports">
                    <h2 class="section-header">Attendance Reports</h2>
                    <div class="form-container">
                        <div class="form-group">
                            <label class="form-label">Select Date Range</label>
                            <div class="search-section">
                                <input type="date" class="form-control" id="report-start-date">
                                <input type="date" class="form-control" id="report-end-date">
                            </div>
                        </div>
                        <button class="btn btn-primary" id="generate-report-btn">
                            <i class="fas fa-chart-bar"></i> Generate Report
                        </button>
                        <div id="report-results" style="margin-top: 20px;"></div>
                    </div>
                </div>
                <!-- Meeting Management -->
                <div class="content-section" id="meeting-management">
                    <h2 class="section-header">Meeting Management</h2>
                    <div class="form-container">
                        <div class="form-group">
                            <label class="form-label">Create New Meeting</label>
                            <div class="search-section">
                                <input type="date" class="form-control" id="meeting-date">
                                <input type="text" class="form-control" id="meeting-title" placeholder="Meeting Title">
                                <button class="btn btn-primary" id="create-meeting-btn2">
                                    <i class="fas fa-plus"></i> Create Meeting
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-container">
                        <h3>Active Meetings</h3>
                        <div id="active-meetings-list"></div>
                        <h3>Upcoming Meetings</h3>
                        <div id="upcoming-meetings-list"></div>
                        <h3>Past Meetings</h3>
                        <div id="past-meetings-list"></div>
                    </div>
                </div>
                <!-- Members Sections -->
                <div class="content-section" id="all-members">
                    <h2 class="section-header">All Members</h2>
                    <div class="search-section">
                        <input type="text" class="search-input" id="all-members-search-input" placeholder="Search members by name or ID...">
                        <button class="btn btn-primary" id="all-members-search-btn">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                    <div id="all-members-list"></div>
                </div>
                <div class="content-section" id="add-member">
                    <h2 class="section-header">Add New Member</h2>
                    <div class="form-container">
                        <div class="form-group">
                            <label class="form-label" for="member-name">Full Name</label>
                            <input type="text" class="form-control" id="member-name" placeholder="Enter full name">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="member-id">ID Number</label>
                            <input type="text" class="form-control" id="member-id" placeholder="Enter ID number">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="member-phone">Phone Number</label>
                            <input type="tel" class="form-control" id="member-phone" placeholder="Enter phone number">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="member-dob">Date of Birth</label>
                            <input type="text" class="form-control" id="member-dob" placeholder="Click to select date" readonly>
                            <div class="calendar-container" id="birthday-calendar">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Job Title</label>
                            <select class="dropdown-select" id="job-select">
                                <option value="">Select Job</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hometown</label>
                            <select class="dropdown-select" id="hometown-select">
                                <option value="">Select Hometown</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tribe</label>
                            <select class="dropdown-select" id="tribe-select">
                                <option value="">Select Tribe</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Chapter</label>
                            <select class="dropdown-select" id="chapter-select">
                                <option value="">Select Chapter</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Group</label>
                            <select class="dropdown-select" id="group-select">
                                <option value="">Select Group</option>
                            </select>
                        </div>
                        <div class="capture-preview" id="capture-preview">
                            <span>No profile picture</span>
                        </div>
                        <div class="camera-container" id="camera-container">
                            <video id="camera-video" autoplay muted playsinline></video>
                            <div class="camera-controls">
                                <button class="btn btn-success btn-sm" id="capture-photo-btn">Capture Photo</button>
                                <button class="btn btn-danger btn-sm" id="cancel-camera-btn">Cancel</button>
                            </div>
                        </div>
                        <div class="controls">
                            <button class="btn btn-primary" id="camera-btn">
                                <i class="fas fa-camera"></i> Take Photo with Camera
                            </button>
                            <button class="btn btn-warning" id="remove-photo-btn">
                                <i class="fas fa-trash"></i> Remove Photo
                            </button>
                            <button class="btn btn-success" id="save-btn">
                                <i class="fas fa-save"></i> Save Member
                            </button>
                        </div>
                    </div>
                </div>
                <div class="content-section" id="manage-members">
                    <h2 class="section-header">Manage Members</h2>
                    <div class="search-section">
                        <input type="text" class="search-input" id="manage-search-input" placeholder="Search members by name or ID...">
                        <button class="btn btn-primary" id="manage-search-btn">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                    <div id="user-management-list"></div>
                </div>
                <div class="content-section" id="member-groups">
                    <h2 class="section-header">Member Groups</h2>
                    <div class="form-container">
                        <div class="form-group">
                            <label class="form-label">Create New Group</label>
                            <div class="search-section">
                                <input type="text" class="form-control" id="new-group-name" placeholder="Enter group name">
                                <input type="text" class="form-control" id="new-group-description" placeholder="Enter group description">
                                <button class="btn btn-primary" id="create-group-btn">
                                    <i class="fas fa-plus"></i> Create Group
                                </button>
                            </div>
                        </div>
                        <div id="groups-list"></div>
                    </div>
                </div>
                <div class="content-section" id="birthday-reminder">
                    <h2 class="section-header">Birthday Reminder</h2>
                    <div class="form-container">
                        <div class="stats-container">
                            <div class="stat-card">
                                <div class="stat-label">This Week</div>
                                <div class="stat-value" id="birthdays-this-week">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">This Month</div>
                                <div class="stat-value" id="birthdays-this-month">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Next Month</div>
                                <div class="stat-value" id="birthdays-next-month">0</div>
                            </div>
                        </div>
                        <h3>Upcoming Birthdays (Next 7 Days)</h3>
                        <div id="upcoming-birthdays-list"></div>
                        <h3>All Birthdays This Month</h3>
                        <div id="month-birthdays-list"></div>
                    </div>
                </div>
                <!-- Settings Sections -->
                <div class="content-section" id="system-settings">
                    <h2 class="section-header">System Settings</h2>
                    <div class="sheet-config">
                        <div class="form-group">
                            <label class="form-label" for="sheet-id">Google Sheet ID</label>
                            <input type="text" class="form-control" id="sheet-id" placeholder="Enter your Google Sheet ID">
                            <small>Find this in your Google Sheet URL: https://docs.google.com/spreadsheets/d/<strong>YOUR_SHEET_ID</strong>/edit</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="script-url">Google Apps Script URL</label>
                            <input type="text" class="form-control" id="script-url" placeholder="Enter your Google Apps Script URL">
                            <small>This is the URL of your deployed Google Apps Script web app</small>
                        </div>
                        <div class="controls">
                            <button class="btn btn-primary" id="test-connection-btn">
                                <i class="fas fa-plug"></i> Test Connection
                            </button>
                            <button class="btn btn-success" id="save-settings-btn">
                                <i class="fas fa-save"></i> Save Settings
                            </button>
                            <button class="btn btn-info" id="load-data-btn">
                                <i class="fas fa-download"></i> Load Data from Sheet
                            </button>
                            <button class="btn btn-warning" id="clear-settings-btn">
                                <i class="fas fa-trash"></i> Clear Settings
                            </button>
                            <button class="btn btn-primary" id="compare-sheet-btn">
                                <i class="fas fa-exchange-alt"></i> Compare & Sync Structure
                            </button>
                            <button class="btn btn-info" id="manual-test-btn">
                                <i class="fas fa-bug"></i> Manual Test
                            </button>
                        </div>
                        <!-- ‚úÖ NEW: Connection Status Panel -->
                        <div class="form-group" style="margin-top: 25px;">
                            <h4 style="margin-bottom: 12px;">Connection Status</h4>
                            <div class="connection-grid">
                                <div class="conn-card">
                                    <div class="conn-label">üåê Internet</div>
                                    <div class="conn-value">
                                        <span class="status-dot" id="internet-dot" style="background: #ccc;"></span>
                                        <span id="internet-status">Checking‚Ä¶</span>
                                    </div>
                                </div>
                                <div class="conn-card">
                                    <div class="conn-label">‚öôÔ∏è Backend</div>
                                    <div class="conn-value">
                                        <span class="status-dot" id="backend-dot" style="background: #ccc;"></span>
                                        <span id="backend-status">Not tested</span>
                                    </div>
                                </div>
                                <div class="conn-card">
                                    <div class="conn-label">üìä Sheet</div>
                                    <div class="conn-value">
                                        <span class="status-dot" id="sheet-dot" style="background: #ccc;"></span>
                                        <span id="sheet-status">Not tested</span>
                                    </div>
                                </div>
                            </div>
                            <small style="display: block; margin-top: 8px; color: #666;">
                                Internet updates automatically. Click <strong>Test Connection</strong> to verify backend & sheet.
                            </small>
                        </div>
                    </div>
                    <div class="form-group">
                        <h4>Database Status</h4>
                        <div id="database-status">
                            <p>No data loaded yet. Configure your Google Sheet and click "Load Data from Sheet".</p>
                        </div>
                    </div>
                </div>
                <div class="content-section" id="user-management">
                    <h2 class="section-header">User Management</h2>
                    <div class="form-container">
                        <div class="form-group">
                            <label class="form-label">Add New User</label>
                            <div class="search-section">
                                <input type="text" class="form-control" id="new-username" placeholder="Username">
                                <input type="password" class="form-control" id="new-password" placeholder="Password">
                                <select class="form-control" id="new-user-role">
                                    <option value="user">User</option>
                                    <option value="admin">Admin</option>
                                </select>
                                <button class="btn btn-primary" id="add-user-btn">
                                    <i class="fas fa-user-plus"></i> Add User
                                </button>
                            </div>
                        </div>
                        <div id="users-list"></div>
                    </div>
                </div>
                <div class="content-section" id="chapter-management">
                    <h2 class="section-header">Chapter Management</h2>
                    <div class="form-container">
                        <div class="form-group">
                            <label class="form-label">Add New Chapter</label>
                            <div class="search-section">
                                <input type="text" class="form-control" id="new-chapter-name" placeholder="Chapter Name">
                                <input type="text" class="form-control" id="new-chapter-location" placeholder="Chapter Location">
                                <input type="text" class="form-control" id="new-chapter-leader" placeholder="Chapter Leader">
                                <button class="btn btn-primary" id="add-chapter-btn">
                                    <i class="fas fa-plus"></i> Add Chapter
                                </button>
                            </div>
                        </div>
                        <div id="chapters-list"></div>
                    </div>
                </div>
                <div class="content-section" id="page-upgrade">
                    <h2 class="section-header">Page Upgrade</h2>
                    <div class="menu-builder">
                        <h3>Menu Builder</h3>
                        <div class="form-group">
                            <label class="form-label">Add New Main Menu</label>
                            <div class="search-section">
                                <input type="text" class="form-control" id="new-menu-name" placeholder="Menu Name">
                                <input type="text" class="form-control" id="new-menu-icon" placeholder="Icon (e.g., fas fa-home)">
                                <button class="btn btn-primary" id="add-menu-btn">
                                    <i class="fas fa-plus"></i> Add Menu
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Add Submenu to Selected Menu</label>
                            <div class="search-section">
                                <select class="form-control" id="parent-menu-select">
                                    <option value="">Select Parent Menu</option>
                                </select>
                                <input type="text" class="form-control" id="new-submenu-name" placeholder="Submenu Name">
                                <input type="text" class="form-control" id="new-submenu-icon" placeholder="Icon (e.g., fas fa-list)">
                                <input type="text" class="form-control" id="new-submenu-section" placeholder="Section ID">
                                <button class="btn btn-primary" id="add-submenu-btn">
                                    <i class="fas fa-plus"></i> Add Submenu
                                </button>
                            </div>
                        </div>
                        <div id="menu-structure">
                            <h4>Current Menu Structure</h4>
                            <div id="menu-list"></div>
                        </div>
                    </div>
                    <div class="option-management">
                        <h3>Manage Dropdown Options</h3>
                        <div class="form-group">
                            <label class="form-label">Select Option Category</label>
                            <select class="dropdown-select" id="option-category">
                                <option value="jobs">Job Titles</option>
                                <option value="hometowns">Hometowns</option>
                                <option value="tribes">Tribes</option>
                                <option value="departments">Departments</option>
                                <option value="positions">Positions</option>
                                <option value="chapters">Chapters</option>
                                <option value="groups">Groups</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Add New Option</label>
                            <div class="search-section">
                                <input type="text" class="search-input" id="new-option-input" placeholder="Enter new option...">
                                <button class="btn btn-primary" id="add-option-btn">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Current Options</label>
                            <div id="options-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Password Modal -->
    <div class="password-modal" id="password-modal">
        <div class="password-modal-content">
            <h2>Enter Password</h2>
            <p>Please enter the password to access the Settings tab.</p>
            <div class="password-form">
                <div class="form-group">
                    <input type="password" class="form-control" id="password-input" placeholder="Enter password">
                </div>
                <div class="controls">
                    <button class="btn btn-success" id="submit-password-btn">Submit</button>
                    <button class="btn btn-danger" id="cancel-password-btn">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Confirmation Modal -->
    <div class="confirm-modal" id="confirm-modal">
        <div class="confirm-modal-content">
            <h2>Confirm Deletion</h2>
            <p id="confirm-message">Are you sure you want to delete this member?</p>
            <div class="controls">
                <button class="btn btn-success" id="confirm-yes-btn">Yes</button>
                <button class="btn btn-danger" id="confirm-no-btn">No</button>
            </div>
        </div>
    </div>
    <!-- Sync Status Indicator -->
    <div class="sync-status" id="sync-status">Sync: Ready</div>
    <script>
        // Global variables
        let members = [];
        let attendance = [];
        let meetings = [];
        let currentSelectedMember = null;
        let currentCapture = null;
        let currentEditingMember = null;
        let availableJobs = ['Farmer', 'Teacher', 'Trader', 'Driver', 'Nurse'];
        let availableHometowns = ['Accra', 'Kumasi', 'Cape Coast', 'Takoradi', 'Tamale'];
        let availableTribes = ['Akan', 'Ewe', 'Ga', 'Dagomba', 'Fante'];
        let availableDepartments = ['General', 'Education', 'Commerce', 'Health', 'Agriculture'];
        let availablePositions = ['Member', 'Leader', 'Secretary', 'Treasurer', 'Organizer'];
        let availableChapters = [];
        let availableGroups = [];
        let cameraStream = null;
        let settingsPassword = "admin123";
        let users = [
            { username: 'admin', password: 'admin123', role: 'admin' },
            { username: 'user', password: 'user123', role: 'user' }
        ];
        let menuStructure = [
            {
                id: 'attendance',
                name: 'Attendance',
                icon: 'fas fa-clipboard-check',
                submenus: [
                    { id: 'attendance-overview', name: 'Attendance Overview', icon: 'fas fa-home' },
                    { id: 'verify-attendance', name: 'Verify Attendance', icon: 'fas fa-user-check' },
                    { id: 'view-attendance', name: "View Today's Attendance", icon: 'fas fa-list' },
                    { id: 'attendance-reports', name: 'Attendance Reports', icon: 'fas fa-chart-bar' },
                    { id: 'meeting-management', name: 'Meeting Management', icon: 'fas fa-calendar-alt' }
                ]
            },
            {
                id: 'members',
                name: 'Members',
                icon: 'fas fa-users',
                submenus: [
                    { id: 'all-members', name: 'All Members', icon: 'fas fa-users' },
                    { id: 'add-member', name: 'Add Member', icon: 'fas fa-user-plus' },
                    { id: 'manage-members', name: 'Manage Members', icon: 'fas fa-user-edit' },
                    { id: 'member-groups', name: 'Member Groups', icon: 'fas fa-object-group' },
                    { id: 'birthday-reminder', name: 'Birthday Reminder', icon: 'fas fa-birthday-cake' }
                ]
            },
            {
                id: 'settings',
                name: 'Settings',
                icon: 'fas fa-cog',
                submenus: [
                    { id: 'system-settings', name: 'System Settings', icon: 'fas fa-sliders-h' },
                    { id: 'user-management', name: 'User Management', icon: 'fas fa-user-shield' },
                    { id: 'chapter-management', name: 'Chapter Management', icon: 'fas fa-sitemap' },
                    { id: 'page-upgrade', name: 'Page Upgrade', icon: 'fas fa-wrench' }
                ]
            }
        ];
        let SCRIPT_URL = '';
        let SHEET_ID = '';
        let isCloudMode = false;

        // DOM Elements
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const searchResults = document.getElementById('search-results');
        const profileDisplay = document.getElementById('profile-display');
        const verificationStatus = document.getElementById('verification-status');
        const clearBtn = document.getElementById('clear-btn');
        const verifyBtn = document.getElementById('verify-btn');
        const attendanceList = document.getElementById('attendance-list');
        const userManagementList = document.getElementById('user-management-list');
        const presentCountEl = document.getElementById('present-count');
        const totalUsersEl = document.getElementById('total-users');
        const verifiedCountEl = document.getElementById('verified-count');
        const lastVerifiedEl = document.getElementById('last-verified');
        const jobFilter = document.getElementById('job-filter');
        const memberNameInput = document.getElementById('member-name');
        const memberIdInput = document.getElementById('member-id');
        const memberPhoneInput = document.getElementById('member-phone');
        const memberDobInput = document.getElementById('member-dob');
        const capturePreview = document.getElementById('capture-preview');
        const cameraBtn = document.getElementById('camera-btn');
        const saveBtn = document.getElementById('save-btn');
        const jobSelect = document.getElementById('job-select');
        const hometownSelect = document.getElementById('hometown-select');
        const tribeSelect = document.getElementById('tribe-select');
        const chapterSelect = document.getElementById('chapter-select');
        const groupSelect = document.getElementById('group-select');
        const cameraContainer = document.getElementById('camera-container');
        const cameraVideo = document.getElementById('camera-video');
        const capturePhotoBtn = document.getElementById('capture-photo-btn');
        const cancelCameraBtn = document.getElementById('cancel-camera-btn');
        const manageSearchInput = document.getElementById('manage-search-input');
        const manageSearchBtn = document.getElementById('manage-search-btn');
        const removePhotoBtn = document.getElementById('remove-photo-btn');
        const allMembersSearchInput = document.getElementById('all-members-search-input');
        const allMembersSearchBtn = document.getElementById('all-members-search-btn');
        const allMembersList = document.getElementById('all-members-list');
        const meetingDateInput = document.getElementById('meeting-date');
        const meetingTitleInput = document.getElementById('meeting-title');
        const createMeetingBtn = document.getElementById('create-meeting-btn');
        const createMeetingBtn2 = document.getElementById('create-meeting-btn2');
        const activeMeetingDisplay = document.getElementById('active-meeting-display');
        const activeMeetingsList = document.getElementById('active-meetings-list');
        const upcomingMeetingsList = document.getElementById('upcoming-meetings-list');
        const pastMeetingsList = document.getElementById('past-meetings-list');
        const birthdayCalendar = document.getElementById('birthday-calendar');
        const upcomingBirthdaysList = document.getElementById('upcoming-birthdays-list');
        const monthBirthdaysList = document.getElementById('month-birthdays-list');
        const birthdaysThisWeekEl = document.getElementById('birthdays-this-week');
        const birthdaysThisMonthEl = document.getElementById('birthdays-this-month');
        const birthdaysNextMonthEl = document.getElementById('birthdays-next-month');
        const sheetIdInput = document.getElementById('sheet-id');
        const scriptUrlInput = document.getElementById('script-url');
        const testConnectionBtn = document.getElementById('test-connection-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const loadDataBtn = document.getElementById('load-data-btn');
        const clearSettingsBtn = document.getElementById('clear-settings-btn');
        const compareSheetBtn = document.getElementById('compare-sheet-btn');
        const manualTestBtn = document.getElementById('manual-test-btn');
        const databaseStatus = document.getElementById('database-status');
        const optionCategory = document.getElementById('option-category');
        const newOptionInput = document.getElementById('new-option-input');
        const addOptionBtn = document.getElementById('add-option-btn');
        const optionsList = document.getElementById('options-list');
        const newMenuName = document.getElementById('new-menu-name');
        const newMenuIcon = document.getElementById('new-menu-icon');
        const addMenuBtn = document.getElementById('add-menu-btn');
        const parentMenuSelect = document.getElementById('parent-menu-select');
        const newSubmenuName = document.getElementById('new-submenu-name');
        const newSubmenuIcon = document.getElementById('new-submenu-icon');
        const newSubmenuSection = document.getElementById('new-submenu-section');
        const addSubmenuBtn = document.getElementById('add-submenu-btn');
        const menuList = document.getElementById('menu-list');
        const newChapterName = document.getElementById('new-chapter-name');
        const newChapterLocation = document.getElementById('new-chapter-location');
        const newChapterLeader = document.getElementById('new-chapter-leader');
        const addChapterBtn = document.getElementById('add-chapter-btn');
        const chaptersList = document.getElementById('chapters-list');
        const newGroupName = document.getElementById('new-group-name');
        const newGroupDescription = document.getElementById('new-group-description');
        const createGroupBtn = document.getElementById('create-group-btn');
        const groupsList = document.getElementById('groups-list');
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        const submitPasswordBtn = document.getElementById('submit-password-btn');
        const cancelPasswordBtn = document.getElementById('cancel-password-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');
        const syncBtn = document.getElementById('sync-btn');
        const syncStatus = document.getElementById('sync-status');
        const presentTodayCountEl = document.getElementById('present-today-count');
        const totalMembersCountEl = document.getElementById('total-members-count');
        const activeMeetingsCountEl = document.getElementById('active-meetings-count');
        const upcomingBirthdaysCountEl = document.getElementById('upcoming-birthdays-count');
        const viewAllMembersBtn = document.getElementById('view-all-members-btn');
        const modeIndicator = document.getElementById('mode-indicator');
        const sidebarNav = document.getElementById('sidebar-nav');
        const internetDot = document.getElementById('internet-dot');
        const internetStatus = document.getElementById('internet-status');
        const backendDot = document.getElementById('backend-dot');
        const backendStatus = document.getElementById('backend-status');
        const sheetDot = document.getElementById('sheet-dot');
        const sheetStatus = document.getElementById('sheet-status');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            updateUI();
        });

        function initializeApp() {
            loadSettings();
            setupLogoUpload();
            updateDropdowns();
            loadDataFromLocalStorage();
            generateSidebar();
            updateMenuBuilder();
            renderChaptersList();
            renderGroupsList();
            updateModeIndicator();
            checkInternetStatus();
            window.addEventListener('online', checkInternetStatus);
            window.addEventListener('offline', checkInternetStatus);
        }

        function checkInternetStatus() {
            if (navigator.onLine) {
                updateStatusDot(internetDot, 'ok', 'Online');
                internetStatus.textContent = 'Online';
            } else {
                updateStatusDot(internetDot, 'error', 'Offline');
                internetStatus.textContent = 'Offline';
            }
        }

        function updateStatusDot(element, status, message = '') {
            let color;
            switch (status) {
                case 'ok': color = '#28a745'; break;
                case 'warn': color = '#ffc107'; break;
                case 'error': color = '#dc3545'; break;
                case 'pending': color = '#6c757d'; break;
                default: color = '#ccc';
            }
            element.style.background = color;
            if (message) {
                const sibling = element.nextElementSibling;
                if (sibling) sibling.textContent = message;
            }
        }

        function updateModeIndicator() {
            if (isCloudMode && SHEET_ID && SCRIPT_URL) {
                modeIndicator.textContent = "Cloud Mode";
                modeIndicator.className = "mode-indicator cloud";
            } else {
                modeIndicator.textContent = "Local Mode";
                modeIndicator.className = "mode-indicator local";
            }
        }

        function generateSidebar() {
            sidebarNav.innerHTML = '';
            menuStructure.forEach(menu => {
                const menuItem = document.createElement('div');
                menuItem.className = 'dropdown-item';
                menuItem.innerHTML = `
                    <button class="dropdown-btn" data-tab="${menu.id}">
                        <i class="${menu.icon}"></i> ${menu.name}
                    </button>
                    <div class="dropdown-content">
                        ${menu.submenus.map(submenu => `
                            <button class="sub-tab" data-section="${submenu.id}">
                                <i class="${submenu.icon}"></i> ${submenu.name}
                            </button>
                        `).join('')}
                    </div>
                `;
                sidebarNav.appendChild(menuItem);
            });
            attachSidebarEventListeners();
        }

        function attachSidebarEventListeners() {
            const dropdownBtns = document.querySelectorAll('.dropdown-btn');
            const subTabs = document.querySelectorAll('.sub-tab');
            dropdownBtns.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const tabId = this.getAttribute('data-tab');
                    const parentItem = this.closest('.dropdown-item');
                    if (tabId === 'settings') {
                        passwordModal.style.display = 'flex';
                        return;
                    }
                    document.querySelectorAll('.dropdown-item').forEach(item => {
                        item.classList.remove('active');
                        const b = item.querySelector('.dropdown-btn');
                        if (b) b.classList.remove('active');
                    });
                    parentItem.classList.toggle('active');
                    this.classList.toggle('active');
                    if (parentItem.classList.contains('active')) {
                        const firstSubTab = parentItem.querySelector('.sub-tab');
                        if (firstSubTab) {
                            const sectionId = firstSubTab.getAttribute('data-section');
                            switchContentSection(sectionId);
                            subTabs.forEach(t => t.classList.remove('active'));
                            firstSubTab.classList.add('active');
                        }
                    }
                });
            });
            subTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const sectionId = this.getAttribute('data-section');
                    switchContentSection(sectionId);
                    subTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        function updateMenuBuilder() {
            parentMenuSelect.innerHTML = '<option value="">Select Parent Menu</option>';
            menuStructure.forEach(menu => {
                const option = document.createElement('option');
                option.value = menu.id;
                option.textContent = menu.name;
                parentMenuSelect.appendChild(option);
            });
            menuList.innerHTML = '';
            menuStructure.forEach(menu => {
                const menuItem = document.createElement('div');
                menuItem.className = 'menu-item';
                menuItem.innerHTML = `
                    <div class="menu-item-header">
                        <div class="menu-item-title">
                            <i class="${menu.icon}"></i> ${menu.name}
                        </div>
                        <button class="btn btn-danger btn-sm delete-menu-btn" data-menu="${menu.id}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                    <div class="submenu-list">
                        ${menu.submenus.map(submenu => `
                            <div class="submenu-item">
                                <div>
                                    <i class="${submenu.icon}"></i> ${submenu.name} (${submenu.id})
                                </div>
                                <button class="btn btn-danger btn-sm delete-submenu-btn" data-menu="${menu.id}" data-submenu="${submenu.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
                menuList.appendChild(menuItem);
            });
            document.querySelectorAll('.delete-menu-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const menuId = this.getAttribute('data-menu');
                    deleteMenu(menuId);
                });
            });
            document.querySelectorAll('.delete-submenu-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const menuId = this.getAttribute('data-menu');
                    const submenuId = this.getAttribute('data-submenu');
                    deleteSubmenu(menuId, submenuId);
                });
            });
        }

        function saveMenuStructure() {
            localStorage.setItem('asantemanMenuStructure', JSON.stringify(menuStructure));
        }

        function loadMenuStructure() {
            const saved = localStorage.getItem('asantemanMenuStructure');
            if (saved) menuStructure = JSON.parse(saved);
        }

        function showConfirmModal(message, callback) {
            confirmMessage.textContent = message;
            confirmModal.style.display = 'flex';
            confirmYesBtn.replaceWith(confirmYesBtn.cloneNode(true));
            confirmNoBtn.replaceWith(confirmNoBtn.cloneNode(true));
            const yes = document.getElementById('confirm-yes-btn');
            const no = document.getElementById('confirm-no-btn');
            yes.onclick = function() { confirmModal.style.display = 'none'; callback(); };
            no.onclick = () => confirmModal.style.display = 'none';
        }

        function loadSettings() {
            loadMenuStructure();
            try {
                const id = localStorage.getItem('asantemanSheetId');
                const url = localStorage.getItem('asantemanScriptUrl');
                const pwd = localStorage.getItem('asantemanPassword');
                const cloud = localStorage.getItem('asantemanCloudMode');
                if (id) { SHEET_ID = id; sheetIdInput.value = id; }
                if (url) { SCRIPT_URL = url; scriptUrlInput.value = url; }
                if (pwd) settingsPassword = pwd;
                isCloudMode = cloud === 'true';
                updateModeIndicator();
                updateDatabaseStatus(SHEET_ID 
                    ? `Settings loaded: ${SHEET_ID.substring(0,12)}...` 
                    : 'Local mode');
            } catch (e) {
                console.error('Settings load error:', e);
                showAlert('Error loading settings', 'error');
            }
        }

        function saveSettings() {
            const id = sheetIdInput.value.trim();
            const url = scriptUrlInput.value.trim();
            SHEET_ID = id;
            SCRIPT_URL = url;
            try {
                localStorage.setItem('asantemanSheetId', SHEET_ID);
                localStorage.setItem('asantemanScriptUrl', SCRIPT_URL);
                showAlert('‚úÖ Settings saved', 'success');
                updateDatabaseStatus(SHEET_ID 
                    ? `Sheet ID: ${SHEET_ID.substring(0,12)}...` 
                    : 'Local mode');
                return true;
            } catch (e) {
                showAlert('‚ùå Save error', 'error');
                return false;
            }
        }

        function clearSettings() {
            showConfirmModal('Clear ALL cloud settings?', function() {
                ['asantemanSheetId', 'asantemanScriptUrl', 'asantemanCloudMode'].forEach(k => localStorage.removeItem(k));
                SHEET_ID = ''; SCRIPT_URL = ''; isCloudMode = false;
                sheetIdInput.value = ''; scriptUrlInput.value = '';
                updateModeIndicator();
                updateDatabaseStatus('Settings cleared. Running in local mode.');
                showAlert('‚úÖ Settings cleared', 'success');
            });
        }

        function setupLogoUpload() {
            const logoContainer = document.getElementById('logo-container');
            logoContainer.onclick = () => {
                const input = document.createElement('input');
                input.type = 'file'; input.accept = 'image/*';
                input.onchange = e => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = ev => {
                            logoContainer.innerHTML = `<img src="${ev.target.result}" alt="Logo">`;
                            localStorage.setItem('asantemanLogo', ev.target.result);
                        };
                        reader.readAsDataURL(file);
                    }
                };
                input.click();
            };
            const saved = localStorage.getItem('asantemanLogo');
            if (saved) logoContainer.innerHTML = `<img src="${saved}" alt="Logo">`;
        }

        function setupEventListeners() {
            attachSidebarEventListeners();
            submitPasswordBtn.onclick = checkPassword;
            cancelPasswordBtn.onclick = () => { passwordModal.style.display = 'none'; passwordInput.value = ''; };
            searchBtn.onclick = performSearch;
            searchInput.onkeypress = e => { if (e.key === 'Enter') performSearch(); };
            verifyBtn.onclick = verifyAttendance;
            clearBtn.onclick = clearSearch;
            cameraBtn.onclick = startCamera;
            saveBtn.onclick = saveMember;
            removePhotoBtn.onclick = removeProfilePicture;
            capturePhotoBtn.onclick = capturePhoto;
            cancelCameraBtn.onclick = stopCamera;
            jobFilter.onchange = updateUI;
            testConnectionBtn.onclick = testConnection;
            saveSettingsBtn.onclick = saveSettings;
            loadDataBtn.onclick = loadDataFromCloud;
            clearSettingsBtn.onclick = clearSettings;
            compareSheetBtn.onclick = compareAndSyncSheetStructure;
            manualTestBtn.onclick = manualConnectionTest;
            optionCategory.onchange = updateOptionsList;
            addOptionBtn.onclick = addNewOption;
            addMenuBtn.onclick = addNewMenu;
            addSubmenuBtn.onclick = addNewSubmenu;
            syncBtn.onclick = syncDataToCloud;
            manageSearchBtn.onclick = performManageSearch;
            manageSearchInput.onkeypress = e => { if (e.key === 'Enter') performManageSearch(); };
            allMembersSearchBtn.onclick = performAllMembersSearch;
            allMembersSearchInput.onkeypress = e => { if (e.key === 'Enter') performAllMembersSearch(); };
            document.getElementById('generate-report-btn').onclick = generateReport;
            document.getElementById('add-user-btn').onclick = addNewUser;
            addChapterBtn.onclick = addNewChapter;
            createGroupBtn.onclick = createNewGroup;
            createMeetingBtn.onclick = createNewMeeting;
            createMeetingBtn2.onclick = createNewMeeting;
            viewAllMembersBtn.onclick = () => {
                switchContentSection('all-members');
                document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
                document.querySelector('.sub-tab[data-section="all-members"]').classList.add('active');
            };
            memberDobInput.onclick = () => {
                const rect = memberDobInput.getBoundingClientRect();
                birthdayCalendar.style.display = 'block';
                birthdayCalendar.style.top = (rect.bottom + window.scrollY) + 'px';
                birthdayCalendar.style.left = (rect.left + window.scrollX) + 'px';
                generateCalendar();
            };
            document.onclick = e => {
                if (!birthdayCalendar.contains(e.target) && e.target !== memberDobInput) {
                    birthdayCalendar.style.display = 'none';
                }
            };
        }

        function switchContentSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            if (sectionId === 'all-members') renderAllMembersList();
            else if (sectionId === 'meeting-management') renderMeetings();
            else if (sectionId === 'birthday-reminder') renderBirthdayReminders();
            else if (sectionId === 'attendance-overview') updateOverview();
            else if (sectionId === 'chapter-management') renderChaptersList();
            else if (sectionId === 'member-groups') renderGroupsList();
        }

        function checkPassword() {
            if (passwordInput.value === settingsPassword) {
                passwordModal.style.display = 'none';
                passwordInput.value = '';
                document.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('active'));
                const settingsItem = document.querySelector('.dropdown-item:has(.dropdown-btn[data-tab="settings"])');
                settingsItem.classList.add('active');
                settingsItem.querySelector('.dropdown-btn').classList.add('active');
                const first = settingsItem.querySelector('.sub-tab');
                switchContentSection(first.getAttribute('data-section'));
                document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
                first.classList.add('active');
            } else {
                showAlert('Incorrect password', 'error');
                passwordInput.value = '';
            }
        }

        function updateDropdowns() {
            const selects = [
                { el: jobSelect, data: availableJobs },
                { el: jobFilter, data: availableJobs },
                { el: hometownSelect, data: availableHometowns },
                { el: tribeSelect, data: availableTribes },
                { el: chapterSelect, data: availableChapters },
                { el: groupSelect, data: availableGroups }
            ];
            selects.forEach(({ el, data }) => {
                while (el.options.length > 1) el.remove(1);
                data.forEach(opt => {
                    const o = document.createElement('option');
                    o.value = opt; o.textContent = opt;
                    el.appendChild(o);
                });
            });
            updateOptionsList();
        }

        function updateOptionsList() {
            const cat = optionCategory.value;
            let arr;
            switch(cat) {
                case 'jobs': arr = availableJobs; break;
                case 'hometowns': arr = availableHometowns; break;
                case 'tribes': arr = availableTribes; break;
                case 'departments': arr = availableDepartments; break;
                case 'positions': arr = availablePositions; break;
                case 'chapters': arr = availableChapters; break;
                case 'groups': arr = availableGroups; break;
                default: arr = [];
            }
            optionsList.innerHTML = arr.length ? 
                arr.map(o => `<div class="option-item">
                    <span>${o}</span>
                    <button class="btn btn-danger btn-sm delete-option-btn" data-option="${o}"><i class="fas fa-trash"></i> Delete</button>
                </div>`).join('') 
                : '<p>No options available.</p>';
            document.querySelectorAll('.delete-option-btn').forEach(btn => {
                btn.onclick = () => deleteOption(btn.getAttribute('data-option'));
            });
        }

        function addNewOption() {
            const val = newOptionInput.value.trim();
            const cat = optionCategory.value;
            if (!val) return showAlert('Enter option value', 'error');
            let arr, name;
            switch(cat) {
                case 'jobs': arr = availableJobs; name = 'job title'; break;
                case 'hometowns': arr = availableHometowns; name = 'hometown'; break;
                case 'tribes': arr = availableTribes; name = 'tribe'; break;
                case 'departments': arr = availableDepartments; name = 'department'; break;
                case 'positions': arr = availablePositions; name = 'position'; break;
                case 'chapters': arr = availableChapters; name = 'chapter'; break;
                case 'groups': arr = availableGroups; name = 'group'; break;
                default: return;
            }
            if (arr.includes(val)) return showAlert(`This ${name} already exists`, 'error');
            arr.push(val);
            saveOptionsToLocalStorage();
            updateDropdowns();
            newOptionInput.value = '';
            showAlert(`"${val}" added`, 'success');
        }

        function deleteOption(opt) {
            const cat = optionCategory.value;
            let arr, name;
            switch(cat) {
                case 'jobs': arr = availableJobs; name = 'job title'; break;
                case 'hometowns': arr = availableHometowns; name = 'hometown'; break;
                case 'tribes': arr = availableTribes; name = 'tribe'; break;
                case 'departments': arr = availableDepartments; name = 'department'; break;
                case 'positions': arr = availablePositions; name = 'position'; break;
                case 'chapters': arr = availableChapters; name = 'chapter'; break;
                case 'groups': arr = availableGroups; name = 'group'; break;
                default: return;
            }
            const idx = arr.indexOf(opt);
            if (idx !== -1) {
                showConfirmModal(`Delete ${name} "${opt}"?`, () => {
                    arr.splice(idx, 1);
                    saveOptionsToLocalStorage();
                    updateDropdowns();
                    showAlert(`"${opt}" deleted`, 'success');
                });
            }
        }

        function generateCalendar() {
            const today = new Date();
            const month = today.getMonth();
            const year = today.getFullYear();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const days = lastDay.getDate();
            const startDay = firstDay.getDay();
            const months = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            let html = `
                <div class="calendar-header">
                    <button class="btn btn-sm btn-primary" id="prev-month"><i class="fas fa-chevron-left"></i></button>
                    <div class="calendar-month-year">${months[month]} ${year}</div>
                    <button class="btn btn-sm btn-primary" id="next-month"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-grid">
                    <div style="font-weight:bold">Sun</div><div style="font-weight:bold">Mon</div><div style="font-weight:bold">Tue</div>
                    <div style="font-weight:bold">Wed</div><div style="font-weight:bold">Thu</div><div style="font-weight:bold">Fri</div><div style="font-weight:bold">Sat</div>
            `;
            for (let i = 0; i < startDay; i++) html += `<div class="calendar-day other-month"></div>`;
            for (let d = 1; d <= days; d++) {
                const isToday = d === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                html += `<div class="calendar-day ${isToday ? 'selected' : ''}" data-day="${d}" data-month="${month + 1}">${d}</div>`;
            }
            birthdayCalendar.innerHTML = html + '</div>';
            birthdayCalendar.querySelectorAll('.calendar-day[data-day]').forEach(day => {
                day.onclick = function() {
                    birthdayCalendar.querySelectorAll('.calendar-day').forEach(x => x.classList.remove('selected'));
                    this.classList.add('selected');
                    const selectedDay = this.getAttribute('data-day');
                    const selectedMonth = this.getAttribute('data-month');
                    memberDobInput.value = `${selectedMonth}/${selectedDay}`;
                    birthdayCalendar.style.display = 'none';
                };
            });
            birthdayCalendar.querySelector('#prev-month').onclick = () => setTimeout(generateCalendar, 100);
            birthdayCalendar.querySelector('#next-month').onclick = () => setTimeout(generateCalendar, 100);
        }

        async function startCamera() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: { ideal: 300 }, height: { ideal: 300 }, facingMode: "user" } 
                });
                cameraVideo.srcObject = cameraStream;
                cameraContainer.style.display = 'block';
                cameraBtn.disabled = true;
            } catch (err) {
                showAlert('Camera access denied. Check permissions.', 'error');
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(t => t.stop());
                cameraStream = null;
            }
            cameraContainer.style.display = 'none';
            cameraBtn.disabled = false;
        }

        function capturePhoto() {
            const canvas = document.createElement('canvas');
            canvas.width = cameraVideo.videoWidth;
            canvas.height = cameraVideo.videoHeight;
            canvas.getContext('2d').drawImage(cameraVideo, 0, 0);
            currentCapture = canvas.toDataURL('image/jpeg', 0.9);
            capturePreview.innerHTML = `<img src="${currentCapture}">`;
            stopCamera();
            showAlert('Photo captured!', 'success');
        }

        function removeProfilePicture() {
            currentCapture = null;
            capturePreview.innerHTML = '<span>No profile picture</span>';
            showAlert('Photo removed', 'success');
        }

        function performSearch() {
            const q = searchInput.value.trim().toLowerCase();
            if (!q) return searchResults.style.display = 'none';
            const res = members.filter(m => 
                m.name.toLowerCase().includes(q) || (m.phone && m.phone.includes(q))
            );
            displaySearchResults(res);
        }

        function displaySearchResults(results) {
            searchResults.innerHTML = results.length 
                ? results.map(m => {
                    const isVerified = attendance.some(r => {
                        const rd = new Date(r.timestamp);
                        const td = new Date();
                        return r.memberId === m.id &&
                            rd.getFullYear() === td.getFullYear() &&
                            rd.getMonth() === td.getMonth() &&
                            rd.getDate() === td.getDate();
                    });
                    return `
                        <div class="search-result-item" onclick="selectMemberById('${m.id}')">
                            <div>
                                <div><strong>${m.name}</strong></div>
                                <div style="font-size: 0.9rem; color: #6c757d;">${m.phone || 'No phone'} ‚Ä¢ ${m.job || 'No job'}</div>
                            </div>
                            <div>${isVerified ? '<span style="color: #28a745; font-weight: bold;">Verified</span>' : '<button class="btn btn-success btn-sm verify-search-btn" onclick="verifyFromSearch(\'${m.id}\')">Verify</button>'}</div>
                        </div>
                    `;
                }).join('')
                : '<div class="search-result-item">No members found</div>';
            searchResults.style.display = 'block';
        }

        window.selectMemberById = function(id) {
            const member = members.find(m => m.id === id);
            if (member) selectMember(member);
        }
        window.verifyFromSearch = async function(id) {
            const member = members.find(m => m.id === id);
            if (member) {
                selectMember(member);
                await verifyAttendance();
                searchResults.style.display = 'none';
            }
        }

        function selectMember(member) {
            currentSelectedMember = member;
            searchInput.value = `${member.name} (${member.phone || 'No phone'})`;
            displayMemberProfile(member);
            const now = new Date();
            const isVerified = attendance.some(r => {
                const rd = new Date(r.timestamp);
                return r.memberId === member.id &&
                    rd.getFullYear() === now.getFullYear() &&
                    rd.getMonth() === now.getMonth() &&
                    rd.getDate() === now.getDate();
            });
            verificationStatus.textContent = isVerified 
                ? 'ALREADY VERIFIED - Attendance already marked today'
                : 'READY FOR VERIFICATION - Confirm identity and verify';
            verificationStatus.className = `verification-status ${isVerified ? 'verified' : 'not-verified'}`;
        }

        function displayMemberProfile(member) {
            const avatar = member.image 
                ? `<img src="${member.image}" alt="${member.name}" style="width:100%;height:100%;object-fit:cover;">`
                : member.name.split(' ').map(n => n[0]).join('');
            profileDisplay.innerHTML = `
                <div class="profile-avatar">${avatar}</div>
                <div class="profile-name">${member.name}</div>
                <div class="profile-details">
                    <div>ID: ${member.idNumber} ‚Ä¢ ${member.job || 'No job'}</div>
                    <div>Phone: ${member.phone || 'Not provided'} ‚Ä¢ Birth: ${member.dateOfBirth || 'Not specified'}</div>
                    <div>Hometown: ${member.hometown || 'Not specified'} ‚Ä¢ Tribe: ${member.tribe || 'Not specified'}</div>
                    <div>Chapter: ${member.chapter || 'Not specified'} ‚Ä¢ Group: ${member.group || 'Not specified'}</div>
                </div>
                <div class="profile-id">Click to view full profile</div>
            `;
        }

        async function verifyAttendance() {
            if (!currentSelectedMember) return showAlert('Select a member first', 'error');
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const alreadyVer = attendance.some(r => {
                const rd = new Date(r.timestamp);
                return r.memberId === currentSelectedMember.id &&
                    rd.getFullYear() === today.getFullYear() &&
                    rd.getMonth() === today.getMonth() &&
                    rd.getDate() === today.getDate();
            });
            if (alreadyVer) return showAlert('Already verified today', 'error');
            const rec = {
                memberId: currentSelectedMember.id,
                memberName: currentSelectedMember.name,
                timestamp: now.toISOString(),
                verificationTime: now.toLocaleTimeString()
            };
            attendance.push(rec);
            saveAllToLocalStorage();
            try {
                if (isCloudMode && SHEET_ID && SCRIPT_URL) await saveAttendanceToCloud(rec);
                verificationStatus.textContent = 'VERIFICATION SUCCESSFUL - Attendance marked';
                verificationStatus.className = 'verification-status verified';
                lastVerifiedEl.textContent = now.toLocaleTimeString();
                showAlert(`Attendance verified for ${currentSelectedMember.name}`, 'success');
                updateUI();
            } catch (err) {
                console.error('Cloud save failed:', err);
                showAlert(`‚úÖ Verified locally, but cloud sync failed: ${err.message}`, 'error');
            }
        }

        function clearSearch() {
            searchInput.value = '';
            searchResults.style.display = 'none';
            profileDisplay.innerHTML = '<div class="no-profile">No profile selected...</div>';
            verificationStatus.textContent = 'NOT VERIFIED - Profile needs verification';
            verificationStatus.className = 'verification-status not-verified';
            currentSelectedMember = null;
        }

        async function saveMember() {
            const name = memberNameInput.value.trim();
            const id = memberIdInput.value.trim();
            const phone = memberPhoneInput.value.trim();
            const dob = memberDobInput.value;
            const job = jobSelect.value;
            const hometown = hometownSelect.value;
            const tribe = tribeSelect.value;
            const chapter = chapterSelect.value;
            const group = groupSelect.value;
            if (!name || !id) return showAlert('Enter name and ID', 'error');
            if (members.some(m => m.idNumber === id && m.id !== currentEditingMember)) 
                return showAlert('ID already exists', 'error');
            if (phone && members.some(m => m.phone === phone && m.id !== currentEditingMember)) 
                return showAlert('Phone already exists', 'error');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            try {
                const data = {
                    id: currentEditingMember || Date.now().toString(),
                    name, idNumber: id, phone, dateOfBirth: dob, job, hometown, tribe, chapter, group,
                    image: currentCapture,
                    joinDate: currentEditingMember 
                        ? members.find(m => m.id === currentEditingMember)?.joinDate || new Date().toISOString().split('T')[0]
                        : new Date().toISOString().split('T')[0],
                    department: "General",
                    lastUpdated: new Date().toISOString()
                };
                if (currentEditingMember) {
                    const idx = members.findIndex(m => m.id === currentEditingMember);
                    if (idx !== -1) members[idx] = data;
                    await updateMemberOnCloud(data);
                    showAlert(`${name} updated`, 'success');
                    currentEditingMember = null;
                } else {
                    members.push(data);
                    await saveMemberToCloud(data);
                    showAlert(`${name} added`, 'success');
                }
                [memberNameInput, memberIdInput, memberPhoneInput, memberDobInput].forEach(el => el.value = '');
                [jobSelect, hometownSelect, tribeSelect, chapterSelect, groupSelect].forEach(el => el.value = '');
                capturePreview.innerHTML = '<span>No profile picture</span>';
                currentCapture = null;
                saveAllToLocalStorage();
                updateUI();
            } catch (err) {
                console.error(err);
                showAlert('Error saving member: ' + err.message, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Member';
            }
        }

        function deleteMember(id) {
            const member = members.find(m => m.id === id);
            if (!member) return;
            showConfirmModal(`Delete ${member.name}?`, async () => {
                try {
                    await deleteMemberFromCloud(id);
                    members = members.filter(m => m.id !== id);
                    attendance = attendance.filter(r => r.memberId !== id);
                    saveAllToLocalStorage();
                    updateUI();
                    if (currentSelectedMember && currentSelectedMember.id === id) clearSearch();
                    showAlert('Member deleted', 'success');
                } catch (err) {
                    console.error(err);
                    showAlert('Delete failed: ' + err.message, 'error');
                }
            });
        }

        function updateUI() {
            const jobFilterVal = jobFilter.value;
            const today = new Date();
            const todayRecords = attendance.filter(r => {
                const rd = new Date(r.timestamp);
                return rd.getFullYear() === today.getFullYear() &&
                    rd.getMonth() === today.getMonth() &&
                    rd.getDate() === today.getDate();
            });
            presentCountEl.textContent = todayRecords.length;
            totalUsersEl.textContent = members.length;
            verifiedCountEl.textContent = todayRecords.length;
            lastVerifiedEl.textContent = todayRecords.length 
                ? new Date(todayRecords[todayRecords.length - 1].timestamp).toLocaleTimeString()
                : '-';
            renderAttendanceList(jobFilterVal);
            renderUserManagementList();
            updateOverview();
        }

        function updateOverview() {
            const today = new Date();
            const todayRecords = attendance.filter(r => {
                const rd = new Date(r.timestamp);
                return rd.getFullYear() === today.getFullYear() &&
                    rd.getMonth() === today.getMonth() &&
                    rd.getDate() === today.getDate();
            });
            presentTodayCountEl.textContent = todayRecords.length;
            totalMembersCountEl.textContent = members.length;
            const activeMeetings = meetings.filter(m => {
                const md = new Date(m.date);
                return md.getFullYear() === today.getFullYear() &&
                    md.getMonth() === today.getMonth() &&
                    md.getDate() === today.getDate();
            });
            activeMeetingsCountEl.textContent = activeMeetings.length;
            const upcomingBdays = getUpcomingBirthdays(7).length;
            upcomingBirthdaysCountEl.textContent = upcomingBdays;
            if (activeMeetings.length > 0) {
                activeMeetingDisplay.innerHTML = `
                    <h4>${activeMeetings[0].title}</h4>
                    <p>Date: ${new Date(activeMeetings[0].date).toLocaleDateString()}</p>
                    <p>Attendees: ${activeMeetings[0].attendees ? activeMeetings[0].attendees.length : 0}</p>
                    <button class="btn btn-success" id="view-meeting-attendance-btn">
                        <i class="fas fa-users"></i> View Attendance
                    </button>
                `;
                document.getElementById('view-meeting-attendance-btn').onclick = () => {
                    switchContentSection('view-attendance');
                    document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
                    document.querySelector('.sub-tab[data-section="view-attendance"]').classList.add('active');
                };
            } else {
                activeMeetingDisplay.innerHTML = '<p>No active meeting.</p>';
            }
        }

        function renderAttendanceList(jobFilter = 'all') {
            const today = new Date();
            attendanceList.innerHTML = '';
            let filtered = members.filter(m => jobFilter === 'all' || m.job === jobFilter);
            if (!filtered.length) {
                attendanceList.innerHTML = '<div style="padding:20px;text-align:center;color:#6c757d;">No members match the filters</div>';
                return;
            }
            filtered.sort((a, b) => a.name.localeCompare(b.name)).forEach(m => {
                const rec = attendance.find(r => {
                    const rd = new Date(r.timestamp);
                    return r.memberId === m.id &&
                        rd.getFullYear() === today.getFullYear() &&
                        rd.getMonth() === today.getMonth() &&
                        rd.getDate() === today.getDate();
                });
                const isSelected = currentSelectedMember && currentSelectedMember.id === m.id;
                const avatar = m.image 
                    ? `<img src="${m.image}" alt="${m.name}" style="width:100%;height:100%;object-fit:cover;">`
                    : m.name.split(' ').map(n => n[0]).join('');
                const timeInfo = rec ? 
                    `<div class="attendance-time">Verified: ${rec.verificationTime || 'Today'}</div>` : 
                    '<div class="attendance-time">Not verified today</div>';
                attendanceList.innerHTML += `
                    <div class="attendance-item ${rec || isSelected ? 'present' : ''}" onclick="selectMemberById('${m.id}')">
                        <div class="user-info">
                            <div class="user-avatar">${avatar}</div>
                            <div>
                                <div>${m.name}</div>
                                <div style="font-size:0.8rem;color:#6c757d;">${m.job || 'No job'}</div>
                                ${timeInfo}
                            </div>
                        </div>
                        <div class="status-indicator ${rec || isSelected ? 'status-present' : 'status-absent'}"></div>
                    </div>
                `;
            });
        }

        function renderUserManagementList() {
            userManagementList.innerHTML = members.length 
                ? members.sort((a, b) => a.name.localeCompare(b.name)).map(m => {
                    const avatar = m.image 
                        ? `<img src="${m.image}" alt="${m.name}" style="width:100%;height:100%;object-fit:cover;">`
                        : m.name.split(' ').map(n => n[0]).join('');
                    return `
                        <div class="user-card">
                            <div class="user-avatar">${avatar}</div>
                            <div class="user-card-info">
                                <div class="user-card-name">${m.name}</div>
                                <div class="user-card-id">${m.idNumber} | ${m.job || 'No job'} | ${m.phone || 'No phone'}</div>
                            </div>
                            <button class="edit-btn" onclick="editMemberById('${m.id}')">Edit</button>
                            <button class="delete-btn" onclick="deleteMember('${m.id}')">Delete</button>
                        </div>
                    `;
                }).join('')
                : '<p>No members added yet.</p>';
        }

        window.editMemberById = function(id) {
            const member = members.find(m => m.id === id);
            if (member) {
                document.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('active'));
                const membersItem = document.querySelector('.dropdown-item:has(.dropdown-btn[data-tab="members"])');
                membersItem.classList.add('active');
                membersItem.querySelector('.dropdown-btn').classList.add('active');
                switchContentSection('add-member');
                document.querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
                document.querySelector('.sub-tab[data-section="add-member"]').classList.add('active');
                memberNameInput.value = member.name;
                memberIdInput.value = member.idNumber;
                memberPhoneInput.value = member.phone || '';
                memberDobInput.value = member.dateOfBirth || '';
                jobSelect.value = member.job || '';
                hometownSelect.value = member.hometown || '';
                tribeSelect.value = member.tribe || '';
                chapterSelect.value = member.chapter || '';
                groupSelect.value = member.group || '';
                if (member.image) {
                    capturePreview.innerHTML = `<img src="${member.image}">`;
                    currentCapture = member.image;
                } else {
                    capturePreview.innerHTML = '<span>No profile picture</span>';
                    currentCapture = null;
                }
                currentEditingMember = member.id;
                showAlert(`Editing: ${member.name}`, 'info');
            }
        };

        function renderAllMembersList() {
            allMembersList.innerHTML = members.length 
                ? members.sort((a, b) => a.name.localeCompare(b.name)).map(m => {
                    const avatar = m.image 
                        ? `<img src="${m.image}" alt="${m.name}" style="width:100%;height:100%;object-fit:cover;">`
                        : m.name.split(' ').map(n => n[0]).join('');
                    return `
                        <div class="user-card">
                            <div class="user-avatar">${avatar}</div>
                            <div class="user-card-info">
                                <div class="user-card-name">${m.name}</div>
                                <div class="user-card-id">${m.idNumber} | ${m.job || 'No job'} | ${m.phone || 'No phone'} | ${m.chapter ? `Chapter: ${m.chapter}` : ''} ${m.group ? `Group: ${m.group}` : ''}</div>
                            </div>
                            <button class="edit-btn" onclick="editMemberById('${m.id}')">Edit</button>
                        </div>
                    `;
                }).join('')
                : '<p>No members added yet.</p>';
        }

        function performAllMembersSearch() {
            const q = allMembersSearchInput.value.trim().toLowerCase();
            if (!q) return renderAllMembersList();
            const res = members.filter(m => 
                m.name.toLowerCase().includes(q) || m.idNumber.toLowerCase().includes(q)
            );
            allMembersList.innerHTML = res.length 
                ? res.map(m => {
                    const avatar = m.image 
                        ? `<img src="${m.image}" alt="${m.name}" style="width:100%;height:100%;object-fit:cover;">`
                        : m.name.split(' ').map(n => n[0]).join('');
                    return `
                        <div class="user-card">
                            <div class="user-avatar">${avatar}</div>
                            <div class="user-card-info">
                                <div class="user-card-name">${m.name}</div>
                                <div class="user-card-id">${m.idNumber} | ${m.job || 'No job'} | ${m.phone || 'No phone'} | ${m.chapter ? `Chapter: ${m.chapter}` : ''} ${m.group ? `Group: ${m.group}` : ''}</div>
                            </div>
                            <button class="edit-btn" onclick="editMemberById('${m.id}')">Edit</button>
                        </div>
                    `;
                }).join('')
                : '<p>No members found.</p>';
        }

        function performManageSearch() {
            const q = manageSearchInput.value.trim().toLowerCase();
            if (!q) return renderUserManagementList();
            const res = members.filter(m => 
                m.name.toLowerCase().includes(q) || m.idNumber.toLowerCase().includes(q)
            );
            userManagementList.innerHTML = res.length 
                ? res.map(m => {
                    const avatar = m.image 
                        ? `<img src="${m.image}" alt="${m.name}" style="width:100%;height:100%;object-fit:cover;">`
                        : m.name.split(' ').map(n => n[0]).join('');
                    return `
                        <div class="user-card">
                            <div class="user-avatar">${avatar}</div>
                            <div class="user-card-info">
                                <div class="user-card-name">${m.name}</div>
                                <div class="user-card-id">${m.idNumber} | ${m.job || 'No job'} | ${m.phone || 'No phone'}</div>
                            </div>
                            <button class="edit-btn" onclick="editMemberById('${m.id}')">Edit</button>
                            <button class="delete-btn" onclick="deleteMember('${m.id}')">Delete</button>
                        </div>
                    `;
                }).join('')
                : '<p>No members found.</p>';
        }

        function createNewMeeting() {
            const date = meetingDateInput.value;
            const title = meetingTitleInput.value.trim();
            if (!date || !title) return showAlert('Enter date and title', 'error');
            meetings.push({
                id: Date.now().toString(),
                date, title,
                createdAt: new Date().toISOString(),
                attendees: []
            });
            saveMeetingsToLocalStorage();
            renderMeetings();
            meetingDateInput.value = ''; meetingTitleInput.value = '';
            showAlert(`"${title}" created`, 'success');
        }

        function renderMeetings() {
            const today = new Date();
            today.setHours(0,0,0,0);
            const active = meetings.filter(m => {
                const md = new Date(m.date); md.setHours(0,0,0,0);
                return md.getTime() === today.getTime();
            });
            const upcoming = meetings.filter(m => {
                const md = new Date(m.date); md.setHours(0,0,0,0);
                return md.getTime() > today.getTime();
            });
            const past = meetings.filter(m => {
                const md = new Date(m.date); md.setHours(0,0,0,0);
                return md.getTime() < today.getTime();
            });
            const renderMeetingsList = (list, container, emptyMsg) => {
                container.innerHTML = list.length 
                    ? list.map(m => `
                        <div class="meeting-item">
                            <div>
                                <div class="meeting-date">${new Date(m.date).toLocaleDateString()}</div>
                                <div>${m.title}</div>
                            </div>
                            <div>
                                <span class="meeting-status status-${list === active ? 'active' : list === upcoming ? 'upcoming' : 'completed'}">
                                    ${list === active ? 'Active' : list === upcoming ? 'Upcoming' : 'Completed'}
                                </span>
                                <button class="btn btn-primary btn-sm view-meeting-btn" data-id="${m.id}">View</button>
                            </div>
                        </div>
                    `).join('')
                    : `<p>${emptyMsg}</p>`;
            };
            renderMeetingsList(active, activeMeetingsList, 'No active meetings today.');
            renderMeetingsList(upcoming, upcomingMeetingsList, 'No upcoming meetings.');
            renderMeetingsList(past, pastMeetingsList, 'No past meetings.');
            document.querySelectorAll('.view-meeting-btn').forEach(btn => {
                btn.onclick = () => viewMeeting(btn.getAttribute('data-id'));
            });
        }

        function viewMeeting(id) {
            const meeting = meetings.find(m => m.id === id);
            if (meeting) showAlert(`Viewing: ${meeting.title}`, 'info');
        }

        function getUpcomingBirthdays(days = 7) {
            const today = new Date();
            return members.filter(m => m.dateOfBirth).map(m => {
                const [month, day] = m.dateOfBirth.split('/').map(Number);
                const bday = new Date(today.getFullYear(), month - 1, day);
                const diffDays = Math.ceil((bday.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
                return { member: m, daysUntil: diffDays };
            }).filter(i => i.daysUntil >= 0 && i.daysUntil <= days).sort((a, b) => a.daysUntil - b.daysUntil);
        }

        function renderBirthdayReminders() {
            const upcoming = getUpcomingBirthdays(7);
            const thisMonth = getBirthdaysThisMonth();
            const nextMonth = getBirthdaysNextMonth();
            birthdaysThisWeekEl.textContent = upcoming.length;
            birthdaysThisMonthEl.textContent = thisMonth.length;
            birthdaysNextMonthEl.textContent = nextMonth.length;
            const renderBirthdayList = (items, container, emptyMsg) => {
                container.innerHTML = items.length 
                    ? items.map(i => {
                        const m = i.member || i;
                        const avatar = m.image 
                            ? `<img src="${m.image}" alt="${m.name}" style="width:100%;height:100%;object-fit:cover;">`
                            : m.name.split(' ').map(n => n[0]).join('');
                        return `
                            <div class="birthday-item">
                                <div class="birthday-avatar">${avatar}</div>
                                <div>
                                    <div><strong>${m.name}</strong></div>
                                    <div>Birthday: ${m.dateOfBirth}</div>
                                    <div>${m.phone || 'No phone'} | ${m.job || 'No job'}</div>
                                </div>
                                ${i.daysUntil !== undefined ? `<div class="birthday-days">${i.daysUntil === 0 ? 'Today!' : `${i.daysUntil} day${i.daysUntil === 1 ? '' : 's'}`}</div>` : ''}
                            </div>
                        `;
                    }).join('')
                    : `<p>${emptyMsg}</p>`;
            };
            renderBirthdayList(upcoming, upcomingBirthdaysList, 'No birthdays in next 7 days.');
            renderBirthdayList(thisMonth, monthBirthdaysList, 'No birthdays this month.');
        }

        function getBirthdaysThisMonth() {
            const month = new Date().getMonth() + 1;
            return members.filter(m => m.dateOfBirth && parseInt(m.dateOfBirth.split('/')[0]) === month);
        }

        function getBirthdaysNextMonth() {
            const next = new Date().getMonth() + 2 > 12 ? 1 : new Date().getMonth() + 2;
            return members.filter(m => m.dateOfBirth && parseInt(m.dateOfBirth.split('/')[0]) === next);
        }

        function renderChaptersList() {
            chaptersList.innerHTML = availableChapters.length 
                ? availableChapters.map(c => `
                    <div class="chapter-item">
                        <div class="chapter-info">
                            <div class="chapter-name">${c.name}</div>
                            <div class="chapter-details">Location: ${c.location} | Leader: ${c.leader}</div>
                        </div>
                        <div>
                            <button class="btn btn-info btn-sm edit-chapter-btn" data-name="${c.name}">Edit</button>
                            <button class="btn btn-danger btn-sm delete-chapter-btn" data-name="${c.name}">Delete</button>
                        </div>
                    </div>
                `).join('')
                : '<p>No chapters created yet.</p>';
            document.querySelectorAll('.delete-chapter-btn').forEach(btn => {
                btn.onclick = () => deleteChapter(btn.getAttribute('data-name'));
            });
            document.querySelectorAll('.edit-chapter-btn').forEach(btn => {
                btn.onclick = () => editChapter(btn.getAttribute('data-name'));
            });
        }

        function addNewChapter() {
            const name = newChapterName.value.trim();
            const loc = newChapterLocation.value.trim();
            const leader = newChapterLeader.value.trim();
            if (!name || !loc || !leader) return showAlert('Enter all info', 'error');
            if (availableChapters.some(c => c.name === name)) return showAlert('Chapter exists', 'error');
            availableChapters.push({ name, location: loc, leader });
            saveOptionsToLocalStorage();
            updateDropdowns();
            renderChaptersList();
            [newChapterName, newChapterLocation, newChapterLeader].forEach(el => el.value = '');
            showAlert(`"${name}" added`, 'success');
        }

        function deleteChapter(name) {
            showConfirmModal(`Delete chapter "${name}"?`, () => {
                availableChapters = availableChapters.filter(c => c.name !== name);
                saveOptionsToLocalStorage();
                updateDropdowns();
                renderChaptersList();
                showAlert(`"${name}" deleted`, 'success');
            });
        }

        function editChapter(name) {
            const chapter = availableChapters.find(c => c.name === name);
            if (chapter) {
                newChapterName.value = chapter.name;
                newChapterLocation.value = chapter.location;
                newChapterLeader.value = chapter.leader;
                availableChapters = availableChapters.filter(c => c.name !== name);
                saveOptionsToLocalStorage();
                updateDropdowns();
                renderChaptersList();
                showAlert(`Editing "${name}". Update and click "Add Chapter".`, 'info');
            }
        }

        function renderGroupsList() {
            groupsList.innerHTML = availableGroups.length 
                ? availableGroups.map(g => `
                    <div class="group-item">
                        <div class="group-info">
                            <div class="group-name">${g.name}</div>
                            <div class="group-details">${g.description || 'No description'}</div>
                        </div>
                        <div>
                            <button class="btn btn-info btn-sm edit-group-btn" data-name="${g.name}">Edit</button>
                            <button class="btn btn-danger btn-sm delete-group-btn" data-name="${g.name}">Delete</button>
                        </div>
                    </div>
                `).join('')
                : '<p>No groups created yet.</p>';
            document.querySelectorAll('.delete-group-btn').forEach(btn => {
                btn.onclick = () => deleteGroup(btn.getAttribute('data-name'));
            });
            document.querySelectorAll('.edit-group-btn').forEach(btn => {
                btn.onclick = () => editGroup(btn.getAttribute('data-name'));
            });
        }

        function createNewGroup() {
            const name = newGroupName.value.trim();
            const desc = newGroupDescription.value.trim();
            if (!name) return showAlert('Enter group name', 'error');
            if (availableGroups.some(g => g.name === name)) return showAlert('Group exists', 'error');
            availableGroups.push({ name, description: desc });
            saveOptionsToLocalStorage();
            updateDropdowns();
            renderGroupsList();
            newGroupName.value = ''; newGroupDescription.value = '';
            showAlert(`"${name}" created`, 'success');
        }

        function deleteGroup(name) {
            showConfirmModal(`Delete group "${name}"?`, () => {
                availableGroups = availableGroups.filter(g => g.name !== name);
                saveOptionsToLocalStorage();
                updateDropdowns();
                renderGroupsList();
                showAlert(`"${name}" deleted`, 'success');
            });
        }

        function editGroup(name) {
            const group = availableGroups.find(g => g.name === name);
            if (group) {
                newGroupName.value = group.name;
                newGroupDescription.value = group.description || '';
                availableGroups = availableGroups.filter(g => g.name !== name);
                saveOptionsToLocalStorage();
                updateDropdowns();
                renderGroupsList();
                showAlert(`Editing "${name}". Update and click "Create Group".`, 'info');
            }
        }

        // ========== ‚úÖ FIXED CLOUD SYNC FUNCTIONS (CORS-SAFE) ==========

        // ‚úÖ Test connection (GET only)
        async function testScriptConnection(url, sheetId) {
            const testUrl = `${url}?action=test&sheetId=${encodeURIComponent(sheetId || 'test')}&t=${Date.now()}`;
            const res = await fetch(testUrl);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            if (!data.success) throw new Error(data.error || 'Test failed');
            return true;
        }

        // ‚úÖ Compare & Sync Structure (GET ‚Äî unchanged)
        async function compareAndSyncSheetStructure() {
            if (!SHEET_ID || !SCRIPT_URL) return showAlert('Configure settings first', 'error');
            updateStatusDot(backendDot, 'pending', 'Testing‚Ä¶');
            updateStatusDot(sheetDot, 'pending', 'Testing‚Ä¶');
            try {
                await testScriptConnection(SCRIPT_URL, SHEET_ID);
                const url = `${SCRIPT_URL}?action=initSheet&sheetId=${encodeURIComponent(SHEET_ID)}`;
                const res = await fetch(url);
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Init failed');
                showAlert('‚úÖ Sheet structure synchronized', 'success');
                updateStatusDot(backendDot, 'ok', 'Connected');
                updateStatusDot(sheetDot, 'ok', 'Accessible');
                isCloudMode = true;
                localStorage.setItem('asantemanCloudMode', 'true');
                updateModeIndicator();
                updateDatabaseStatus(`Connected to Cloud Sheet: ${SHEET_ID.substring(0,12)}...`);
            } catch (err) {
                showAlert('‚ùå Sheet init failed: ' + err.message, 'error');
                updateStatusDot(backendDot, 'error', 'Failed');
                updateStatusDot(sheetDot, 'error', 'Failed');
                isCloudMode = false;
                localStorage.setItem('asantemanCloudMode', 'false');
                updateModeIndicator();
            }
        }

        // ‚úÖ Sync All (POST form-encoded ‚Äî NO CORS)
        async function syncDataToCloud() {
            if (!SHEET_ID || !SCRIPT_URL) return showAlert('Configure settings first', 'error');
            updateSyncStatus('syncing', 'Syncing to cloud‚Ä¶');
            try {
                await testScriptConnection(SCRIPT_URL, SHEET_ID);

                const formData = new URLSearchParams();
                formData.append('action', 'syncAll');
                formData.append('sheetId', SHEET_ID);
                formData.append('members', JSON.stringify(members));
                formData.append('attendance', JSON.stringify(attendance));
                formData.append('version', '1.0');

                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Sync failed');

                showAlert(`‚úÖ Synced ${members.length} members`, 'success');
                isCloudMode = true;
                localStorage.setItem('asantemanCloudMode', 'true');
                updateModeIndicator();
                updateDatabaseStatus(`Connected to Cloud Sheet: ${SHEET_ID.substring(0,12)}...`);
                updateSyncStatus('success', 'Sync complete');
            } catch (err) {
                console.error('Sync error:', err);
                showAlert('‚ùå Sync failed: ' + err.message, 'error');
                isCloudMode = false;
                localStorage.setItem('asantemanCloudMode', 'false');
                updateModeIndicator();
                updateSyncStatus('error', 'Sync failed');
            }
        }

        // ‚úÖ Load Data from Cloud (GET ‚Äî unchanged)
        async function loadDataFromCloud() {
            if (!SHEET_ID || !SCRIPT_URL) return showAlert('Configure settings first', 'error');
            updateSyncStatus('syncing', 'Loading from cloud‚Ä¶');
            try {
                await testScriptConnection(SCRIPT_URL, SHEET_ID);
                const url = `${SCRIPT_URL}?action=getMembers&sheetId=${encodeURIComponent(SHEET_ID)}&t=${Date.now()}`;
                const res = await fetch(url);
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Load failed');
                members = data.members || [];
                attendance = data.attendance || [];
                showAlert(`‚úÖ Loaded ${members.length} members`, 'success');
                isCloudMode = true;
                localStorage.setItem('asantemanCloudMode', 'true');
                updateModeIndicator();
                updateDatabaseStatus(`Connected to Cloud Sheet: ${SHEET_ID.substring(0,12)}...`);
                updateSyncStatus('success', 'Load complete');
                updateUI();
            } catch (err) {
                console.error('Load error:', err);
                showAlert('‚ùå Load failed: ' + err.message, 'error');
                isCloudMode = false;
                localStorage.setItem('asantemanCloudMode', 'false');
                updateModeIndicator();
                updateSyncStatus('error', 'Load failed');
            }
        }

        // ‚úÖ Enhanced testConnection
        async function testConnection() {
            if (!saveSettings()) return showAlert('Save settings first', 'error');
            if (!SHEET_ID || !SCRIPT_URL) return showAlert('Enter Sheet ID & Script URL', 'error');

            updateStatusDot(backendDot, 'pending', 'Testing‚Ä¶');
            updateStatusDot(sheetDot, 'pending', 'Testing‚Ä¶');
            try {
                await testScriptConnection(SCRIPT_URL, SHEET_ID);
                updateStatusDot(backendDot, 'ok', 'Connected');

                const testUrl = `${SCRIPT_URL}?action=getMembers&sheetId=${encodeURIComponent(SHEET_ID)}&t=${Date.now()}`;
                const res = await fetch(testUrl);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Sheet access failed');
                updateStatusDot(sheetDot, 'ok', 'Accessible');

                isCloudMode = true;
                localStorage.setItem('asantemanCloudMode', 'true');
                updateModeIndicator();
                updateDatabaseStatus(`Connected to Cloud Sheet: ${SHEET_ID.substring(0,12)}...`);
                updateSyncStatus('success', '‚úÖ Test passed');
                showAlert('‚úÖ Connection verified', 'success');
            } catch (err) {
                updateStatusDot(backendDot, 'error', 'Error');
                updateStatusDot(sheetDot, 'error', 'Error');
                isCloudMode = false;
                localStorage.setItem('asantemanCloudMode', 'false');
                updateModeIndicator();
                updateDatabaseStatus('Cloud mode disabled due to connection issues');
                updateSyncStatus('error', '‚ùå Connection test failed');
                showAlert('‚ùå Test failed: ' + err.message, 'error');
            }
        }

        // ‚úÖ Cloud CRUD ‚Äî CORS-safe form POST

        async function saveMemberToCloud(member) {
            if (!isCloudMode || !SHEET_ID || !SCRIPT_URL) return;
            const formData = new URLSearchParams();
            formData.append('action', 'saveMember');
            formData.append('sheetId', SHEET_ID);
            formData.append('member', JSON.stringify(member));

            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.error || 'Cloud save failed');
        }

        async function updateMemberOnCloud(member) {
            if (!isCloudMode || !SHEET_ID || !SCRIPT_URL) return;
            const formData = new URLSearchParams();
            formData.append('action', 'updateMember');
            formData.append('sheetId', SHEET_ID);
            formData.append('member', JSON.stringify(member));

            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.error || 'Cloud update failed');
        }

        async function deleteMemberFromCloud(memberId) {
            if (!isCloudMode || !SHEET_ID || !SCRIPT_URL) return;
            const formData = new URLSearchParams();
            formData.append('action', 'deleteMember');
            formData.append('sheetId', SHEET_ID);
            formData.append('memberId', memberId);

            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.error || 'Cloud delete failed');
        }

        async function saveAttendanceToCloud(rec) {
            if (!isCloudMode || !SHEET_ID || !SCRIPT_URL) return;
            const formData = new URLSearchParams();
            formData.append('action', 'saveAttendance');
            formData.append('sheetId', SHEET_ID);
            formData.append('attendance', JSON.stringify(rec));

            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: formData
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.error || 'Cloud attendance save failed');
        }

        // UI helpers
        function updateDatabaseStatus(message) {
            databaseStatus.innerHTML = `
                <div style="background: #f8f9fa; padding:15px; border-radius:5px; border-left:4px solid #17a2b8;">
                    <h4 style="margin-bottom:10px;color:#17a2b8;">Database Status</h4>
                    <p style="margin:0;">${message}</p>
                    ${SHEET_ID ? `<p style="margin:5px 0 0 0;font-size:0.9em;"><strong>Sheet ID:</strong> ${SHEET_ID}</p>` : ''}
                    ${SCRIPT_URL ? `<p style="margin:0;font-size:0.9em;"><strong>Script URL:</strong> ${SCRIPT_URL.substring(0,50)}...</p>` : ''}
                    <p style="margin:5px 0 0 0;font-size:0.9em;"><strong>Mode:</strong> ${isCloudMode ? 'Cloud ‚úÖ' : 'Local ‚ö†Ô∏è'}</p>
                </div>
            `;
        }

        function updateSyncStatus(type, message) {
            syncStatus.textContent = `Sync: ${message}`;
            syncStatus.className = 'sync-status';
            if (type === 'syncing') syncStatus.classList.add('syncing');
            else if (type === 'error') syncStatus.classList.add('error');
            else if (type === 'success') {
                syncStatus.classList.add('success');
                setTimeout(() => syncStatus.style.display = 'none', 3000);
            }
            syncStatus.style.display = 'block';
        }

        function manualConnectionTest() {
            if (!SHEET_ID || !SCRIPT_URL) return alert('Set Sheet ID and Script URL first');
            const testUrl = `${SCRIPT_URL}?action=test&sheetId=${SHEET_ID}`;
            alert(`Testing: ${testUrl}\nCheck deployment settings in GAS.`);
            fetch(testUrl)
                .then(r => { alert(`Status: ${r.status}`); return r.json(); })
                .then(d => alert(`Response: ${JSON.stringify(d)}`))
                .catch(e => alert(`Error: ${e.message}`));
        }

        function saveAllToLocalStorage() {
            const keys = ['Members', 'Attendance', 'Jobs', 'Hometowns', 'Tribes', 'Departments', 'Positions', 'Chapters', 'Groups', 'LastSync'];
            const values = [members, attendance, availableJobs, availableHometowns, availableTribes, availableDepartments, availablePositions, availableChapters, availableGroups, Date.now().toString()];
            keys.forEach((k, i) => localStorage.setItem(`asanteman${k}`, JSON.stringify(values[i])));
        }

        function saveMeetingsToLocalStorage() {
            localStorage.setItem('asantemanMeetings', JSON.stringify(meetings));
        }

        function saveOptionsToLocalStorage() {
            ['Jobs', 'Hometowns', 'Tribes', 'Departments', 'Positions', 'Chapters', 'Groups']
                .forEach(k => localStorage.setItem(`asanteman${k}`, JSON.stringify(eval(`available${k}`))));
        }

        function loadDataFromLocalStorage() {
            const keys = ['Members', 'Attendance', 'Jobs', 'Hometowns', 'Tribes', 'Departments', 'Positions', 'Chapters', 'Groups'];
            const vars = ['members', 'attendance', 'availableJobs', 'availableHometowns', 'availableTribes', 'availableDepartments', 'availablePositions', 'availableChapters', 'availableGroups'];
            keys.forEach((k, i) => {
                const val = localStorage.getItem(`asanteman${k}`);
                if (val) eval(`${vars[i]} = JSON.parse(val)`);
            });
            const cloud = localStorage.getItem('asantemanCloudMode');
            if (cloud) isCloudMode = cloud === 'true';
            updateDropdowns();
            updateUI();
            updateModeIndicator();
            updateDatabaseStatus(`Loaded ${members.length} members`);
        }

        function generateReport() {
            const start = new Date(document.getElementById('report-start-date').value);
            const end = new Date(document.getElementById('report-end-date').value);
            if (isNaN(start) || isNaN(end)) return showAlert('Select valid dates', 'error');
            const filtered = attendance.filter(r => {
                const rd = new Date(r.timestamp);
                return rd >= start && rd <= end;
            });
            document.getElementById('report-results').innerHTML = `
                <div class="stats-container">
                    <div class="stat-card"><div class="stat-label">Total Attendance</div><div class="stat-value">${filtered.length}</div></div>
                    <div class="stat-card"><div class="stat-label">Unique Members</div><div class="stat-value">${[...new Set(filtered.map(r => r.memberId))].length}</div></div>
                    <div class="stat-card"><div class="stat-label">Date Range</div><div class="stat-value">${start.toLocaleDateString()} to ${end.toLocaleDateString()}</div></div>
                </div>
                <h4>Attendance Details</h4>
                <div class="attendance-list">
                    ${filtered.map(r => `
                        <div class="attendance-item">
                            <div class="user-info">
                                <div><strong>${r.memberName}</strong></div>
                                <div class="attendance-time">${new Date(r.timestamp).toLocaleString()}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            showAlert('Report generated', 'success');
        }

        function addNewUser() {
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-user-role').value;
            if (!username || !password) return showAlert('Enter username & password', 'error');
            if (users.some(u => u.username === username)) return showAlert('Username exists', 'error');
            users.push({ username, password, role });
            document.getElementById('new-username').value = '';
            document.getElementById('new-password').value = '';
            showAlert(`User ${username} added`, 'success');
            renderUsersList();
        }

        function renderUsersList() {
            document.getElementById('users-list').innerHTML = `
                <h4>Current Users</h4>
                <div class="attendance-list">
                    ${users.map(u => `
                        <div class="attendance-item">
                            <div class="user-info">
                                <div><strong>${u.username}</strong></div>
                                <div class="attendance-time">Role: ${u.role}</div>
                            </div>
                            <button class="btn btn-danger btn-sm delete-user-btn" data-username="${u.username}">Delete</button>
                        </div>
                    `).join('')}
                </div>
            `;
            document.querySelectorAll('.delete-user-btn').forEach(btn => {
                btn.onclick = () => {
                    const u = btn.getAttribute('data-username');
                    if (u === 'admin') return showAlert('Cannot delete admin', 'error');
                    showConfirmModal(`Delete user ${u}?`, () => {
                        users = users.filter(x => x.username !== u);
                        renderUsersList();
                        showAlert(`${u} deleted`, 'success');
                    });
                };
            });
        }

        function showAlert(message, type) {
            const el = document.querySelector('.alert');
            if (el) el.remove();
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            document.querySelector('.main-content').insertBefore(alert, document.querySelector('.main-content').firstChild);
            setTimeout(() => alert.remove(), 5000);
        }

        // Init
        renderUsersList();

        // Menu CRUD
        function addNewMenu() {
            const name = newMenuName.value.trim();
            const icon = newMenuIcon.value.trim();
            if (!name) return showAlert('Enter menu name', 'error');
            if (!icon) return showAlert('Enter icon class', 'error');
            menuStructure.push({
                id: name.toLowerCase().replace(/\s+/g, '-'),
                name, icon,
                submenus: []
            });
            saveMenuStructure();
            generateSidebar();
            updateMenuBuilder();
            newMenuName.value = ''; newMenuIcon.value = '';
            showAlert(`"${name}" added`, 'success');
        }

        function addNewSubmenu() {
            const parent = parentMenuSelect.value;
            const name = newSubmenuName.value.trim();
            const icon = newSubmenuIcon.value.trim();
            const section = newSubmenuSection.value.trim();
            if (!parent) return showAlert('Select parent menu', 'error');
            if (!name || !section) return showAlert('Enter name and section ID', 'error');
            const menu = menuStructure.find(m => m.id === parent);
            if (!menu) return showAlert('Parent menu not found', 'error');
            menu.submenus.push({
                id: section,
                name,
                icon: icon || 'fas fa-circle'
            });
            saveMenuStructure();
            generateSidebar();
            updateMenuBuilder();
            newSubmenuName.value = ''; newSubmenuIcon.value = ''; newSubmenuSection.value = '';
            showAlert(`"${name}" added to "${menu.name}"`, 'success');
        }

        function deleteMenu(id) {
            if (['attendance', 'members', 'settings'].includes(id)) 
                return showAlert('Cannot delete core menus', 'error');
            showConfirmModal(`Delete menu "${id}" and submenus?`, () => {
                menuStructure = menuStructure.filter(m => m.id !== id);
                saveMenuStructure();
                generateSidebar();
                updateMenuBuilder();
                showAlert('Menu deleted', 'success');
            });
        }

        function deleteSubmenu(menuId, submenuId) {
            showConfirmModal('Delete submenu?', () => {
                const menu = menuStructure.find(m => m.id === menuId);
                if (menu) {
                    menu.submenus = menu.submenus.filter(s => s.id !== submenuId);
                    saveMenuStructure();
                    generateSidebar();
                    updateMenuBuilder();
                    showAlert('Submenu deleted', 'success');
                }
            });
        }
    </script>
</body>
</html>
