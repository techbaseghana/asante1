<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASANTEMAN FETTEH KUO - Cloud Attendance</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 95vh;
        }

        header {
            background: linear-gradient(90deg, #1a2a6c, #b21f1f);
            color: white;
            padding: 15px 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .logo-container {
            width: 70px;
            height: 70px;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .logo-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .header-text {
            flex: 1;
            margin: 0 15px;
        }

        .main-header {
            font-size: 2.5rem;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .sub-header {
            font-size: 1.2rem;
            opacity: 0.9;
            font-weight: 600;
        }

        .mode-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-left: 10px;
            background: #28a745;
            color: white;
        }

        .mode-indicator.local {
            background: #6c757d;
        }

        .mode-indicator.cloud {
            background: #28a745;
        }

        .app-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 250px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .dropdown-nav {
            display: flex;
            flex-direction: column;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .dropdown-item {
            position: relative;
        }

        .dropdown-btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            background: transparent;
            text-align: left;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .dropdown-btn i {
            width: 20px;
            text-align: center;
            margin-right: 10px;
        }

        .dropdown-btn.active {
            background: #1a2a6c;
            color: white;
        }

        .dropdown-btn::after {
            content: '\f078';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 0.8rem;
            transition: transform 0.3s;
        }

        .dropdown-btn.active::after {
            transform: rotate(180deg);
        }

        .dropdown-content {
            display: none;
            background: #f1f3f5;
            overflow: hidden;
        }

        .dropdown-item.active .dropdown-content {
            display: block;
        }

        .sub-tab {
            padding: 10px 20px 10px 40px;
            border: none;
            background: transparent;
            text-align: left;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            color: #666;
            width: 100%;
            display: flex;
            align-items: center;
        }

        .sub-tab:hover {
            background: #e9ecef;
        }

        .sub-tab.active {
            background: #e2e6ea;
            color: #1a2a6c;
            font-weight: 600;
            border-left: 3px solid #1a2a6c;
        }

        .sub-tab i {
            width: 16px;
            text-align: center;
            font-size: 0.9rem;
            margin-right: 8px;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .content-section {
            display: none;
            flex: 1;
        }

        .content-section.active {
            display: flex;
            flex-direction: column;
        }

        .section-header {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1a2a6c;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .verification-container, .form-container, .sheet-config {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .search-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1.1rem;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #1a2a6c;
            box-shadow: 0 0 0 3px rgba(26, 42, 108, 0.1);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #1a2a6c;
            color: white;
        }

        .btn-primary:hover {
            background: #0d1a4a;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.9rem;
        }

        .profile-display {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 20px 0;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .profile-display:hover {
            background: #e9ecef;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #1a2a6c;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 2.5rem;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-name {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .profile-details {
            color: #6c757d;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .profile-id {
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 1rem;
        }

        .verification-status {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .verified {
            background: #d4edda;
            color: #155724;
        }

        .not-verified {
            background: #f8d7da;
            color: #721c24;
        }

        .no-profile {
            color: #6c757d;
            font-style: italic;
            font-size: 1.1rem;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
            flex-wrap: wrap;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1a2a6c;
            margin: 10px 0;
        }

        .stat-label {
            color: #6c757d;
            font-size: 1rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 1.1rem;
        }

        .dropdown-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 1.1rem;
            background: white;
            cursor: pointer;
        }

        .capture-preview {
            width: 150px;
            height: 150px;
            border: 2px dashed #ccc;
            border-radius: 5px;
            margin: 10px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .capture-preview img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 5px;
        }

        .camera-container {
            position: relative;
            width: 100%;
            max-width: 300px;
            margin: 10px auto;
            border-radius: 10px;
            overflow: hidden;
            display: none;
        }

        #camera-video {
            width: 100%;
            height: auto;
            display: block;
            background: #000;
        }

        .camera-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .attendance-list {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 10px;
        }

        .attendance-item {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .attendance-item:hover {
            background: #f8f9fa;
        }

        .attendance-item:last-child {
            border-bottom: none;
        }

        .attendance-item.present {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #1a2a6c;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .attendance-time {
            color: #6c757d;
            font-size: 1rem;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-present {
            background: #28a745;
        }

        .status-absent {
            background: #dc3545;
        }

        .user-management {
            margin-top: 20px;
        }

        .user-card {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin-bottom: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .user-card:hover {
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .user-card-info {
            flex: 1;
            margin-left: 10px;
        }

        .user-card-name {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .user-card-id {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .edit-btn {
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-right: 5px;
        }

        .edit-btn:hover {
            background: #138496;
        }

        .search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }

        .search-result-item {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-result-item:hover {
            background: #f8f9fa;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .option-management {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .option-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .option-item:last-child {
            border-bottom: none;
        }

        .password-modal, .confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .password-modal-content, .confirm-modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .password-form {
            margin-top: 20px;
        }

        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #17a2b8;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 0.9rem;
            display: none;
            z-index: 1000;
        }

        .sync-status.syncing {
            background: #ffc107;
            color: #212529;
        }

        .sync-status.error {
            background: #dc3545;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid transparent;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-color: #bee5eb;
        }

        .menu-builder {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .menu-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .menu-item-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .menu-item-title {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .submenu-list {
            margin-left: 20px;
            margin-top: 10px;
        }

        .submenu-item {
            background: #e9ecef;
            border-radius: 3px;
            padding: 8px 12px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .calendar-container {
            display: inline-block;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
            display: none;
            position: absolute;
            z-index: 100;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-day:hover {
            background: #e9ecef;
        }

        .calendar-day.selected {
            background: #1a2a6c;
            color: white;
        }

        .calendar-day.other-month {
            color: #ccc;
        }

        .calendar-month-year {
            font-weight: bold;
        }

        .meeting-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .meeting-date {
            font-weight: bold;
            color: #1a2a6c;
        }

        .meeting-status {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-upcoming {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #e2e3e5;
            color: #383d41;
        }

        .birthday-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .birthday-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #1a2a6c;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 15px;
            overflow: hidden;
        }

        .birthday-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .birthday-days {
            margin-left: auto;
            padding: 5px 10px;
            background: #ffc107;
            border-radius: 10px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .chapter-item, .group-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chapter-info, .group-info {
            flex: 1;
        }

        .chapter-name, .group-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .chapter-details, .group-details {
            color: #6c757d;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .app-body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e9ecef;
                max-height: 200px;
            }
            
            .main-header {
                font-size: 2rem;
            }
            
            .search-section {
                flex-direction: column;
            }

            header {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container" id="logo-container">
                <span>Logo</span>
            </div>
            <div class="header-text">
                <h1 class="main-header">ASANTEMAN FETTEH KUO</h1>
                <p class="sub-header">
                    Cloud-Based Attendance Management System
                    <span class="mode-indicator local" id="mode-indicator">Local Mode</span>
                </p>
            </div>
            <div class="header-controls">
                <button class="btn btn-primary" id="sync-btn">
                    <i class="fas fa-sync-alt"></i> Sync
                </button>
            </div>
        </header>
        
        <div class="app-body">
            <div class="sidebar">
                <div class="dropdown-nav" id="sidebar-nav">
                    <!-- Dynamic sidebar content will be generated here -->
                </div>
            </div>
            
            <div class="main-content">
                <!-- Attendance Sections -->
                <div class="content-section active" id="attendance-overview">
                    <h2 class="section-header">Attendance Overview</h2>
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-label">Present Today</div>
                            <div class="stat-value" id="present-today-count">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Members</div>
                            <div class="stat-value" id="total-members-count">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Active Meetings</div>
                            <div class="stat-value" id="active-meetings-count">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Upcoming Birthdays</div>
                            <div class="stat-value" id="upcoming-birthdays-count">0</div>
                        </div>
                    </div>
                    
                    <div class="form-container">
                        <h3>Current Active Meeting</h3>
                        <div id="active-meeting-display">
                            <p>No active meeting. Create a new meeting to start attendance.</p>
                        </div>
                        <div class="controls">
                            <button class="btn btn-primary" id="create-meeting-btn">
                                <i class="fas fa-plus"></i> Create New Meeting
                            </button>
                            <button class="btn btn-success" id="view-all-members-btn">
                                <i class="fas fa-users"></i> View All Members
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="content-section" id="verify-attendance">
                    <h2 class="section-header">Verify Attendance</h2>
                    <div class="verification-container">
                        <div class="search-section">
                            <input type="text" class="search-input" id="search-input" placeholder="Enter phone number or name...">
                            <button class="btn btn-primary" id="search-btn">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                        
                        <div class="search-results" id="search-results"></div>
                        
                        <div class="profile-display" id="profile-display">
                            <div class="no-profile">No profile selected. Search for a member to verify attendance.</div>
                        </div>
                        
                        <div class="verification-status not-verified" id="verification-status">
                            NOT VERIFIED - Profile needs verification
                        </div>
                        
                        <div class="controls">
                            <button class="btn btn-success" id="verify-btn">
                                <i class="fas fa-check-circle"></i> Verify Attendance
                            </button>
                            <button class="btn btn-danger" id="clear-btn">
                                <i class="fas fa-times"></i> Clear Search
                            </button>
                        </div>
                    </div>
                    
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-label">Verified Today</div>
                            <div class="stat-value" id="verified-count">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Last Verified</div>
                            <div class="stat-value" id="last-verified">-</div>
                        </div>
                    </div>
                </div>
                
                <div class="content-section" id="view-attendance">
                    <h2 class="section-header">Today's Attendance</h2>
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-label">Present</div>
                            <div class="stat-value" id="present-count">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Members</div>
                            <div class="stat-value" id="total-users">0</div>
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <select class="dropdown-select" id="job-filter">
                            <option value="all">All Jobs</option>
                        </select>
                    </div>
                    
                    <div class="attendance-list" id="attendance-list"></div>
                </div>
                
                <div class="content-section" id="attendance-reports">
                    <h2 class="section-header">Attendance Reports</h2>
                    <div class="form-container">
                        <div class="form-group">
                            <label class="form-label">Select Date Range</label>
                            <div class="search-section">
                                <input type="date" class="form-control" id="report-start-date">
                                <input type="date" class="form-control" id="report-end-date">
                            </div>
                        </div>
                        <button class="btn btn-primary" id="generate-report-btn">
                            <i class="fas fa-chart-bar"></i> Generate Report
                        </button>
                        <div id="report-results" style="margin-top: 20px;"></div>
                    </div>
                </div>
                
                <!-- Meeting Management -->
                <div class="content-section" id="meeting-management">
                    <h2 class="section-header">Meeting Management</h2>
                    <div class="form-container">
                        <div class="form-group">
                            <label class="form-label">Create New Meeting</label>
                            <div class="search-section">
                                <input type="date" class="form-control" id="meeting-date">
                                <input type="text" class="form-control" id="meeting-title" placeholder="Meeting Title">
                                <button class="btn btn-primary" id="create-meeting-btn2">
                                    <i class="fas fa-plus"></i> Create Meeting
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-container">
                        <h3>Active Meetings</h3>
                        <div id="active-meetings-list"></div>
                        
                        <h3>Upcoming Meetings</h3>
                        <div id="upcoming-meetings-list"></div>
                        
                        <h3>Past Meetings</h3>
                        <div id="past-meetings-list"></div>
                    </div>
                </div>
                
                <!-- Members Sections -->
                <div class="content-section" id="all-members">
                    <h2 class="section-header">All Members</h2>
                    <div class="search-section">
                        <input type="text" class="search-input" id="all-members-search-input" placeholder="Search members by name or ID...">
                        <button class="btn btn-primary" id="all-members-search-btn">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                    <div id="all-members-list"></div>
                </div>
                
                <div class="content-section" id="add-member">
                    <h2 class="section-header">Add New Member</h2>
                    <div class="form-container">
                        <div class="form-group">
                            <label class="form-label" for="member-name">Full Name</label>
                            <input type="text" class="form-control" id="member-name" placeholder="Enter full name">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="member-id">ID Number</label>
                            <input type="text" class="form-control" id="member-id" placeholder="Enter ID number">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="member-phone">Phone Number</label>
                            <input type="tel" class="form-control" id="member-phone" placeholder="Enter phone number">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="member-dob">Date of Birth</label>
                            <input type="text" class="form-control" id="member-dob" placeholder="Click to select date" readonly>
                            <div class="calendar-container" id="birthday-calendar">
                                <!-- Calendar will be generated here -->
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Job Title</label>
                            <select class="dropdown-select" id="job-select">
                                <option value="">Select Job</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Hometown</label>
                            <select class="dropdown-select" id="hometown-select">
                                <option value="">Select Hometown</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tribe</label>
                            <select class="dropdown-select" id="tribe-select">
                                <option value="">Select Tribe</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Chapter</label>
                            <select class="dropdown-select" id="chapter-select">
                                <option value="">Select Chapter</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Group</label>
                            <select class="dropdown-select" id="group-select">
                                <option value="">Select Group</option>
                            </select>
                        </div>
                        
                        <div class="capture-preview" id="capture-preview">
                            <span>No profile picture</span>
                        </div>
                        
                        <div class="camera-container" id="camera-container">
                            <video id="camera-video" autoplay muted playsinline></video>
                            <div class="camera-controls">
                                <button class="btn btn-success btn-sm" id="capture-photo-btn">Capture Photo</button>
                                <button class="btn btn-danger btn-sm" id="cancel-camera-btn">Cancel</button>
                            </div>
                        </div>
                        
                        <div class="controls">
                            <button class="btn btn-primary" id="camera-btn">
                                <i class="fas fa-camera"></i> Take Photo with Camera
                            </button>
                            <button class="btn btn-warning" id="remove-photo-btn">
                                <i class="fas fa-trash"></i> Remove Photo
                            </button>
                            <button class="btn btn-success" id="save-btn">
                                <i class="fas fa-save"></i> Save Member
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="content-section" id="manage-members">
                    <h2 class="section-header">Manage Members</h2>
                    <div class="search-section">
                        <input type="text" class="search-input" id="manage-search-input" placeholder="Search members by name or ID...">
                        <button class="btn btn-primary" id="manage-search-btn">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                    <div id="user-management-list"></div>
                </div>
                
                <div class="content-section" id="member-groups">
                    <h2 class="section-header">Member Groups</h2>
                    <div class="form-container">
                        <div class="form-group">
                            <label class="form-label">Create New Group</label>
                            <div class="search-section">
                                <input type="text" class="form-control" id="new-group-name" placeholder="Enter group name">
                                <input type="text" class="form-control" id="new-group-description" placeholder="Enter group description">
                                <button class="btn btn-primary" id="create-group-btn">
                                    <i class="fas fa-plus"></i> Create Group
                                </button>
                            </div>
                        </div>
                        <div id="groups-list"></div>
                    </div>
                </div>
                
                <div class="content-section" id="birthday-reminder">
                    <h2 class="section-header">Birthday Reminder</h2>
                    <div class="form-container">
                        <div class="stats-container">
                            <div class="stat-card">
                                <div class="stat-label">This Week</div>
                                <div class="stat-value" id="birthdays-this-week">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">This Month</div>
                                <div class="stat-value" id="birthdays-this-month">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Next Month</div>
                                <div class="stat-value" id="birthdays-next-month">0</div>
                            </div>
                        </div>
                        
                        <h3>Upcoming Birthdays (Next 7 Days)</h3>
                        <div id="upcoming-birthdays-list"></div>
                        
                        <h3>All Birthdays This Month</h3>
                        <div id="month-birthdays-list"></div>
                    </div>
                </div>
                
                <!-- Settings Sections -->
                <div class="content-section" id="system-settings">
                    <h2 class="section-header">System Settings</h2>
                    <div class="sheet-config">
                        <div class="form-group">
                            <label class="form-label" for="sheet-id">Google Sheet ID</label>
                            <input type="text" class="form-control" id="sheet-id" placeholder="Enter your Google Sheet ID">
                            <small>Find this in your Google Sheet URL: https://docs.google.com/spreadsheets/d/<strong>YOUR_SHEET_ID</strong>/edit</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="script-url">Google Apps Script URL</label>
                            <input type="text" class="form-control" id="script-url" placeholder="Enter your Google Apps Script URL">
                            <small>This is the URL of your deployed Google Apps Script web app</small>
                        </div>
                        <div class="controls">
                            <button class="btn btn-primary" id="test-connection-btn">
                                <i class="fas fa-plug"></i> Test Connection
                            </button>
                            <button class="btn btn-success" id="save-settings-btn">
                                <i class="fas fa-save"></i> Save Settings
                            </button>
                            <button class="btn btn-info" id="load-data-btn">
                                <i class="fas fa-download"></i> Load Data from Sheet
                            </button>
                            <button class="btn btn-warning" id="clear-settings-btn">
                                <i class="fas fa-trash"></i> Clear Settings
                            </button>
                            <button class="btn btn-primary" id="compare-sheet-btn">
                                <i class="fas fa-exchange-alt"></i> Compare & Sync Structure
                            </button>
                            <button class="btn btn-info" id="manual-test-btn">
                                <i class="fas fa-bug"></i> Manual Test
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <h4>Database Status</h4>
                        <div id="database-status">
                            <p>No data loaded yet. Configure your Google Sheet and click "Load Data from Sheet".</p>
                        </div>
                    </div>
                </div>
                
                <div class="content-section" id="user-management">
                    <h2 class="section-header">User Management</h2>
                    <div class="form-container">
                        <div class="form-group">
                            <label class="form-label">Add New User</label>
                            <div class="search-section">
                                <input type="text" class="form-control" id="new-username" placeholder="Username">
                                <input type="password" class="form-control" id="new-password" placeholder="Password">
                                <select class="form-control" id="new-user-role">
                                    <option value="user">User</option>
                                    <option value="admin">Admin</option>
                                </select>
                                <button class="btn btn-primary" id="add-user-btn">
                                    <i class="fas fa-user-plus"></i> Add User
                                </button>
                            </div>
                        </div>
                        <div id="users-list"></div>
                    </div>
                </div>
                
                <div class="content-section" id="chapter-management">
                    <h2 class="section-header">Chapter Management</h2>
                    <div class="form-container">
                        <div class="form-group">
                            <label class="form-label">Add New Chapter</label>
                            <div class="search-section">
                                <input type="text" class="form-control" id="new-chapter-name" placeholder="Chapter Name">
                                <input type="text" class="form-control" id="new-chapter-location" placeholder="Chapter Location">
                                <input type="text" class="form-control" id="new-chapter-leader" placeholder="Chapter Leader">
                                <button class="btn btn-primary" id="add-chapter-btn">
                                    <i class="fas fa-plus"></i> Add Chapter
                                </button>
                            </div>
                        </div>
                        <div id="chapters-list"></div>
                    </div>
                </div>
                
                <div class="content-section" id="page-upgrade">
                    <h2 class="section-header">Page Upgrade</h2>
                    
                    <div class="menu-builder">
                        <h3>Menu Builder</h3>
                        <div class="form-group">
                            <label class="form-label">Add New Main Menu</label>
                            <div class="search-section">
                                <input type="text" class="form-control" id="new-menu-name" placeholder="Menu Name">
                                <input type="text" class="form-control" id="new-menu-icon" placeholder="Icon (e.g., fas fa-home)">
                                <button class="btn btn-primary" id="add-menu-btn">
                                    <i class="fas fa-plus"></i> Add Menu
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Add Submenu to Selected Menu</label>
                            <div class="search-section">
                                <select class="form-control" id="parent-menu-select">
                                    <option value="">Select Parent Menu</option>
                                </select>
                                <input type="text" class="form-control" id="new-submenu-name" placeholder="Submenu Name">
                                <input type="text" class="form-control" id="new-submenu-icon" placeholder="Icon (e.g., fas fa-list)">
                                <input type="text" class="form-control" id="new-submenu-section" placeholder="Section ID">
                                <button class="btn btn-primary" id="add-submenu-btn">
                                    <i class="fas fa-plus"></i> Add Submenu
                                </button>
                            </div>
                        </div>
                        
                        <div id="menu-structure">
                            <h4>Current Menu Structure</h4>
                            <div id="menu-list"></div>
                        </div>
                    </div>
                    
                    <div class="option-management">
                        <h3>Manage Dropdown Options</h3>
                        <div class="form-group">
                            <label class="form-label">Select Option Category</label>
                            <select class="dropdown-select" id="option-category">
                                <option value="jobs">Job Titles</option>
                                <option value="hometowns">Hometowns</option>
                                <option value="tribes">Tribes</option>
                                <option value="departments">Departments</option>
                                <option value="positions">Positions</option>
                                <option value="chapters">Chapters</option>
                                <option value="groups">Groups</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Add New Option</label>
                            <div class="search-section">
                                <input type="text" class="search-input" id="new-option-input" placeholder="Enter new option...">
                                <button class="btn btn-primary" id="add-option-btn">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Current Options</label>
                            <div id="options-list"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div class="password-modal" id="password-modal">
        <div class="password-modal-content">
            <h2>Enter Password</h2>
            <p>Please enter the password to access the Settings tab.</p>
            <div class="password-form">
                <div class="form-group">
                    <input type="password" class="form-control" id="password-input" placeholder="Enter password">
                </div>
                <div class="controls">
                    <button class="btn btn-success" id="submit-password-btn">Submit</button>
                    <button class="btn btn-danger" id="cancel-password-btn">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="confirm-modal" id="confirm-modal">
        <div class="confirm-modal-content">
            <h2>Confirm Deletion</h2>
            <p id="confirm-message">Are you sure you want to delete this member?</p>
            <div class="controls">
                <button class="btn btn-success" id="confirm-yes-btn">Yes</button>
                <button class="btn btn-danger" id="confirm-no-btn">No</button>
            </div>
        </div>
    </div>

    <!-- Sync Status Indicator -->
    <div class="sync-status" id="sync-status">Sync: Ready</div>

    <script>
        // Global variables
        let members = [];
        let attendance = [];
        let meetings = [];
        let currentSelectedMember = null;
        let currentCapture = null;
        let currentEditingMember = null;
        let availableJobs = ['Farmer', 'Teacher', 'Trader', 'Driver', 'Nurse'];
        let availableHometowns = ['Accra', 'Kumasi', 'Cape Coast', 'Takoradi', 'Tamale'];
        let availableTribes = ['Akan', 'Ewe', 'Ga', 'Dagomba', 'Fante'];
        let availableDepartments = ['General', 'Education', 'Commerce', 'Health', 'Agriculture'];
        let availablePositions = ['Member', 'Leader', 'Secretary', 'Treasurer', 'Organizer'];
        let availableChapters = []; // Start with empty chapters
        let availableGroups = []; // Start with empty groups
        let cameraStream = null;
        let settingsPassword = "admin123";
        let users = [
            { username: 'admin', password: 'admin123', role: 'admin' },
            { username: 'user', password: 'user123', role: 'user' }
        ];

        // Menu structure
        let menuStructure = [
            {
                id: 'attendance',
                name: 'Attendance',
                icon: 'fas fa-clipboard-check',
                submenus: [
                    { id: 'attendance-overview', name: 'Attendance Overview', icon: 'fas fa-home' },
                    { id: 'verify-attendance', name: 'Verify Attendance', icon: 'fas fa-user-check' },
                    { id: 'view-attendance', name: "View Today's Attendance", icon: 'fas fa-list' },
                    { id: 'attendance-reports', name: 'Attendance Reports', icon: 'fas fa-chart-bar' },
                    { id: 'meeting-management', name: 'Meeting Management', icon: 'fas fa-calendar-alt' }
                ]
            },
            {
                id: 'members',
                name: 'Members',
                icon: 'fas fa-users',
                submenus: [
                    { id: 'all-members', name: 'All Members', icon: 'fas fa-users' },
                    { id: 'add-member', name: 'Add Member', icon: 'fas fa-user-plus' },
                    { id: 'manage-members', name: 'Manage Members', icon: 'fas fa-user-edit' },
                    { id: 'member-groups', name: 'Member Groups', icon: 'fas fa-object-group' },
                    { id: 'birthday-reminder', name: 'Birthday Reminder', icon: 'fas fa-birthday-cake' }
                ]
            },
            {
                id: 'settings',
                name: 'Settings',
                icon: 'fas fa-cog',
                submenus: [
                    { id: 'system-settings', name: 'System Settings', icon: 'fas fa-sliders-h' },
                    { id: 'user-management', name: 'User Management', icon: 'fas fa-user-shield' },
                    { id: 'chapter-management', name: 'Chapter Management', icon: 'fas fa-sitemap' },
                    { id: 'page-upgrade', name: 'Page Upgrade', icon: 'fas fa-wrench' }
                ]
            }
        ];

        // Default URLs - user can change these
        let SCRIPT_URL = '';
        let SHEET_ID = '';
        let isCloudMode = false;

        // DOM Elements
        const dropdownItems = document.querySelectorAll('.dropdown-item');
        const dropdownBtns = document.querySelectorAll('.dropdown-btn');
        const subTabs = document.querySelectorAll('.sub-tab');
        const contentSections = document.querySelectorAll('.content-section');
        const sidebarNav = document.getElementById('sidebar-nav');
        const modeIndicator = document.getElementById('mode-indicator');
        
        // Attendance elements
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const searchResults = document.getElementById('search-results');
        const profileDisplay = document.getElementById('profile-display');
        const verificationStatus = document.getElementById('verification-status');
        const clearBtn = document.getElementById('clear-btn');
        const verifyBtn = document.getElementById('verify-btn');
        const attendanceList = document.getElementById('attendance-list');
        const userManagementList = document.getElementById('user-management-list');
        const presentCountEl = document.getElementById('present-count');
        const totalUsersEl = document.getElementById('total-users');
        const verifiedCountEl = document.getElementById('verified-count');
        const lastVerifiedEl = document.getElementById('last-verified');
        const jobFilter = document.getElementById('job-filter');
        
        // Member elements
        const memberNameInput = document.getElementById('member-name');
        const memberIdInput = document.getElementById('member-id');
        const memberPhoneInput = document.getElementById('member-phone');
        const memberDobInput = document.getElementById('member-dob');
        const capturePreview = document.getElementById('capture-preview');
        const cameraBtn = document.getElementById('camera-btn');
        const saveBtn = document.getElementById('save-btn');
        const jobSelect = document.getElementById('job-select');
        const hometownSelect = document.getElementById('hometown-select');
        const tribeSelect = document.getElementById('tribe-select');
        const chapterSelect = document.getElementById('chapter-select');
        const groupSelect = document.getElementById('group-select');
        const cameraContainer = document.getElementById('camera-container');
        const cameraVideo = document.getElementById('camera-video');
        const capturePhotoBtn = document.getElementById('capture-photo-btn');
        const cancelCameraBtn = document.getElementById('cancel-camera-btn');
        const manageSearchInput = document.getElementById('manage-search-input');
        const manageSearchBtn = document.getElementById('manage-search-btn');
        const removePhotoBtn = document.getElementById('remove-photo-btn');
        const allMembersSearchInput = document.getElementById('all-members-search-input');
        const allMembersSearchBtn = document.getElementById('all-members-search-btn');
        const allMembersList = document.getElementById('all-members-list');
        
        // Meeting elements
        const meetingDateInput = document.getElementById('meeting-date');
        const meetingTitleInput = document.getElementById('meeting-title');
        const createMeetingBtn = document.getElementById('create-meeting-btn');
        const createMeetingBtn2 = document.getElementById('create-meeting-btn2');
        const activeMeetingDisplay = document.getElementById('active-meeting-display');
        const activeMeetingsList = document.getElementById('active-meetings-list');
        const upcomingMeetingsList = document.getElementById('upcoming-meetings-list');
        const pastMeetingsList = document.getElementById('past-meetings-list');
        
        // Birthday elements
        const birthdayCalendar = document.getElementById('birthday-calendar');
        const upcomingBirthdaysList = document.getElementById('upcoming-birthdays-list');
        const monthBirthdaysList = document.getElementById('month-birthdays-list');
        const birthdaysThisWeekEl = document.getElementById('birthdays-this-week');
        const birthdaysThisMonthEl = document.getElementById('birthdays-this-month');
        const birthdaysNextMonthEl = document.getElementById('birthdays-next-month');
        
        // Settings elements
        const sheetIdInput = document.getElementById('sheet-id');
        const scriptUrlInput = document.getElementById('script-url');
        const testConnectionBtn = document.getElementById('test-connection-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const loadDataBtn = document.getElementById('load-data-btn');
        const clearSettingsBtn = document.getElementById('clear-settings-btn');
        const compareSheetBtn = document.getElementById('compare-sheet-btn');
        const manualTestBtn = document.getElementById('manual-test-btn');
        const databaseStatus = document.getElementById('database-status');
        
        // Page Upgrade elements
        const optionCategory = document.getElementById('option-category');
        const newOptionInput = document.getElementById('new-option-input');
        const addOptionBtn = document.getElementById('add-option-btn');
        const optionsList = document.getElementById('options-list');
        
        // Menu Builder elements
        const newMenuName = document.getElementById('new-menu-name');
        const newMenuIcon = document.getElementById('new-menu-icon');
        const addMenuBtn = document.getElementById('add-menu-btn');
        const parentMenuSelect = document.getElementById('parent-menu-select');
        const newSubmenuName = document.getElementById('new-submenu-name');
        const newSubmenuIcon = document.getElementById('new-submenu-icon');
        const newSubmenuSection = document.getElementById('new-submenu-section');
        const addSubmenuBtn = document.getElementById('add-submenu-btn');
        const menuList = document.getElementById('menu-list');
        
        // Chapter Management elements
        const newChapterName = document.getElementById('new-chapter-name');
        const newChapterLocation = document.getElementById('new-chapter-location');
        const newChapterLeader = document.getElementById('new-chapter-leader');
        const addChapterBtn = document.getElementById('add-chapter-btn');
        const chaptersList = document.getElementById('chapters-list');
        
        // Group Management elements
        const newGroupName = document.getElementById('new-group-name');
        const newGroupDescription = document.getElementById('new-group-description');
        const createGroupBtn = document.getElementById('create-group-btn');
        const groupsList = document.getElementById('groups-list');
        
        // Password modal elements
        const passwordModal = document.getElementById('password-modal');
        const passwordInput = document.getElementById('password-input');
        const submitPasswordBtn = document.getElementById('submit-password-btn');
        const cancelPasswordBtn = document.getElementById('cancel-password-btn');
        
        // Confirmation modal elements
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');
        
        // Sync elements
        const syncBtn = document.getElementById('sync-btn');
        const syncStatus = document.getElementById('sync-status');
        
        // Overview elements
        const presentTodayCountEl = document.getElementById('present-today-count');
        const totalMembersCountEl = document.getElementById('total-members-count');
        const activeMeetingsCountEl = document.getElementById('active-meetings-count');
        const upcomingBirthdaysCountEl = document.getElementById('upcoming-birthdays-count');
        const viewAllMembersBtn = document.getElementById('view-all-members-btn');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            updateUI();
        });

        function initializeApp() {
            loadSettings();
            setupLogoUpload();
            updateDropdowns();
            loadDataFromLocalStorage();
            generateSidebar();
            updateMenuBuilder();
            renderChaptersList();
            renderGroupsList();
            updateModeIndicator();
        }

        function updateModeIndicator() {
            if (isCloudMode && SHEET_ID && SCRIPT_URL) {
                modeIndicator.textContent = "Cloud Mode";
                modeIndicator.className = "mode-indicator cloud";
            } else {
                modeIndicator.textContent = "Local Mode";
                modeIndicator.className = "mode-indicator local";
            }
        }

        function generateSidebar() {
            sidebarNav.innerHTML = '';
            
            menuStructure.forEach(menu => {
                const menuItem = document.createElement('div');
                menuItem.className = 'dropdown-item';
                menuItem.innerHTML = `
                    <button class="dropdown-btn" data-tab="${menu.id}">
                        <i class="${menu.icon}"></i> ${menu.name}
                    </button>
                    <div class="dropdown-content">
                        ${menu.submenus.map(submenu => `
                            <button class="sub-tab" data-section="${submenu.id}">
                                <i class="${submenu.icon}"></i> ${submenu.name}
                            </button>
                        `).join('')}
                    </div>
                `;
                sidebarNav.appendChild(menuItem);
            });
            
            // Reattach event listeners for the dynamic sidebar
            attachSidebarEventListeners();
        }

        function attachSidebarEventListeners() {
            // Dropdown navigation
            const dropdownBtns = document.querySelectorAll('.dropdown-btn');
            const subTabs = document.querySelectorAll('.sub-tab');
            
            dropdownBtns.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    const tabId = this.getAttribute('data-tab');
                    const parentItem = this.closest('.dropdown-item');
                    
                    if (tabId === 'settings') {
                        passwordModal.style.display = 'flex';
                        return;
                    }
                    
                    dropdownItems.forEach(item => {
                        if (item !== parentItem) {
                            item.classList.remove('active');
                            const btn = item.querySelector('.dropdown-btn');
                            if (btn) btn.classList.remove('active');
                        }
                    });
                    
                    parentItem.classList.toggle('active');
                    this.classList.toggle('active');
                    
                    if (parentItem.classList.contains('active')) {
                        const firstSubTab = parentItem.querySelector('.sub-tab');
                        if (firstSubTab) {
                            const sectionId = firstSubTab.getAttribute('data-section');
                            switchContentSection(sectionId);
                            
                            subTabs.forEach(t => t.classList.remove('active'));
                            firstSubTab.classList.add('active');
                        }
                    }
                });
            });
            
            // Sub tab navigation
            subTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const sectionId = this.getAttribute('data-section');
                    switchContentSection(sectionId);
                    
                    subTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        function updateMenuBuilder() {
            // Update parent menu select
            parentMenuSelect.innerHTML = '<option value="">Select Parent Menu</option>';
            menuStructure.forEach(menu => {
                const option = document.createElement('option');
                option.value = menu.id;
                option.textContent = menu.name;
                parentMenuSelect.appendChild(option);
            });
            
            // Update menu list display
            menuList.innerHTML = '';
            menuStructure.forEach(menu => {
                const menuItem = document.createElement('div');
                menuItem.className = 'menu-item';
                menuItem.innerHTML = `
                    <div class="menu-item-header">
                        <div class="menu-item-title">
                            <i class="${menu.icon}"></i> ${menu.name}
                        </div>
                        <button class="btn btn-danger btn-sm delete-menu-btn" data-menu="${menu.id}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                    <div class="submenu-list">
                        ${menu.submenus.map(submenu => `
                            <div class="submenu-item">
                                <div>
                                    <i class="${submenu.icon}"></i> ${submenu.name} (${submenu.id})
                                </div>
                                <button class="btn btn-danger btn-sm delete-submenu-btn" data-menu="${menu.id}" data-submenu="${submenu.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
                menuList.appendChild(menuItem);
            });
            
            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-menu-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const menuId = this.getAttribute('data-menu');
                    deleteMenu(menuId);
                });
            });
            
            document.querySelectorAll('.delete-submenu-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const menuId = this.getAttribute('data-menu');
                    const submenuId = this.getAttribute('data-submenu');
                    deleteSubmenu(menuId, submenuId);
                });
            });
        }

        function addNewMenu() {
            const name = newMenuName.value.trim();
            const icon = newMenuIcon.value.trim();
            
            if (!name) {
                showAlert('Please enter a menu name', 'error');
                return;
            }
            
            if (!icon) {
                showAlert('Please enter an icon class', 'error');
                return;
            }
            
            const newMenu = {
                id: name.toLowerCase().replace(/\s+/g, '-'),
                name: name,
                icon: icon,
                submenus: []
            };
            
            menuStructure.push(newMenu);
            saveMenuStructure();
            generateSidebar();
            updateMenuBuilder();
            
            newMenuName.value = '';
            newMenuIcon.value = '';
            
            showAlert(`Menu "${name}" added successfully`, 'success');
        }

        function addNewSubmenu() {
            const parentMenuId = parentMenuSelect.value;
            const name = newSubmenuName.value.trim();
            const icon = newSubmenuIcon.value.trim();
            const section = newSubmenuSection.value.trim();
            
            if (!parentMenuId) {
                showAlert('Please select a parent menu', 'error');
                return;
            }
            
            if (!name || !section) {
                showAlert('Please enter both submenu name and section ID', 'error');
                return;
            }
            
            const parentMenu = menuStructure.find(menu => menu.id === parentMenuId);
            if (!parentMenu) {
                showAlert('Parent menu not found', 'error');
                return;
            }
            
            const newSubmenu = {
                id: section,
                name: name,
                icon: icon || 'fas fa-circle'
            };
            
            parentMenu.submenus.push(newSubmenu);
            saveMenuStructure();
            generateSidebar();
            updateMenuBuilder();
            
            newSubmenuName.value = '';
            newSubmenuIcon.value = '';
            newSubmenuSection.value = '';
            
            showAlert(`Submenu "${name}" added to "${parentMenu.name}"`, 'success');
        }

        function deleteMenu(menuId) {
            if (menuId === 'attendance' || menuId === 'members' || menuId === 'settings') {
                showAlert('Cannot delete core menus', 'error');
                return;
            }
            
            showConfirmModal('Are you sure you want to delete this menu and all its submenus?', function() {
                menuStructure = menuStructure.filter(menu => menu.id !== menuId);
                saveMenuStructure();
                generateSidebar();
                updateMenuBuilder();
                showAlert('Menu deleted successfully', 'success');
            });
        }

        function deleteSubmenu(menuId, submenuId) {
            showConfirmModal('Are you sure you want to delete this submenu?', function() {
                const menu = menuStructure.find(menu => menu.id === menuId);
                if (menu) {
                    menu.submenus = menu.submenus.filter(submenu => submenu.id !== submenuId);
                    saveMenuStructure();
                    generateSidebar();
                    updateMenuBuilder();
                    showAlert('Submenu deleted successfully', 'success');
                }
            });
        }

        function saveMenuStructure() {
            localStorage.setItem('asantemanMenuStructure', JSON.stringify(menuStructure));
        }

        function loadMenuStructure() {
            const savedMenuStructure = localStorage.getItem('asantemanMenuStructure');
            if (savedMenuStructure) {
                menuStructure = JSON.parse(savedMenuStructure);
            }
        }

        function showConfirmModal(message, callback) {
            confirmMessage.textContent = message;
            confirmModal.style.display = 'flex';
            
            // Remove previous event listeners
            confirmYesBtn.replaceWith(confirmYesBtn.cloneNode(true));
            confirmNoBtn.replaceWith(confirmNoBtn.cloneNode(true));
            
            // Get new references
            const newConfirmYesBtn = document.getElementById('confirm-yes-btn');
            const newConfirmNoBtn = document.getElementById('confirm-no-btn');
            
            newConfirmYesBtn.addEventListener('click', function() {
                confirmModal.style.display = 'none';
                callback();
            });
            
            newConfirmNoBtn.addEventListener('click', function() {
                confirmModal.style.display = 'none';
            });
        }

        function loadSettings() {
            try {
                loadMenuStructure();
                
                const savedSheetId = localStorage.getItem('asantemanSheetId');
                const savedScriptUrl = localStorage.getItem('asantemanScriptUrl');
                const savedPassword = localStorage.getItem('asantemanPassword');
                const savedCloudMode = localStorage.getItem('asantemanCloudMode');
                
                if (savedSheetId) {
                    SHEET_ID = savedSheetId;
                    sheetIdInput.value = savedSheetId;
                }
                
                if (savedScriptUrl) {
                    SCRIPT_URL = savedScriptUrl;
                    scriptUrlInput.value = savedScriptUrl;
                }
                
                if (savedPassword) {
                    settingsPassword = savedPassword;
                }
                
                if (savedCloudMode) {
                    isCloudMode = savedCloudMode === 'true';
                }
                
                updateSyncStatus('ready', 'Settings loaded');
                
                if (savedSheetId && savedScriptUrl) {
                    updateDatabaseStatus(`Settings loaded: Sheet ID and URL configured`);
                } else {
                    updateDatabaseStatus('Running in local mode. Configure Google Sheet for cloud sync.');
                }
                
            } catch (error) {
                console.error('Error loading settings:', error);
                updateSyncStatus('error', 'Error loading settings');
            }
        }

        function saveSettings() {
            const sheetId = sheetIdInput.value.trim();
            const scriptUrl = scriptUrlInput.value.trim();
            
            SHEET_ID = sheetId;
            SCRIPT_URL = scriptUrl;
            
            try {
                localStorage.setItem('asantemanSheetId', sheetId);
                localStorage.setItem('asantemanScriptUrl', scriptUrl);
                
                showAlert('Settings saved successfully', 'success');
                updateSyncStatus('success', 'Settings saved');
                
                if (sheetId && scriptUrl) {
                    updateDatabaseStatus(`Settings saved: ${sheetId}`);
                } else {
                    updateDatabaseStatus('Running in local mode. Configure Google Sheet for cloud sync.');
                }
                return true;
            } catch (error) {
                console.error('Error saving settings:', error);
                showAlert('Error saving settings to localStorage', 'error');
                return false;
            }
        }

        function clearSettings() {
            showConfirmModal('Are you sure you want to clear all settings?', function() {
                localStorage.removeItem('asantemanSheetId');
                localStorage.removeItem('asantemanScriptUrl');
                localStorage.removeItem('asantemanPassword');
                localStorage.removeItem('asantemanMembers');
                localStorage.removeItem('asantemanAttendance');
                localStorage.removeItem('asantemanJobs');
                localStorage.removeItem('asantemanHometowns');
                localStorage.removeItem('asantemanTribes');
                localStorage.removeItem('asantemanLogo');
                localStorage.removeItem('asantemanLastSync');
                localStorage.removeItem('asantemanMenuStructure');
                localStorage.removeItem('asantemanChapters');
                localStorage.removeItem('asantemanGroups');
                localStorage.removeItem('asantemanMeetings');
                localStorage.removeItem('asantemanCloudMode');
                
                sheetIdInput.value = '';
                scriptUrlInput.value = '';
                SHEET_ID = '';
                SCRIPT_URL = '';
                isCloudMode = false;
                
                // Reset to default menu structure
                menuStructure = [
                    {
                        id: 'attendance',
                        name: 'Attendance',
                        icon: 'fas fa-clipboard-check',
                        submenus: [
                            { id: 'attendance-overview', name: 'Attendance Overview', icon: 'fas fa-home' },
                            { id: 'verify-attendance', name: 'Verify Attendance', icon: 'fas fa-user-check' },
                            { id: 'view-attendance', name: "View Today's Attendance", icon: 'fas fa-list' },
                            { id: 'attendance-reports', name: 'Attendance Reports', icon: 'fas fa-chart-bar' },
                            { id: 'meeting-management', name: 'Meeting Management', icon: 'fas fa-calendar-alt' }
                        ]
                    },
                    {
                        id: 'members',
                        name: 'Members',
                        icon: 'fas fa-users',
                        submenus: [
                            { id: 'all-members', name: 'All Members', icon: 'fas fa-users' },
                            { id: 'add-member', name: 'Add Member', icon: 'fas fa-user-plus' },
                            { id: 'manage-members', name: 'Manage Members', icon: 'fas fa-user-edit' },
                            { id: 'member-groups', name: 'Member Groups', icon: 'fas fa-object-group' },
                            { id: 'birthday-reminder', name: 'Birthday Reminder', icon: 'fas fa-birthday-cake' }
                        ]
                    },
                    {
                        id: 'settings',
                        name: 'Settings',
                        icon: 'fas fa-cog',
                        submenus: [
                            { id: 'system-settings', name: 'System Settings', icon: 'fas fa-sliders-h' },
                            { id: 'user-management', name: 'User Management', icon: 'fas fa-user-shield' },
                            { id: 'chapter-management', name: 'Chapter Management', icon: 'fas fa-sitemap' },
                            { id: 'page-upgrade', name: 'Page Upgrade', icon: 'fas fa-wrench' }
                        ]
                    }
                ];
                
                generateSidebar();
                updateMenuBuilder();
                updateModeIndicator();
                
                showAlert('All settings cleared successfully', 'success');
                updateDatabaseStatus('Settings cleared. Running in local mode.');
            });
        }

        function setupLogoUpload() {
            const logoContainer = document.getElementById('logo-container');
            logoContainer.addEventListener('click', function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            logoContainer.innerHTML = `<img src="${event.target.result}" alt="Logo">`;
                            localStorage.setItem('asantemanLogo', event.target.result);
                        };
                        reader.readAsDataURL(file);
                    }
                };
                input.click();
            });
            
            const savedLogo = localStorage.getItem('asantemanLogo');
            if (savedLogo) {
                logoContainer.innerHTML = `<img src="${savedLogo}" alt="Logo">`;
            }
        }

        function setupEventListeners() {
            // Dropdown navigation
            dropdownBtns.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    const tabId = this.getAttribute('data-tab');
                    const parentItem = this.closest('.dropdown-item');
                    
                    if (tabId === 'settings') {
                        passwordModal.style.display = 'flex';
                        return;
                    }
                    
                    dropdownItems.forEach(item => {
                        if (item !== parentItem) {
                            item.classList.remove('active');
                            const btn = item.querySelector('.dropdown-btn');
                            if (btn) btn.classList.remove('active');
                        }
                    });
                    
                    parentItem.classList.toggle('active');
                    this.classList.toggle('active');
                    
                    if (parentItem.classList.contains('active')) {
                        const firstSubTab = parentItem.querySelector('.sub-tab');
                        if (firstSubTab) {
                            const sectionId = firstSubTab.getAttribute('data-section');
                            switchContentSection(sectionId);
                            
                            subTabs.forEach(t => t.classList.remove('active'));
                            firstSubTab.classList.add('active');
                        }
                    }
                });
            });
            
            // Sub tab navigation
            subTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const sectionId = this.getAttribute('data-section');
                    switchContentSection(sectionId);
                    
                    subTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function() {
                dropdownItems.forEach(item => {
                    item.classList.remove('active');
                    const btn = item.querySelector('.dropdown-btn');
                    if (btn) btn.classList.remove('active');
                });
            });
            
            // Password modal
            submitPasswordBtn.addEventListener('click', checkPassword);
            cancelPasswordBtn.addEventListener('click', () => {
                passwordModal.style.display = 'none';
                passwordInput.value = '';
            });
            
            // Search functionality
            searchBtn.addEventListener('click', performSearch);
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch();
            });
            
            // Verification buttons
            verifyBtn.addEventListener('click', verifyAttendance);
            clearBtn.addEventListener('click', clearSearch);
            
            // Member management
            cameraBtn.addEventListener('click', startCamera);
            saveBtn.addEventListener('click', saveMember);
            removePhotoBtn.addEventListener('click', removeProfilePicture);
            
            // Camera functionality
            capturePhotoBtn.addEventListener('click', capturePhoto);
            cancelCameraBtn.addEventListener('click', stopCamera);
            
            // Filter functionality
            jobFilter.addEventListener('change', updateUI);
            
            // Settings functionality
            testConnectionBtn.addEventListener('click', testConnection);
            saveSettingsBtn.addEventListener('click', saveSettings);
            loadDataBtn.addEventListener('click', loadDataFromCloud);
            clearSettingsBtn.addEventListener('click', clearSettings);
            compareSheetBtn.addEventListener('click', compareAndSyncSheetStructure);
            manualTestBtn.addEventListener('click', manualConnectionTest);
            
            // Page upgrade functionality
            optionCategory.addEventListener('change', updateOptionsList);
            addOptionBtn.addEventListener('click', addNewOption);
            
            // Menu builder functionality
            addMenuBtn.addEventListener('click', addNewMenu);
            addSubmenuBtn.addEventListener('click', addNewSubmenu);
            
            // Sync functionality
            syncBtn.addEventListener('click', syncDataToCloud);
            
            // Member search
            manageSearchBtn.addEventListener('click', performManageSearch);
            manageSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performManageSearch();
            });
            
            // All members search
            allMembersSearchBtn.addEventListener('click', performAllMembersSearch);
            allMembersSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performAllMembersSearch();
            });
            
            // Report generation
            document.getElementById('generate-report-btn').addEventListener('click', generateReport);
            
            // User management
            document.getElementById('add-user-btn').addEventListener('click', addNewUser);
            
            // Chapter management
            addChapterBtn.addEventListener('click', addNewChapter);
            
            // Group management
            createGroupBtn.addEventListener('click', createNewGroup);
            
            // Meeting management
            createMeetingBtn.addEventListener('click', createNewMeeting);
            createMeetingBtn2.addEventListener('click', createNewMeeting);
            
            // View all members button
            viewAllMembersBtn.addEventListener('click', function() {
                switchContentSection('all-members');
                subTabs.forEach(t => t.classList.remove('active'));
                document.querySelector('.sub-tab[data-section="all-members"]').classList.add('active');
            });
            
            // Date of Birth calendar
            memberDobInput.addEventListener('click', function() {
                const rect = this.getBoundingClientRect();
                birthdayCalendar.style.display = 'block';
                birthdayCalendar.style.top = (rect.bottom + window.scrollY) + 'px';
                birthdayCalendar.style.left = (rect.left + window.scrollX) + 'px';
                generateCalendar();
            });
            
            // Close calendar when clicking outside
            document.addEventListener('click', function(e) {
                if (!birthdayCalendar.contains(e.target) && e.target !== memberDobInput) {
                    birthdayCalendar.style.display = 'none';
                }
            });
        }

        function switchContentSection(sectionId) {
            contentSections.forEach(section => section.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            
            // Special handling for certain sections
            if (sectionId === 'all-members') {
                renderAllMembersList();
            } else if (sectionId === 'meeting-management') {
                renderMeetings();
            } else if (sectionId === 'birthday-reminder') {
                renderBirthdayReminders();
            } else if (sectionId === 'attendance-overview') {
                updateOverview();
            } else if (sectionId === 'chapter-management') {
                renderChaptersList();
            } else if (sectionId === 'member-groups') {
                renderGroupsList();
            }
        }

        function checkPassword() {
            const enteredPassword = passwordInput.value;
            
            if (enteredPassword === settingsPassword) {
                passwordModal.style.display = 'none';
                passwordInput.value = '';
                
                dropdownItems.forEach(item => {
                    item.classList.remove('active');
                    const btn = item.querySelector('.dropdown-btn');
                    if (btn) btn.classList.remove('active');
                });
                
                const settingsItem = document.querySelector('.dropdown-item:has(.dropdown-btn[data-tab="settings"])');
                const settingsBtn = settingsItem.querySelector('.dropdown-btn');
                settingsItem.classList.add('active');
                settingsBtn.classList.add('active');
                
                const firstSubTab = settingsItem.querySelector('.sub-tab');
                if (firstSubTab) {
                    const sectionId = firstSubTab.getAttribute('data-section');
                    switchContentSection(sectionId);
                    
                    subTabs.forEach(t => t.classList.remove('active'));
                    firstSubTab.classList.add('active');
                }
            } else {
                showAlert('Incorrect password. Please try again.', 'error');
                passwordInput.value = '';
            }
        }

        function updateDropdowns() {
            updateSelectOptions(jobSelect, availableJobs);
            updateSelectOptions(jobFilter, availableJobs);
            updateSelectOptions(hometownSelect, availableHometowns);
            updateSelectOptions(tribeSelect, availableTribes);
            updateSelectOptions(chapterSelect, availableChapters);
            updateSelectOptions(groupSelect, availableGroups);
            updateOptionsList();
        }

        function updateSelectOptions(selectElement, options) {
            while (selectElement.options.length > 1) {
                selectElement.remove(1);
            }
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                selectElement.appendChild(optionElement);
            });
        }

        function updateOptionsList() {
            const category = optionCategory.value;
            let optionsArray;
            
            switch(category) {
                case 'jobs': optionsArray = availableJobs; break;
                case 'hometowns': optionsArray = availableHometowns; break;
                case 'tribes': optionsArray = availableTribes; break;
                case 'departments': optionsArray = availableDepartments; break;
                case 'positions': optionsArray = availablePositions; break;
                case 'chapters': optionsArray = availableChapters; break;
                case 'groups': optionsArray = availableGroups; break;
                default: optionsArray = [];
            }
            
            optionsList.innerHTML = '';
            
            if (optionsArray.length === 0) {
                optionsList.innerHTML = '<p>No options available.</p>';
                return;
            }
            
            optionsArray.forEach(option => {
                const optionItem = document.createElement('div');
                optionItem.className = 'option-item';
                optionItem.innerHTML = `
                    <span>${option}</span>
                    <button class="btn btn-danger btn-sm delete-option-btn" data-option="${option}">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                `;
                optionsList.appendChild(optionItem);
            });
            
            document.querySelectorAll('.delete-option-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const optionToDelete = this.getAttribute('data-option');
                    deleteOption(optionToDelete);
                });
            });
        }

        function addNewOption() {
            const newOption = newOptionInput.value.trim();
            const category = optionCategory.value;
            
            if (!newOption) {
                showAlert('Please enter an option value.', 'error');
                return;
            }
            
            let optionsArray;
            let optionName;
            
            switch(category) {
                case 'jobs': optionsArray = availableJobs; optionName = 'job title'; break;
                case 'hometowns': optionsArray = availableHometowns; optionName = 'hometown'; break;
                case 'tribes': optionsArray = availableTribes; optionName = 'tribe'; break;
                case 'departments': optionsArray = availableDepartments; optionName = 'department'; break;
                case 'positions': optionsArray = availablePositions; optionName = 'position'; break;
                case 'chapters': optionsArray = availableChapters; optionName = 'chapter'; break;
                case 'groups': optionsArray = availableGroups; optionName = 'group'; break;
                default: return;
            }
            
            if (optionsArray.includes(newOption)) {
                showAlert(`This ${optionName} already exists.`, 'error');
                return;
            }
            
            optionsArray.push(newOption);
            saveOptionsToLocalStorage();
            updateDropdowns();
            newOptionInput.value = '';
            showAlert(`${optionName} "${newOption}" added successfully.`, 'success');
        }

        function deleteOption(option) {
            const category = optionCategory.value;
            
            let optionsArray;
            let optionName;
            
            switch(category) {
                case 'jobs': optionsArray = availableJobs; optionName = 'job title'; break;
                case 'hometowns': optionsArray = availableHometowns; optionName = 'hometown'; break;
                case 'tribes': optionsArray = availableTribes; optionName = 'tribe'; break;
                case 'departments': optionsArray = availableDepartments; optionName = 'department'; break;
                case 'positions': optionsArray = availablePositions; optionName = 'position'; break;
                case 'chapters': optionsArray = availableChapters; optionName = 'chapter'; break;
                case 'groups': optionsArray = availableGroups; optionName = 'group'; break;
                default: return;
            }
            
            const index = optionsArray.indexOf(option);
            if (index !== -1) {
                showConfirmModal(`Are you sure you want to delete the ${optionName} "${option}"?`, function() {
                    optionsArray.splice(index, 1);
                    saveOptionsToLocalStorage();
                    updateDropdowns();
                    showAlert(`${optionName} "${option}" deleted successfully.`, 'success');
                });
            }
        }

        function generateCalendar() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // Get first day of month and number of days
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();
            
            // Month names
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];
            
            // Generate calendar HTML
            let calendarHTML = `
                <div class="calendar-header">
                    <button class="btn btn-sm btn-primary" id="prev-month"><i class="fas fa-chevron-left"></i></button>
                    <div class="calendar-month-year">${monthNames[currentMonth]} ${currentYear}</div>
                    <button class="btn btn-sm btn-primary" id="next-month"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-grid">
                    <div class="calendar-day" style="font-weight:bold">Sun</div>
                    <div class="calendar-day" style="font-weight:bold">Mon</div>
                    <div class="calendar-day" style="font-weight:bold">Tue</div>
                    <div class="calendar-day" style="font-weight:bold">Wed</div>
                    <div class="calendar-day" style="font-weight:bold">Thu</div>
                    <div class="calendar-day" style="font-weight:bold">Fri</div>
                    <div class="calendar-day" style="font-weight:bold">Sat</div>
            `;
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < startingDay; i++) {
                calendarHTML += `<div class="calendar-day other-month"></div>`;
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear();
                calendarHTML += `<div class="calendar-day ${isToday ? 'selected' : ''}" data-day="${day}" data-month="${currentMonth + 1}">${day}</div>`;
            }
            
            calendarHTML += `</div>`;
            birthdayCalendar.innerHTML = calendarHTML;
            
            // Add event listeners for day selection
            document.querySelectorAll('.calendar-day[data-day]').forEach(day => {
                day.addEventListener('click', function() {
                    document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    const selectedDay = this.getAttribute('data-day');
                    const selectedMonth = this.getAttribute('data-month');
                    memberDobInput.value = `${selectedMonth}/${selectedDay}`;
                    birthdayCalendar.style.display = 'none';
                });
            });
            
            // Add event listeners for month navigation
            document.getElementById('prev-month').addEventListener('click', function() {
                // For simplicity, we'll just regenerate the current month
                // In a real implementation, you would change the month
                generateCalendar();
            });
            
            document.getElementById('next-month').addEventListener('click', function() {
                // For simplicity, we'll just regenerate the current month
                // In a real implementation, you would change the month
                generateCalendar();
            });
        }

        async function startCamera() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 300 },
                        height: { ideal: 300 },
                        facingMode: "user"
                    } 
                });
                
                cameraVideo.srcObject = cameraStream;
                cameraContainer.style.display = 'block';
                cameraBtn.disabled = true;
            } catch (err) {
                console.error('Error accessing camera:', err);
                showAlert('Error accessing camera. Please ensure you have granted camera permissions.', 'error');
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            cameraContainer.style.display = 'none';
            cameraBtn.disabled = false;
        }

        function capturePhoto() {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = cameraVideo.videoWidth;
            canvas.height = cameraVideo.videoHeight;
            
            context.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);
            
            currentCapture = canvas.toDataURL('image/jpeg', 0.9);
            capturePreview.innerHTML = `<img src="${currentCapture}" alt="Captured photo">`;
            
            stopCamera();
            showAlert('Photo captured successfully!', 'success');
        }

        function removeProfilePicture() {
            if (currentCapture) {
                currentCapture = null;
                capturePreview.innerHTML = '<span>No profile picture</span>';
                showAlert('Profile picture removed', 'success');
            }
        }

        function performSearch() {
            const query = searchInput.value.trim().toLowerCase();
            
            if (query.length === 0) {
                searchResults.style.display = 'none';
                return;
            }
            
            const results = members.filter(member => 
                member.name.toLowerCase().includes(query) || 
                (member.phone && member.phone.includes(query))
            );
            
            displaySearchResults(results);
        }

        function displaySearchResults(results) {
            searchResults.innerHTML = '';
            
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item">No members found</div>';
                searchResults.style.display = 'block';
                return;
            }
            
            results.forEach(member => {
                const today = new Date();
                const isVerified = attendance.some(record => {
                    const recordDate = new Date(record.timestamp);
                    return record.memberId === member.id && 
                           recordDate.getFullYear() === today.getFullYear() &&
                           recordDate.getMonth() === today.getMonth() &&
                           recordDate.getDate() === today.getDate();
                });
                
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item';
                resultItem.innerHTML = `
                    <div>
                        <div><strong>${member.name}</strong></div>
                        <div style="font-size: 0.9rem; color: #6c757d;">${member.phone || 'No phone'}  ${member.job || 'No job'}</div>
                    </div>
                    <div>
                        ${isVerified ? 
                            '<span style="color: #28a745; font-weight: bold;">Verified</span>' : 
                            '<button class="btn btn-success btn-sm verify-search-btn">Verify</button>'
                        }
                    </div>
                `;
                
                resultItem.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('verify-search-btn')) {
                        selectMember(member);
                        searchResults.style.display = 'none';
                    }
                });
                
                const verifyBtn = resultItem.querySelector('.verify-search-btn');
                if (verifyBtn) {
                    verifyBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        selectMember(member);
                        verifyAttendance();
                        searchResults.style.display = 'none';
                    });
                }
                
                searchResults.appendChild(resultItem);
            });
            
            searchResults.style.display = 'block';
        }

        function selectMember(member) {
            currentSelectedMember = member;
            searchInput.value = `${member.name} (${member.phone || 'No phone'})`;
            
            displayMemberProfile(member);
            
            const today = new Date();
            const isVerified = attendance.some(record => {
                const recordDate = new Date(record.timestamp);
                return record.memberId === member.id && 
                       recordDate.getFullYear() === today.getFullYear() &&
                       recordDate.getMonth() === today.getMonth() &&
                       recordDate.getDate() === today.getDate();
            });
            
            if (isVerified) {
                verificationStatus.textContent = 'ALREADY VERIFIED - Attendance already marked today';
                verificationStatus.className = 'verification-status verified';
            } else {
                verificationStatus.textContent = 'READY FOR VERIFICATION - Confirm identity and verify';
                verificationStatus.className = 'verification-status not-verified';
            }
        }

        function displayMemberProfile(member) {
            let avatarContent;
            
            if (member.image) {
                avatarContent = `<img src="${member.image}" alt="${member.name}" style="width:100%; height:100%; object-fit:cover;">`;
            } else {
                avatarContent = member.name.split(' ').map(n => n[0]).join('');
            }
            
            profileDisplay.innerHTML = `
                <div class="profile-avatar">${avatarContent}</div>
                <div class="profile-name">${member.name}</div>
                <div class="profile-details">
                    <div>ID: ${member.idNumber}  ${member.job || 'No job'}</div>
                    <div>Phone: ${member.phone || 'Not provided'}  Birth: ${member.dateOfBirth || 'Not specified'}</div>
                    <div>Hometown: ${member.hometown || 'Not specified'}  Tribe: ${member.tribe || 'Not specified'}</div>
                    <div>Chapter: ${member.chapter || 'Not specified'}  Group: ${member.group || 'Not specified'}</div>
                </div>
                <div class="profile-id">Click to view full profile</div>
            `;
        }

        function verifyAttendance() {
            if (!currentSelectedMember) {
                showAlert('Please select a member first.', 'error');
                return;
            }
            
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            const alreadyVerified = attendance.some(record => {
                const recordDate = new Date(record.timestamp);
                return record.memberId === currentSelectedMember.id && 
                       recordDate.getFullYear() === today.getFullYear() &&
                       recordDate.getMonth() === today.getMonth() &&
                       recordDate.getDate() === today.getDate();
            });
            
            if (alreadyVerified) {
                showAlert(`${currentSelectedMember.name} has already been verified today.`, 'error');
                return;
            }
            
            const newRecord = {
                memberId: currentSelectedMember.id,
                memberName: currentSelectedMember.name,
                timestamp: now.toISOString(),
                verificationTime: now.toLocaleTimeString()
            };
            
            attendance.push(newRecord);
            
            // Save to localStorage
            saveAllToLocalStorage();
            
            // Save to cloud if in cloud mode
            if (isCloudMode && SHEET_ID && SCRIPT_URL) {
                saveAttendanceToCloud(newRecord);
            }
            
            verificationStatus.textContent = 'VERIFICATION SUCCESSFUL - Attendance marked';
            verificationStatus.className = 'verification-status verified';
            
            lastVerifiedEl.textContent = now.toLocaleTimeString();
            
            showAlert(`Attendance verified for ${currentSelectedMember.name}`, 'success');
            updateUI();
        }

        function clearSearch() {
            searchInput.value = '';
            searchResults.style.display = 'none';
            profileDisplay.innerHTML = '<div class="no-profile">No profile selected. Search for a member to verify attendance.</div>';
            verificationStatus.textContent = 'NOT VERIFIED - Profile needs verification';
            verificationStatus.className = 'verification-status not-verified';
            currentSelectedMember = null;
        }

        function saveMember() {
            const name = memberNameInput.value.trim();
            const idNumber = memberIdInput.value.trim();
            const phone = memberPhoneInput.value.trim();
            const dateOfBirth = memberDobInput.value;
            const job = jobSelect.value;
            const hometown = hometownSelect.value;
            const tribe = tribeSelect.value;
            const chapter = chapterSelect.value;
            const group = groupSelect.value;
            
            if (!name || !idNumber) {
                showAlert('Please enter both name and ID number.', 'error');
                return;
            }
            
            if (members.some(m => m.idNumber === idNumber)) {
                showAlert('A member with this ID number already exists.', 'error');
                return;
            }
            
            if (phone && members.some(m => m.phone === phone)) {
                showAlert('A member with this phone number already exists.', 'error');
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            try {
                const newMember = {
                    id: Date.now().toString(),
                    name: name,
                    idNumber: idNumber,
                    phone: phone,
                    dateOfBirth: dateOfBirth,
                    job: job,
                    hometown: hometown,
                    tribe: tribe,
                    chapter: chapter,
                    group: group,
                    image: currentCapture,
                    joinDate: new Date().toISOString().split('T')[0],
                    department: "General",
                    lastUpdated: new Date().toISOString()
                };
                
                members.push(newMember);
                
                // Save to localStorage
                saveAllToLocalStorage();
                
                // Save to cloud if in cloud mode
                if (isCloudMode && SHEET_ID && SCRIPT_URL) {
                    saveMemberToCloud(newMember);
                }
                
                updateUI();
                
                memberNameInput.value = '';
                memberIdInput.value = '';
                memberPhoneInput.value = '';
                memberDobInput.value = '';
                jobSelect.value = '';
                hometownSelect.value = '';
                tribeSelect.value = '';
                chapterSelect.value = '';
                groupSelect.value = '';
                capturePreview.innerHTML = '<span>No profile picture</span>';
                currentCapture = null;
                
                showAlert(`Member ${name} added successfully!`, 'success');
            } catch (error) {
                console.error('Error saving member:', error);
                showAlert('Error saving member: ' + error.message, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Member';
            }
        }

        function deleteMember(memberId) {
            const memberToDelete = members.find(m => m.id === memberId);
            if (!memberToDelete) {
                showAlert('Member not found for deletion.', 'error');
                return;
            }
            
            showConfirmModal(`Are you sure you want to delete ${memberToDelete.name}?`, function() {
                members = members.filter(m => m.id !== memberId);
                attendance = attendance.filter(r => r.memberId !== memberId);
                
                // Save to localStorage
                saveAllToLocalStorage();
                
                // Delete from cloud if in cloud mode
                if (isCloudMode && SHEET_ID && SCRIPT_URL) {
                    deleteMemberFromCloud(memberId);
                }
                
                updateUI();
                
                if (currentSelectedMember && currentSelectedMember.id === memberId) {
                    clearSearch();
                }
                
                showAlert('Member deleted successfully.', 'success');
            });
        }

        function updateUI() {
            const jobFilterValue = jobFilter.value;
            
            const today = new Date();
            const todayRecords = attendance.filter(record => {
                const recordDate = new Date(record.timestamp);
                return recordDate.getFullYear() === today.getFullYear() &&
                       recordDate.getMonth() === today.getMonth() &&
                       recordDate.getDate() === today.getDate();
            });
            
            presentCountEl.textContent = todayRecords.length;
            totalUsersEl.textContent = members.length;
            verifiedCountEl.textContent = todayRecords.length;
            
            if (todayRecords.length > 0) {
                const lastRecord = todayRecords[todayRecords.length - 1];
                lastVerifiedEl.textContent = new Date(lastRecord.timestamp).toLocaleTimeString();
            } else {
                lastVerifiedEl.textContent = '-';
            }
            
            renderAttendanceList(jobFilterValue);
            renderUserManagementList();
            updateOverview();
        }

        function updateOverview() {
            const today = new Date();
            const todayRecords = attendance.filter(record => {
                const recordDate = new Date(record.timestamp);
                return recordDate.getFullYear() === today.getFullYear() &&
                       recordDate.getMonth() === today.getMonth() &&
                       recordDate.getDate() === today.getDate();
            });
            
            presentTodayCountEl.textContent = todayRecords.length;
            totalMembersCountEl.textContent = members.length;
            
            // Count active meetings (today's meetings)
            const activeMeetings = meetings.filter(meeting => {
                const meetingDate = new Date(meeting.date);
                return meetingDate.getFullYear() === today.getFullYear() &&
                       meetingDate.getMonth() === today.getMonth() &&
                       meetingDate.getDate() === today.getDate();
            });
            
            activeMeetingsCountEl.textContent = activeMeetings.length;
            
            // Count upcoming birthdays (next 7 days)
            const upcomingBirthdays = getUpcomingBirthdays(7).length;
            upcomingBirthdaysCountEl.textContent = upcomingBirthdays;
            
            // Update active meeting display
            if (activeMeetings.length > 0) {
                activeMeetingDisplay.innerHTML = `
                    <h4>${activeMeetings[0].title}</h4>
                    <p>Date: ${new Date(activeMeetings[0].date).toLocaleDateString()}</p>
                    <p>Attendees: ${activeMeetings[0].attendees ? activeMeetings[0].attendees.length : 0}</p>
                    <button class="btn btn-success" id="view-meeting-attendance-btn">
                        <i class="fas fa-users"></i> View Attendance
                    </button>
                `;
                
                document.getElementById('view-meeting-attendance-btn').addEventListener('click', function() {
                    switchContentSection('view-attendance');
                    subTabs.forEach(t => t.classList.remove('active'));
                    document.querySelector('.sub-tab[data-section="view-attendance"]').classList.add('active');
                });
            } else {
                activeMeetingDisplay.innerHTML = '<p>No active meeting. Create a new meeting to start attendance.</p>';
            }
        }

        function renderAttendanceList(jobFilter = 'all') {
            const today = new Date();
            attendanceList.innerHTML = '';
            
            let filteredMembers = [...members];
            
            if (jobFilter !== 'all') {
                filteredMembers = filteredMembers.filter(member => member.job === jobFilter);
            }
            
            filteredMembers.sort((a, b) => a.name.localeCompare(b.name));
            
            if (filteredMembers.length === 0) {
                attendanceList.innerHTML = '<div style="padding: 20px; text-align: center; color: #6c757d;">No members match the current filters</div>';
                return;
            }
            
            filteredMembers.forEach(member => {
                const attendanceRecord = attendance.find(record => {
                    const recordDate = new Date(record.timestamp);
                    return record.memberId === member.id &&
                           recordDate.getFullYear() === today.getFullYear() &&
                           recordDate.getMonth() === today.getMonth() &&
                           recordDate.getDate() === today.getDate();
                });
                
                const isCurrentlySelected = currentSelectedMember && currentSelectedMember.id === member.id;
                
                const attendanceItem = document.createElement('div');
                attendanceItem.className = `attendance-item ${attendanceRecord || isCurrentlySelected ? 'present' : ''}`;
                attendanceItem.addEventListener('click', () => {
                    selectMember(member);
                });
                
                let avatarContent;
                if (member.image) {
                    avatarContent = `<img src="${member.image}" alt="${member.name}" style="width:100%; height:100%; object-fit:cover;">`;
                } else {
                    avatarContent = member.name.split(' ').map(n => n[0]).join('');
                }
                
                const timeInfo = attendanceRecord ? 
                    `<div class="attendance-time">Verified: ${attendanceRecord.verificationTime || 'Today'}</div>` : 
                    '<div class="attendance-time">Not verified today</div>';
                
                attendanceItem.innerHTML = `
                    <div class="user-info">
                        <div class="user-avatar">${avatarContent}</div>
                        <div>
                            <div>${member.name}</div>
                            <div style="font-size: 0.8rem; color: #6c757d;">${member.job || 'No job'}</div>
                            ${timeInfo}
                        </div>
                    </div>
                    <div class="status-indicator ${attendanceRecord || isCurrentlySelected ? 'status-present' : 'status-absent'}"></div>
                `;
                
                attendanceList.appendChild(attendanceItem);
            });
        }

        function renderUserManagementList() {
            userManagementList.innerHTML = '';
            
            if (members.length === 0) {
                userManagementList.innerHTML = '<p>No members added yet.</p>';
                return;
            }
            
            const sortedMembers = [...members].sort((a, b) => a.name.localeCompare(b.name));
            
            sortedMembers.forEach(member => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                
                let avatarContent;
                if (member.image) {
                    avatarContent = `<img src="${member.image}" alt="${member.name}" style="width:100%; height:100%; object-fit:cover;">`;
                } else {
                    avatarContent = member.name.split(' ').map(n => n[0]).join('');
                }
                
                userCard.innerHTML = `
                    <div class="user-avatar">${avatarContent}</div>
                    <div class="user-card-info">
                        <div class="user-card-name">${member.name}</div>
                        <div class="user-card-id">${member.idNumber} | ${member.job || 'No job'} | ${member.phone || 'No phone'}</div>
                    </div>
                `;
                
                const editBtn = document.createElement('button');
                editBtn.className = 'edit-btn';
                editBtn.textContent = 'Edit';
                editBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    editMember(member.id);
                });
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    deleteMember(member.id);
                });
                
                userCard.appendChild(editBtn);
                userCard.appendChild(deleteBtn);
                
                userManagementList.appendChild(userCard);
            });
        }

        function renderAllMembersList() {
            allMembersList.innerHTML = '';
            
            if (members.length === 0) {
                allMembersList.innerHTML = '<p>No members added yet.</p>';
                return;
            }
            
            const sortedMembers = [...members].sort((a, b) => a.name.localeCompare(b.name));
            
            sortedMembers.forEach(member => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                
                let avatarContent;
                if (member.image) {
                    avatarContent = `<img src="${member.image}" alt="${member.name}" style="width:100%; height:100%; object-fit:cover;">`;
                } else {
                    avatarContent = member.name.split(' ').map(n => n[0]).join('');
                }
                
                userCard.innerHTML = `
                    <div class="user-avatar">${avatarContent}</div>
                    <div class="user-card-info">
                        <div class="user-card-name">${member.name}</div>
                        <div class="user-card-id">
                            ${member.idNumber} | ${member.job || 'No job'} | ${member.phone || 'No phone'}
                            <br>
                            ${member.chapter ? `Chapter: ${member.chapter}` : ''} ${member.group ? ` | Group: ${member.group}` : ''}
                        </div>
                    </div>
                `;
                
                const editBtn = document.createElement('button');
                editBtn.className = 'edit-btn';
                editBtn.textContent = 'Edit';
                editBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    editMember(member.id);
                });
                
                userCard.appendChild(editBtn);
                
                allMembersList.appendChild(userCard);
            });
        }

        function performAllMembersSearch() {
            const query = allMembersSearchInput.value.trim().toLowerCase();
            
            if (query.length === 0) {
                renderAllMembersList();
                return;
            }
            
            const results = members.filter(member => 
                member.name.toLowerCase().includes(query) || 
                member.idNumber.toLowerCase().includes(query)
            );
            
            renderFilteredAllMembersList(results);
        }

        function renderFilteredAllMembersList(filteredMembers) {
            allMembersList.innerHTML = '';
            
            if (filteredMembers.length === 0) {
                allMembersList.innerHTML = '<p>No members found.</p>';
                return;
            }
            
            filteredMembers.forEach(member => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                
                let avatarContent;
                if (member.image) {
                    avatarContent = `<img src="${member.image}" alt="${member.name}" style="width:100%; height:100%; object-fit:cover;">`;
                } else {
                    avatarContent = member.name.split(' ').map(n => n[0]).join('');
                }
                
                userCard.innerHTML = `
                    <div class="user-avatar">${avatarContent}</div>
                    <div class="user-card-info">
                        <div class="user-card-name">${member.name}</div>
                        <div class="user-card-id">
                            ${member.idNumber} | ${member.job || 'No job'} | ${member.phone || 'No phone'}
                            <br>
                            ${member.chapter ? `Chapter: ${member.chapter}` : ''} ${member.group ? ` | Group: ${member.group}` : ''}
                        </div>
                    </div>
                `;
                
                const editBtn = document.createElement('button');
                editBtn.className = 'edit-btn';
                editBtn.textContent = 'Edit';
                editBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    editMember(member.id);
                });
                
                userCard.appendChild(editBtn);
                
                allMembersList.appendChild(userCard);
            });
        }

        function editMember(memberId) {
            const member = members.find(m => m.id === memberId);
            if (member) {
                dropdownItems.forEach(item => {
                    item.classList.remove('active');
                    const btn = item.querySelector('.dropdown-btn');
                    if (btn) btn.classList.remove('active');
                });
                
                const membersItem = document.querySelector('.dropdown-item:has(.dropdown-btn[data-tab="members"])');
                const membersBtn = membersItem.querySelector('.dropdown-btn');
                membersItem.classList.add('active');
                membersBtn.classList.add('active');
                
                switchContentSection('add-member');
                subTabs.forEach(t => t.classList.remove('active'));
                document.querySelector('.sub-tab[data-section="add-member"]').classList.add('active');
                
                memberNameInput.value = member.name;
                memberIdInput.value = member.idNumber;
                memberPhoneInput.value = member.phone || '';
                memberDobInput.value = member.dateOfBirth || '';
                jobSelect.value = member.job || '';
                hometownSelect.value = member.hometown || '';
                tribeSelect.value = member.tribe || '';
                chapterSelect.value = member.chapter || '';
                groupSelect.value = member.group || '';
                
                if (member.image) {
                    capturePreview.innerHTML = `<img src="${member.image}" alt="${member.name}">`;
                    currentCapture = member.image;
                } else {
                    capturePreview.innerHTML = '<span>No profile picture</span>';
                    currentCapture = null;
                }
                
                currentEditingMember = member.id;
                showAlert(`Editing member: ${member.name}`, 'info');
            }
        }

        function performManageSearch() {
            const query = manageSearchInput.value.trim().toLowerCase();
            
            if (query.length === 0) {
                renderUserManagementList();
                return;
            }
            
            const results = members.filter(member => 
                member.name.toLowerCase().includes(query) || 
                member.idNumber.toLowerCase().includes(query)
            );
            
            renderFilteredUserManagementList(results);
        }

        function renderFilteredUserManagementList(filteredMembers) {
            userManagementList.innerHTML = '';
            
            if (filteredMembers.length === 0) {
                userManagementList.innerHTML = '<p>No members found.</p>';
                return;
            }
            
            filteredMembers.forEach(member => {
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                
                let avatarContent;
                if (member.image) {
                    avatarContent = `<img src="${member.image}" alt="${member.name}" style="width:100%; height:100%; object-fit:cover;">`;
                } else {
                    avatarContent = member.name.split(' ').map(n => n[0]).join('');
                }
                
                userCard.innerHTML = `
                    <div class="user-avatar">${avatarContent}</div>
                    <div class="user-card-info">
                        <div class="user-card-name">${member.name}</div>
                        <div class="user-card-id">${member.idNumber} | ${member.job || 'No job'} | ${member.phone || 'No phone'}</div>
                    </div>
                `;
                
                const editBtn = document.createElement('button');
                editBtn.className = 'edit-btn';
                editBtn.textContent = 'Edit';
                editBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    editMember(member.id);
                });
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    deleteMember(member.id);
                });
                
                userCard.appendChild(editBtn);
                userCard.appendChild(deleteBtn);
                
                userManagementList.appendChild(userCard);
            });
        }

        function createNewMeeting() {
            const date = meetingDateInput.value;
            const title = meetingTitleInput.value.trim();
            
            if (!date || !title) {
                showAlert('Please enter both date and title for the meeting.', 'error');
                return;
            }
            
            const newMeeting = {
                id: Date.now().toString(),
                date: date,
                title: title,
                createdAt: new Date().toISOString(),
                attendees: []
            };
            
            meetings.push(newMeeting);
            saveMeetingsToLocalStorage();
            renderMeetings();
            
            meetingDateInput.value = '';
            meetingTitleInput.value = '';
            
            showAlert(`Meeting "${title}" created successfully!`, 'success');
        }

        function renderMeetings() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const activeMeetings = meetings.filter(meeting => {
                const meetingDate = new Date(meeting.date);
                meetingDate.setHours(0, 0, 0, 0);
                return meetingDate.getTime() === today.getTime();
            });
            
            const upcomingMeetings = meetings.filter(meeting => {
                const meetingDate = new Date(meeting.date);
                meetingDate.setHours(0, 0, 0, 0);
                return meetingDate.getTime() > today.getTime();
            });
            
            const pastMeetings = meetings.filter(meeting => {
                const meetingDate = new Date(meeting.date);
                meetingDate.setHours(0, 0, 0, 0);
                return meetingDate.getTime() < today.getTime();
            });
            
            // Render active meetings
            activeMeetingsList.innerHTML = '';
            if (activeMeetings.length === 0) {
                activeMeetingsList.innerHTML = '<p>No active meetings today.</p>';
            } else {
                activeMeetings.forEach(meeting => {
                    const meetingItem = document.createElement('div');
                    meetingItem.className = 'meeting-item';
                    meetingItem.innerHTML = `
                        <div>
                            <div class="meeting-date">${new Date(meeting.date).toLocaleDateString()}</div>
                            <div>${meeting.title}</div>
                        </div>
                        <div>
                            <span class="meeting-status status-active">Active</span>
                            <button class="btn btn-primary btn-sm view-meeting-btn" data-meeting="${meeting.id}">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                    `;
                    activeMeetingsList.appendChild(meetingItem);
                });
            }
            
            // Render upcoming meetings
            upcomingMeetingsList.innerHTML = '';
            if (upcomingMeetings.length === 0) {
                upcomingMeetingsList.innerHTML = '<p>No upcoming meetings.</p>';
            } else {
                upcomingMeetings.forEach(meeting => {
                    const meetingItem = document.createElement('div');
                    meetingItem.className = 'meeting-item';
                    meetingItem.innerHTML = `
                        <div>
                            <div class="meeting-date">${new Date(meeting.date).toLocaleDateString()}</div>
                            <div>${meeting.title}</div>
                        </div>
                        <div>
                            <span class="meeting-status status-upcoming">Upcoming</span>
                            <button class="btn btn-primary btn-sm view-meeting-btn" data-meeting="${meeting.id}">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                    `;
                    upcomingMeetingsList.appendChild(meetingItem);
                });
            }
            
            // Render past meetings
            pastMeetingsList.innerHTML = '';
            if (pastMeetings.length === 0) {
                pastMeetingsList.innerHTML = '<p>No past meetings.</p>';
            } else {
                pastMeetings.forEach(meeting => {
                    const meetingItem = document.createElement('div');
                    meetingItem.className = 'meeting-item';
                    meetingItem.innerHTML = `
                        <div>
                            <div class="meeting-date">${new Date(meeting.date).toLocaleDateString()}</div>
                            <div>${meeting.title}</div>
                        </div>
                        <div>
                            <span class="meeting-status status-completed">Completed</span>
                            <button class="btn btn-primary btn-sm view-meeting-btn" data-meeting="${meeting.id}">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </div>
                    `;
                    pastMeetingsList.appendChild(meetingItem);
                });
            }
            
            // Add event listeners for view buttons
            document.querySelectorAll('.view-meeting-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const meetingId = this.getAttribute('data-meeting');
                    viewMeeting(meetingId);
                });
            });
        }

        function viewMeeting(meetingId) {
            const meeting = meetings.find(m => m.id === meetingId);
            if (meeting) {
                showAlert(`Viewing meeting: ${meeting.title}`, 'info');
                // In a real implementation, you would show meeting details and attendance
            }
        }

        function getUpcomingBirthdays(days = 7) {
            const today = new Date();
            const upcoming = [];
            
            members.forEach(member => {
                if (member.dateOfBirth) {
                    const [month, day] = member.dateOfBirth.split('/').map(Number);
                    const birthdayThisYear = new Date(today.getFullYear(), month - 1, day);
                    const diffTime = birthdayThisYear.getTime() - today.getTime();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays >= 0 && diffDays <= days) {
                        upcoming.push({
                            member: member,
                            daysUntil: diffDays
                        });
                    }
                }
            });
            
            return upcoming.sort((a, b) => a.daysUntil - b.daysUntil);
        }

        function renderBirthdayReminders() {
            const upcoming = getUpcomingBirthdays(7);
            const thisMonth = getBirthdaysThisMonth();
            const nextMonth = getBirthdaysNextMonth();
            
            birthdaysThisWeekEl.textContent = upcoming.length;
            birthdaysThisMonthEl.textContent = thisMonth.length;
            birthdaysNextMonthEl.textContent = nextMonth.length;
            
            // Render upcoming birthdays
            upcomingBirthdaysList.innerHTML = '';
            if (upcoming.length === 0) {
                upcomingBirthdaysList.innerHTML = '<p>No birthdays in the next 7 days.</p>';
            } else {
                upcoming.forEach(item => {
                    const birthdayItem = document.createElement('div');
                    birthdayItem.className = 'birthday-item';
                    
                    let avatarContent;
                    if (item.member.image) {
                        avatarContent = `<img src="${item.member.image}" alt="${item.member.name}" style="width:100%; height:100%; object-fit:cover;">`;
                    } else {
                        avatarContent = item.member.name.split(' ').map(n => n[0]).join('');
                    }
                    
                    birthdayItem.innerHTML = `
                        <div class="birthday-avatar">${avatarContent}</div>
                        <div>
                            <div><strong>${item.member.name}</strong></div>
                            <div>Birthday: ${item.member.dateOfBirth}</div>
                            <div>${item.member.phone || 'No phone'} | ${item.member.job || 'No job'}</div>
                        </div>
                        <div class="birthday-days">
                            ${item.daysUntil === 0 ? 'Today!' : `${item.daysUntil} day${item.daysUntil === 1 ? '' : 's'}`}
                        </div>
                    `;
                    upcomingBirthdaysList.appendChild(birthdayItem);
                });
            }
            
            // Render this month's birthdays
            monthBirthdaysList.innerHTML = '';
            if (thisMonth.length === 0) {
                monthBirthdaysList.innerHTML = '<p>No birthdays this month.</p>';
            } else {
                thisMonth.forEach(member => {
                    const birthdayItem = document.createElement('div');
                    birthdayItem.className = 'birthday-item';
                    
                    let avatarContent;
                    if (member.image) {
                        avatarContent = `<img src="${member.image}" alt="${member.name}" style="width:100%; height:100%; object-fit:cover;">`;
                    } else {
                        avatarContent = member.name.split(' ').map(n => n[0]).join('');
                    }
                    
                    birthdayItem.innerHTML = `
                        <div class="birthday-avatar">${avatarContent}</div>
                        <div>
                            <div><strong>${member.name}</strong></div>
                            <div>Birthday: ${member.dateOfBirth}</div>
                            <div>${member.phone || 'No phone'} | ${member.job || 'No job'}</div>
                        </div>
                    `;
                    monthBirthdaysList.appendChild(birthdayItem);
                });
            }
        }

        function getBirthdaysThisMonth() {
            const today = new Date();
            const currentMonth = today.getMonth() + 1; // JavaScript months are 0-indexed
            
            return members.filter(member => {
                if (member.dateOfBirth) {
                    const [month, day] = member.dateOfBirth.split('/').map(Number);
                    return month === currentMonth;
                }
                return false;
            });
        }

        function getBirthdaysNextMonth() {
            const today = new Date();
            const nextMonth = today.getMonth() + 2 > 12 ? 1 : today.getMonth() + 2; // Handle December -> January
            
            return members.filter(member => {
                if (member.dateOfBirth) {
                    const [month, day] = member.dateOfBirth.split('/').map(Number);
                    return month === nextMonth;
                }
                return false;
            });
        }

        function renderChaptersList() {
            chaptersList.innerHTML = '';
            
            if (availableChapters.length === 0) {
                chaptersList.innerHTML = '<p>No chapters created yet.</p>';
                return;
            }
            
            availableChapters.forEach(chapter => {
                const chapterItem = document.createElement('div');
                chapterItem.className = 'chapter-item';
                chapterItem.innerHTML = `
                    <div class="chapter-info">
                        <div class="chapter-name">${chapter.name}</div>
                        <div class="chapter-details">Location: ${chapter.location} | Leader: ${chapter.leader}</div>
                    </div>
                    <div>
                        <button class="btn btn-info btn-sm edit-chapter-btn" data-chapter="${chapter.name}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger btn-sm delete-chapter-btn" data-chapter="${chapter.name}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                chaptersList.appendChild(chapterItem);
            });
            
            document.querySelectorAll('.delete-chapter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const chapterName = this.getAttribute('data-chapter');
                    deleteChapter(chapterName);
                });
            });
            
            document.querySelectorAll('.edit-chapter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const chapterName = this.getAttribute('data-chapter');
                    editChapter(chapterName);
                });
            });
        }

        function addNewChapter() {
            const name = newChapterName.value.trim();
            const location = newChapterLocation.value.trim();
            const leader = newChapterLeader.value.trim();
            
            if (!name || !location || !leader) {
                showAlert('Please enter all chapter information.', 'error');
                return;
            }
            
            if (availableChapters.some(c => c.name === name)) {
                showAlert('A chapter with this name already exists.', 'error');
                return;
            }
            
            const newChapter = {
                name: name,
                location: location,
                leader: leader
            };
            
            availableChapters.push(newChapter);
            saveOptionsToLocalStorage();
            updateDropdowns();
            renderChaptersList();
            
            newChapterName.value = '';
            newChapterLocation.value = '';
            newChapterLeader.value = '';
            
            showAlert(`Chapter "${name}" added successfully.`, 'success');
        }

        function deleteChapter(chapterName) {
            showConfirmModal(`Are you sure you want to delete the chapter "${chapterName}"?`, function() {
                availableChapters = availableChapters.filter(c => c.name !== chapterName);
                saveOptionsToLocalStorage();
                updateDropdowns();
                renderChaptersList();
                showAlert(`Chapter "${chapterName}" deleted successfully.`, 'success');
            });
        }

        function editChapter(chapterName) {
            const chapter = availableChapters.find(c => c.name === chapterName);
            if (chapter) {
                newChapterName.value = chapter.name;
                newChapterLocation.value = chapter.location;
                newChapterLeader.value = chapter.leader;
                
                // Remove the chapter from the list temporarily
                availableChapters = availableChapters.filter(c => c.name !== chapterName);
                saveOptionsToLocalStorage();
                updateDropdowns();
                renderChaptersList();
                
                showAlert(`Editing chapter: ${chapterName}. Update the information and click "Add Chapter" to save.`, 'info');
            }
        }

        function renderGroupsList() {
            groupsList.innerHTML = '';
            
            if (availableGroups.length === 0) {
                groupsList.innerHTML = '<p>No groups created yet.</p>';
                return;
            }
            
            availableGroups.forEach(group => {
                const groupItem = document.createElement('div');
                groupItem.className = 'group-item';
                groupItem.innerHTML = `
                    <div class="group-info">
                        <div class="group-name">${group.name}</div>
                        <div class="group-details">${group.description || 'No description'}</div>
                    </div>
                    <div>
                        <button class="btn btn-info btn-sm edit-group-btn" data-group="${group.name}">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger btn-sm delete-group-btn" data-group="${group.name}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                groupsList.appendChild(groupItem);
            });
            
            document.querySelectorAll('.delete-group-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const groupName = this.getAttribute('data-group');
                    deleteGroup(groupName);
                });
            });
            
            document.querySelectorAll('.edit-group-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const groupName = this.getAttribute('data-group');
                    editGroup(groupName);
                });
            });
        }

        function createNewGroup() {
            const name = newGroupName.value.trim();
            const description = newGroupDescription.value.trim();
            
            if (!name) {
                showAlert('Please enter a group name.', 'error');
                return;
            }
            
            if (availableGroups.some(g => g.name === name)) {
                showAlert('A group with this name already exists.', 'error');
                return;
            }
            
            const newGroup = {
                name: name,
                description: description
            };
            
            availableGroups.push(newGroup);
            saveOptionsToLocalStorage();
            updateDropdowns();
            renderGroupsList();
            
            newGroupName.value = '';
            newGroupDescription.value = '';
            
            showAlert(`Group "${name}" created successfully.`, 'success');
        }

        function deleteGroup(groupName) {
            showConfirmModal(`Are you sure you want to delete the group "${groupName}"?`, function() {
                availableGroups = availableGroups.filter(g => g.name !== groupName);
                saveOptionsToLocalStorage();
                updateDropdowns();
                renderGroupsList();
                showAlert(`Group "${groupName}" deleted successfully.`, 'success');
            });
        }

        function editGroup(groupName) {
            const group = availableGroups.find(g => g.name === groupName);
            if (group) {
                newGroupName.value = group.name;
                newGroupDescription.value = group.description || '';
                
                // Remove the group from the list temporarily
                availableGroups = availableGroups.filter(g => g.name !== groupName);
                saveOptionsToLocalStorage();
                updateDropdowns();
                renderGroupsList();
                
                showAlert(`Editing group: ${groupName}. Update the information and click "Create Group" to save.`, 'info');
            }
        }

        // Add AbortSignal.timeout polyfill if not available
        if (!AbortSignal.timeout) {
            AbortSignal.timeout = function(ms) {
                const controller = new AbortController();
                setTimeout(() => controller.abort(new Error('Timeout')), ms);
                return controller.signal;
            };
        }

        // Validation functions
        function isValidSheetId(sheetId) {
            if (!sheetId || sheetId.length < 10) return false;
            const sheetIdRegex = /^[a-zA-Z0-9-_]+$/;
            return sheetIdRegex.test(sheetId);
        }

        function isValidScriptUrl(url) {
            if (!url) return false;
            try {
                const urlObj = new URL(url);
                return urlObj.hostname.includes('google.com') || 
                       urlObj.hostname.includes('script.google.com') ||
                       urlObj.hostname.includes('googleusercontent.com');
            } catch (e) {
                return false;
            }
        }

        // Updated connection test function
        async function testGoogleAppsScriptConnection() {
            if (!SCRIPT_URL) return false;
            
            try {
                // Use GET request instead of POST for better compatibility
                const testUrl = `${SCRIPT_URL}?action=test&sheetId=${encodeURIComponent(SHEET_ID)}&timestamp=${Date.now()}`;
                
                const response = await fetch(testUrl, {
                    method: 'GET',
                    signal: AbortSignal.timeout(15000) // 15 second timeout
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Check if the response indicates success
                return data.success === true;
                
            } catch (error) {
                console.error('Google Apps Script connection test failed:', error);
                
                // Provide more specific error messages
                if (error.name === 'AbortError') {
                    throw new Error('Connection timeout - the server took too long to respond');
                } else if (error.message.includes('Failed to fetch')) {
                    throw new Error('Failed to fetch - check internet connection and CORS settings');
                } else if (error.message.includes('404')) {
                    throw new Error('Script URL not found - please check your Google Apps Script deployment URL');
                } else if (error.message.includes('403')) {
                    throw new Error('Access denied - please check if your Google Apps Script is deployed correctly with "Anyone" access');
                } else {
                    throw error;
                }
            }
        }

        function testConnection() {
            if (!saveSettings()) {
                showAlert('Failed to save settings before testing connection', 'error');
                return;
            }
            
            if (!SHEET_ID || !SCRIPT_URL) {
                showAlert('Please configure your Google Sheet settings first', 'error');
                return;
            }
            
            // Validate Sheet ID format
            if (!isValidSheetId(SHEET_ID)) {
                showAlert('Invalid Google Sheet ID format. Please check your Sheet ID.', 'error');
                updateSyncStatus('error', 'Invalid Sheet ID format');
                return;
            }
            
            // Validate Script URL format
            if (!isValidScriptUrl(SCRIPT_URL)) {
                showAlert('Invalid Google Apps Script URL format. Please check your URL.', 'error');
                updateSyncStatus('error', 'Invalid Script URL format');
                return;
            }
            
            updateSyncStatus('syncing', 'Testing connection...');
            
            // Test the actual connection to Google Apps Script
            testGoogleAppsScriptConnection()
                .then(success => {
                    if (success) {
                        updateSyncStatus('success', 'Connection successful');
                        showAlert('Connection to Google Sheet successful!', 'success');
                        updateDatabaseStatus(`Connected successfully to Google Sheet: ${SHEET_ID}`);
                        
                        // Enable cloud mode
                        isCloudMode = true;
                        localStorage.setItem('asantemanCloudMode', 'true');
                        updateModeIndicator();
                    } else {
                        updateSyncStatus('error', 'Connection failed');
                        showAlert('Failed to connect to Google Sheet. Please check your Sheet ID and Script URL.', 'error');
                        updateDatabaseStatus('Connection failed. Please check your settings.');
                        
                        // Disable cloud mode
                        isCloudMode = false;
                        localStorage.setItem('asantemanCloudMode', 'false');
                        updateModeIndicator();
                    }
                })
                .catch(error => {
                    console.error('Connection test error:', error);
                    updateSyncStatus('error', 'Connection error');
                    
                    // More specific error messages
                    let userMessage = error.message;
                    if (error.message.includes('Failed to fetch')) {
                        userMessage = 'Network error. Please check: 1) Your internet connection, 2) The Google Apps Script URL is correct, 3) The script is deployed as "Web App" with "Anyone" access';
                    } else if (error.message.includes('404')) {
                        userMessage = 'Script URL not found. Please check your Google Apps Script deployment URL';
                    } else if (error.message.includes('403')) {
                        userMessage = 'Access denied. Please ensure your Google Apps Script is deployed with "Anyone" access';
                    }
                    
                    showAlert('Error testing connection: ' + userMessage, 'error');
                    updateDatabaseStatus('Connection error: ' + userMessage);
                    
                    // Disable cloud mode
                    isCloudMode = false;
                    localStorage.setItem('asantemanCloudMode', 'false');
                    updateModeIndicator();
                });
        }

        function manualConnectionTest() {
            if (!SHEET_ID || !SCRIPT_URL) {
                alert('Please set Sheet ID and Script URL first');
                return;
            }
            
            const testUrl = `${SCRIPT_URL}?action=test&sheetId=${SHEET_ID}`;
            const message = `Testing URL: ${testUrl}\n\nPlease check:\n1. Google Apps Script is deployed as "Web App"\n2. Execute as: "Me"\n3. Who has access: "Anyone"\n4. Google Sheet is shared with "Anyone with link can view"`;
            
            alert(message);
            
            fetch(testUrl)
                .then(response => {
                    alert('Response status: ' + response.status);
                    return response.json();
                })
                .then(data => {
                    alert('Response data: ' + JSON.stringify(data));
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                });
        }

        function loadDataFromCloud() {
            if (!SHEET_ID || !SCRIPT_URL) {
                showAlert('Please configure your Google Sheet settings first', 'error');
                updateDatabaseStatus('Please configure your Google Sheet settings first');
                return;
            }
            
            // Validate credentials first
            if (!isValidSheetId(SHEET_ID) || !isValidScriptUrl(SCRIPT_URL)) {
                showAlert('Invalid Sheet ID or Script URL. Please check your settings.', 'error');
                return;
            }
            
            updateSyncStatus('syncing', 'Syncing from cloud to device...');
            
            // Test connection first
            testGoogleAppsScriptConnection()
                .then(success => {
                    if (success) {
                        // Simulate actual data loading (replace this with real implementation)
                        return simulateDataLoadingFromCloud();
                    } else {
                        throw new Error('Cannot connect to Google Sheet');
                    }
                })
                .then(data => {
                    updateSyncStatus('success', 'Data synced from cloud');
                    updateDatabaseStatus(`Synced ${members.length} members, ${attendance.length} attendance records from cloud`);
                    showAlert(`Data synced successfully from cloud: ${members.length} members`, 'success');
                    
                    // Enable cloud mode
                    isCloudMode = true;
                    localStorage.setItem('asantemanCloudMode', 'true');
                    updateModeIndicator();
                })
                .catch(error => {
                    console.error('Error loading data from cloud:', error);
                    updateSyncStatus('error', 'Sync failed');
                    showAlert('Failed to load data from cloud: ' + error.message, 'error');
                    updateDatabaseStatus('Failed to sync data from cloud.');
                    
                    // Disable cloud mode
                    isCloudMode = false;
                    localStorage.setItem('asantemanCloudMode', 'false');
                    updateModeIndicator();
                });
        }

        function simulateDataLoadingFromCloud() {
            return new Promise((resolve, reject) => {
                // Simulate network delay
                setTimeout(() => {
                    // In a real implementation, you would fetch actual data from Google Sheets
                    // For now, we'll just resolve successfully
                    resolve({
                        members: [],
                        attendance: []
                    });
                }, 2000);
            });
        }

        function syncDataToCloud() {
            if (!SHEET_ID || !SCRIPT_URL) {
                showAlert('Please configure your Google Sheet settings first', 'error');
                return;
            }
            
            // Validate credentials first
            if (!isValidSheetId(SHEET_ID) || !isValidScriptUrl(SCRIPT_URL)) {
                showAlert('Invalid Sheet ID or Script URL. Please check your settings.', 'error');
                return;
            }
            
            updateSyncStatus('syncing', 'Syncing data to cloud...');
            
            // Test connection first
            testGoogleAppsScriptConnection()
                .then(success => {
                    if (success) {
                        // Simulate actual data syncing (replace this with real implementation)
                        return simulateDataSyncToCloud();
                    } else {
                        throw new Error('Cannot connect to Google Sheet');
                    }
                })
                .then(() => {
                    updateSyncStatus('success', 'Data synced to cloud');
                    showAlert(`Data synced successfully to cloud: ${members.length} members, ${attendance.length} attendance records`, 'success');
                    
                    // Enable cloud mode
                    isCloudMode = true;
                    localStorage.setItem('asantemanCloudMode', 'true');
                    updateModeIndicator();
                })
                .catch(error => {
                    console.error('Error syncing data to cloud:', error);
                    updateSyncStatus('error', 'Sync failed');
                    showAlert('Failed to sync data to cloud: ' + error.message, 'error');
                    
                    // Disable cloud mode
                    isCloudMode = false;
                    localStorage.setItem('asantemanCloudMode', 'false');
                    updateModeIndicator();
                });
        }

        function simulateDataSyncToCloud() {
            return new Promise((resolve, reject) => {
                // Simulate network delay and potential errors
                setTimeout(() => {
                    // Simulate random failures for testing
                    const shouldFail = Math.random() < 0.3; // 30% chance of failure for testing
                    if (shouldFail) {
                        reject(new Error('Simulated network error during sync'));
                    } else {
                        resolve();
                    }
                }, 2000);
            });
        }

        function compareAndSyncSheetStructure() {
            if (!SHEET_ID || !SCRIPT_URL) {
                showAlert('Please configure your Google Sheet settings first', 'error');
                return;
            }
            
            updateSyncStatus('syncing', 'Comparing and syncing sheet structure...');
            
            // This should actually test the connection first
            testGoogleAppsScriptConnection()
                .then(success => {
                    if (success) {
                        // If connection is successful, then initialize the sheet
                        const initUrl = `${SCRIPT_URL}?action=initSheet&sheetId=${encodeURIComponent(SHEET_ID)}`;
                        
                        return fetch(initUrl, {
                            method: 'GET',
                            signal: AbortSignal.timeout(15000)
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                updateSyncStatus('success', 'Sheet structure synced successfully');
                                showAlert('Sheet structure initialized successfully!', 'success');
                                updateDatabaseStatus('Sheet structure is synchronized with application data model');
                                
                                // Enable cloud mode only if connection is actually working
                                isCloudMode = true;
                                localStorage.setItem('asantemanCloudMode', 'true');
                                updateModeIndicator();
                            } else {
                                throw new Error(data.error || 'Failed to initialize sheet structure');
                            }
                        });
                    } else {
                        throw new Error('Cannot connect to Google Sheet');
                    }
                })
                .catch(error => {
                    console.error('Sheet structure sync error:', error);
                    updateSyncStatus('error', 'Sync failed');
                    showAlert('Failed to sync sheet structure: ' + error.message, 'error');
                    updateDatabaseStatus('Failed to sync sheet structure.');
                    
                    // Disable cloud mode
                    isCloudMode = false;
                    localStorage.setItem('asantemanCloudMode', 'false');
                    updateModeIndicator();
                });
        }

        function saveMemberToCloud(member) {
            if (!isCloudMode || !SHEET_ID || !SCRIPT_URL) return;
            
            // In a real implementation, you would send data to Google Apps Script
            // For now, we'll simulate this with a console log
            console.log('Saving member to cloud:', member.name);
        }

        function saveAttendanceToCloud(attendanceRecord) {
            if (!isCloudMode || !SHEET_ID || !SCRIPT_URL) return;
            
            // In a real implementation, you would send data to Google Apps Script
            // For now, we'll simulate this with a console log
            console.log('Saving attendance to cloud:', attendanceRecord.memberName);
        }

        function deleteMemberFromCloud(memberId) {
            if (!isCloudMode || !SHEET_ID || !SCRIPT_URL) return;
            
            // In a real implementation, you would send delete request to Google Apps Script
            console.log('Deleting member from cloud:', memberId);
        }

        function saveAllToLocalStorage() {
            localStorage.setItem('asantemanMembers', JSON.stringify(members));
            localStorage.setItem('asantemanAttendance', JSON.stringify(attendance));
            localStorage.setItem('asantemanJobs', JSON.stringify(availableJobs));
            localStorage.setItem('asantemanHometowns', JSON.stringify(availableHometowns));
            localStorage.setItem('asantemanTribes', JSON.stringify(availableTribes));
            localStorage.setItem('asantemanDepartments', JSON.stringify(availableDepartments));
            localStorage.setItem('asantemanPositions', JSON.stringify(availablePositions));
            localStorage.setItem('asantemanChapters', JSON.stringify(availableChapters));
            localStorage.setItem('asantemanGroups', JSON.stringify(availableGroups));
            localStorage.setItem('asantemanLastSync', Date.now().toString());
        }

        function saveMeetingsToLocalStorage() {
            localStorage.setItem('asantemanMeetings', JSON.stringify(meetings));
        }

        function saveOptionsToLocalStorage() {
            localStorage.setItem('asantemanJobs', JSON.stringify(availableJobs));
            localStorage.setItem('asantemanHometowns', JSON.stringify(availableHometowns));
            localStorage.setItem('asantemanTribes', JSON.stringify(availableTribes));
            localStorage.setItem('asantemanDepartments', JSON.stringify(availableDepartments));
            localStorage.setItem('asantemanPositions', JSON.stringify(availablePositions));
            localStorage.setItem('asantemanChapters', JSON.stringify(availableChapters));
            localStorage.setItem('asantemanGroups', JSON.stringify(availableGroups));
        }

        function loadDataFromLocalStorage() {
            const savedMembers = localStorage.getItem('asantemanMembers');
            if (savedMembers) {
                members = JSON.parse(savedMembers);
            }
            
            const savedAttendance = localStorage.getItem('asantemanAttendance');
            if (savedAttendance) {
                attendance = JSON.parse(savedAttendance);
            }
            
            const savedMeetings = localStorage.getItem('asantemanMeetings');
            if (savedMeetings) {
                meetings = JSON.parse(savedMeetings);
            }
            
            const savedJobs = localStorage.getItem('asantemanJobs');
            if (savedJobs) {
                availableJobs = JSON.parse(savedJobs);
            }
            
            const savedHometowns = localStorage.getItem('asantemanHometowns');
            if (savedHometowns) {
                availableHometowns = JSON.parse(savedHometowns);
            }
            
            const savedTribes = localStorage.getItem('asantemanTribes');
            if (savedTribes) {
                availableTribes = JSON.parse(savedTribes);
            }
            
            const savedDepartments = localStorage.getItem('asantemanDepartments');
            if (savedDepartments) {
                availableDepartments = JSON.parse(savedDepartments);
            }
            
            const savedPositions = localStorage.getItem('asantemanPositions');
            if (savedPositions) {
                availablePositions = JSON.parse(savedPositions);
            }
            
            const savedChapters = localStorage.getItem('asantemanChapters');
            if (savedChapters) {
                availableChapters = JSON.parse(savedChapters);
            }
            
            const savedGroups = localStorage.getItem('asantemanGroups');
            if (savedGroups) {
                availableGroups = JSON.parse(savedGroups);
            }
            
            const savedCloudMode = localStorage.getItem('asantemanCloudMode');
            if (savedCloudMode) {
                isCloudMode = savedCloudMode === 'true';
            }
            
            updateDropdowns();
            updateUI();
            updateModeIndicator();
            
            updateDatabaseStatus(`Loaded ${members.length} members from local storage`);
        }

        function generateReport() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            
            if (!startDate || !endDate) {
                showAlert('Please select both start and end dates', 'error');
                return;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            const filteredAttendance = attendance.filter(record => {
                const recordDate = new Date(record.timestamp);
                return recordDate >= start && recordDate <= end;
            });
            
            const reportResults = document.getElementById('report-results');
            reportResults.innerHTML = `
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-label">Total Attendance</div>
                        <div class="stat-value">${filteredAttendance.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Unique Members</div>
                        <div class="stat-value">${[...new Set(filteredAttendance.map(r => r.memberId))].length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Date Range</div>
                        <div class="stat-value">${startDate} to ${endDate}</div>
                    </div>
                </div>
                <h4>Attendance Details</h4>
                <div class="attendance-list">
                    ${filteredAttendance.map(record => `
                        <div class="attendance-item">
                            <div class="user-info">
                                <div>${record.memberName}</div>
                                <div class="attendance-time">${new Date(record.timestamp).toLocaleDateString()} ${record.verificationTime}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            showAlert('Report generated successfully', 'success');
        }

        function addNewUser() {
            const username = document.getElementById('new-username').value;
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-user-role').value;
            
            if (!username || !password) {
                showAlert('Please enter both username and password', 'error');
                return;
            }
            
            if (users.some(u => u.username === username)) {
                showAlert('Username already exists', 'error');
                return;
            }
            
            users.push({ username, password, role });
            
            document.getElementById('new-username').value = '';
            document.getElementById('new-password').value = '';
            
            showAlert(`User ${username} added successfully`, 'success');
            renderUsersList();
        }

        function renderUsersList() {
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = `
                <h4>Current Users</h4>
                <div class="attendance-list">
                    ${users.map(user => `
                        <div class="attendance-item">
                            <div class="user-info">
                                <div>
                                    <div><strong>${user.username}</strong></div>
                                    <div class="attendance-time">Role: ${user.role}</div>
                                </div>
                            </div>
                            <button class="btn btn-danger btn-sm delete-user-btn" data-username="${user.username}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.querySelectorAll('.delete-user-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const username = this.getAttribute('data-username');
                    if (username !== 'admin') {
                        showConfirmModal(`Are you sure you want to delete user ${username}?`, function() {
                            users = users.filter(u => u.username !== username);
                            renderUsersList();
                            showAlert(`User ${username} deleted`, 'success');
                        });
                    } else {
                        showAlert('Cannot delete admin user', 'error');
                    }
                });
            });
        }

        function updateDatabaseStatus(message) {
            databaseStatus.innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #17a2b8;">
                    <h4 style="margin-bottom: 10px; color: #17a2b8;">Database Status</h4>
                    <p style="margin: 0;">${message}</p>
                    ${SHEET_ID ? `<p style="margin: 5px 0 0 0; font-size: 0.9em;"><strong>Sheet ID:</strong> ${SHEET_ID}</p>` : ''}
                    ${SCRIPT_URL ? `<p style="margin: 0; font-size: 0.9em;"><strong>Script URL:</strong> ${SCRIPT_URL.substring(0, 50)}...</p>` : ''}
                    <p style="margin: 5px 0 0 0; font-size: 0.9em;"><strong>Mode:</strong> ${isCloudMode ? 'Cloud' : 'Local'}</p>
                </div>
            `;
        }

        function updateSyncStatus(type, message) {
            syncStatus.textContent = `Sync: ${message}`;
            syncStatus.className = 'sync-status';
            
            if (type === 'syncing') {
                syncStatus.classList.add('syncing');
            } else if (type === 'error') {
                syncStatus.classList.add('error');
            } else if (type === 'success') {
                setTimeout(() => {
                    syncStatus.style.display = 'none';
                }, 3000);
            }
            
            syncStatus.style.display = 'block';
        }

        function showAlert(message, type) {
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(alert, mainContent.firstChild);
            
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 5000);
        }

        // Initialize users list
        renderUsersList();

        // Debug function
        function debugConnection() {
            console.log('Current Settings:');
            console.log('Sheet ID:', SHEET_ID);
            console.log('Script URL:', SCRIPT_URL);
            console.log('Cloud Mode:', isCloudMode);
            
            if (SCRIPT_URL) {
                // Test the URL directly
                fetch(SCRIPT_URL)
                    .then(response => {
                        console.log('Direct URL test - Status:', response.status);
                        return response.text();
                    })
                    .then(text => {
                        console.log('Direct URL test - Response (first 200 chars):', text.substring(0, 200));
                    })
                    .catch(error => {
                        console.log('Direct URL test - Error:', error);
                    });
            }
        }

        // Call this function from browser console to debug
        window.debugConnection = debugConnection;
        window.manualConnectionTest = manualConnectionTest;
    </script>
</body>
</html>
